{% extends 'ui_test/base.html' %}
{% load static %}

{% block title %}Home{% endblock %}

{% block content %}
<div class="w-full flex justify-center p-3">
  <div
    class="bg-no-repeat bg-center bg-cover p-2 px-4 rounded-3xl h-[600px] w-[1350px] relative"
    style="background-image: url('{% static 'bookingapp/asset/bg_plane.svg' %}');"
  >
    <!-- logo -->
    <div class="w-full flex justify-end gap-5">
        <img src="{% static 'bookingapp/images/csucc.svg' %}" alt="" class="max-w-[30px]">
        <img src="{% static 'bookingapp/images/csu.svg' %}" alt="" class="max-w-[30px]">
        <img src="{% static 'bookingapp/images/cthm.svg' %}" alt="" class="max-w-[30px]">
        <img src="{% static 'bookingapp/images/ceit.svg' %}" alt="" class="max-w-[30px]">
    </div>

    <!-- home carousel -->
    <div class="w-full flex justify-between px-15 gap-20 mt-10">
      <!-- left -->
      <div class="flex-1">
        <div class="flex flex-col text-[#FFC83D] syncopate-bold">
          <div class="flex items-end gap-2">
            <div class="border-b-5 flex items-center">
              <p class="text-[80px] leading-none">Let's</p>
            </div>
            <p class="text-[48px]">plan</p>
          </div>
          <div class="flex gap-3">
            <p class="text-[48px]">your</p>
            <div class="border-b-5 flex items-center">
              <p class="text-[128px] leading-none">trip</p>
            </div>
          </div>
        </div>

        <div class="w-full backdrop-blur-xs rounded-lg p-3 poppins-light-italic text-white mt-3">
          <h1>-Lorem ipsum</h1>
          <p class="font-light">"Lorem ipsum dolor sit amet, consectetur adipiscing elit, sed do eiusmod tempor incididunt ut labore et dolore magna aliqua. Ut enim ad minim veniam, quis nostrud exercitation ullamco laboris nisi ut aliquip ex ea commodo consequat."</p>
        </div>
      </div>
      <!-- right -->
      <div class="flex-1 py-5 px-2">
        <div class="flex justify-between my-1 text-sm">
          <p class="text-[#FFC83D] font-medium">Popular wonder</p>
          <!-- date -->
          <p class="text-white" id="current-date"></p>
        </div>

        <div class="rounded-sm">
          <div>
            <img src="{% static 'bookingapp/asset/carousel.svg' %}" alt="" class="w-full">
          </div>
          <div class="w-full flex justify-center gap-2 mt-3">
            <p class="p-1 bg-[#FFC83D] rounded-full"></p>
            <p class="p-1 bg-white rounded-full"></p>
            <p class="p-1 bg-white rounded-full"></p>
            <p class="p-1 bg-white rounded-full"></p>
          </div>
        </div>
      </div>
    </div>

    <!-- search area -->
    <form method="post" action="{% url 'bookingapp:test_schedule' %}" class="w-full px-20 absolute -bottom-15" id="search-form">
      {% csrf_token %}
      <div class="space-y-5 border border-gray-400 rounded-[10px] bg-[#FFFCF5] px-10 py-4">
        <!-- top -->
        <div class="text-sm flex w-full justify-between">
          <!-- trip type -->
          <div class="flex gap-2">
            <button type="button" name="trip_type" value="one_way" class="trip-type-btn bg-[#093704] hover:cursor-pointer text-[#FFC83D] px-5 py-1.5 rounded-sm">One-Way</button>
            <button type="button" name="trip_type" value="round_trip" class="trip-type-btn bg-white border border-gray-400 hover:bg-gray-200 hover:cursor-pointer text-gray-600 px-5 py-1.5 rounded-sm">Round-trip</button>
            <button type="button" name="trip_type" value="multi_city" class="trip-type-btn bg-white border border-gray-400 hover:bg-gray-200 hover:cursor-pointer text-gray-600 px-5 py-1.5 rounded-sm">Multi-city</button>
            <input type="hidden" name="trip_type" id="trip_type" value="one_way">
          </div>
          <!-- passenger count -->
          <div class="flex gap-2 items-end">
            <p class="text-gray-400 font-semibold">Passenger:</p>
            <div class="p-1 flex gap-1 bg-[#093704] rounded-sm text-sm">
              <div class="passenger-selector bg-[#FFC83D] hover:bg-[#FFC83D]/80 cursor-pointer py-1 px-3 rounded-xs text-sm" data-type="adults">
                <span class="passenger-count">1</span> Adult
              </div>
              <div class="passenger-selector bg-[#FFC83D] hover:bg-[#FFC83D]/80 cursor-pointer py-1 px-3 rounded-xs text-sm" data-type="children">
                <span class="passenger-count">0</span> Children
              </div>
              <div class="passenger-selector bg-[#FFC83D] hover:bg-[#FFC83D]/80 cursor-pointer py-1 px-3 rounded-xs text-sm" data-type="infants">
                <span class="passenger-count">0</span> Infant/s
              </div>
            </div>
            <input type="hidden" name="adults" id="adults" value="1">
            <input type="hidden" name="children" id="children" value="0">
            <input type="hidden" name="infants" id="infants" value="0">
          </div>
        </div>

        <!-- search -->
        <div class="w-full flex gap-5 items-center">
          <!-- location -->
          <div class="flex-1 flex flex-col space-y-2">
            <label for="from_airport" class="text-gray-500">Location</label>
            <div class="flex gap-2">
              <!-- From Airport -->
              <div class="relative w-1/2">
                <div class="searchable-select">
                  <input type="text" 
                         id="from_airport_search" 
                         class="py-2 px-3 w-full border border-gray-500 placeholder-gray-800 bg-white rounded focus:outline-none focus:border-[#093704]" 
                         placeholder="From " 
                         autocomplete="off">
                  <input type="hidden" name="from_airport" id="from_airport" required>
                  <div id="from_airport_results" class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                    {% for airport in origins %}
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 airport-result hidden" 
                         data-id="{{ airport.id }}" 
                         data-name="{{ airport.name }} ({{ airport.code }}) - {{ airport.city }}, {{ airport.country }}">
                      <div class="font-medium">{{ airport.name }} ({{ airport.code }})</div>
                      <div class="text-sm text-gray-600">{{ airport.city }}, {{ airport.country }}</div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
              
              <!-- To Airport -->
              <div class="relative w-1/2">
                <div class="searchable-select">
                  <input type="text" 
                         id="to_airport_search" 
                         class="py-2 px-3 w-full border border-gray-500 placeholder-gray-800 bg-white rounded focus:outline-none focus:border-[#093704]" 
                         placeholder="To " 
                         autocomplete="off">
                  <input type="hidden" name="to_airport" id="to_airport" required>
                  <div id="to_airport_results" class="absolute z-50 w-full mt-1 bg-white border border-gray-300 rounded-md shadow-lg max-h-60 overflow-y-auto hidden">
                    {% for airport in destinations %}
                    <div class="p-3 hover:bg-gray-100 cursor-pointer border-b border-gray-200 airport-result hidden" 
                         data-id="{{ airport.id }}" 
                         data-name="{{ airport.name }} ({{ airport.code }}) - {{ airport.city }}, {{ airport.country }}">
                      <div class="font-medium">{{ airport.name }} ({{ airport.code }})</div>
                      <div class="text-sm text-gray-600">{{ airport.city }}, {{ airport.country }}</div>
                    </div>
                    {% endfor %}
                  </div>
                </div>
              </div>
            </div>
          </div>

          <div class="text-gray-500 flex items-center mt-5">
            <h1>&</h1>
          </div>

          <!-- Date -->
          <div class="flex-1 flex flex-col space-y-2">
            <label for="depart_date" class="text-gray-500">Date</label>
            <div class="flex">
              <input type="date" name="depart_date" id="depart_date" class="bg-white py-2 px-1 w-full border border-gray-500 placeholder-gray-800" required min="{{ today }}">
              <input type="date" name="return_date" id="return_date" class="bg-white py-2 px-1 w-full border border-gray-500 placeholder-gray-800" disabled>
            </div>
          </div>

          <div class="flex items-end">
            <button type="submit" class="py-3 px-10 font-medium bg-[#093704] hover:bg-[#093704]/80 cursor-pointer rounded-xs text-[#FFC83D]">Search</button>
          </div>
        </div>
      </div>
    </form>
  </div>
</div>

<!-- Passenger Modal -->
<div id="passenger-modal" class="fixed inset-0 bg-black/50 hidden  items-center justify-center z-50">
  <div class="bg-[#FFFCF5] rounded-sm p-6 py-10 w-[500px] ">
    <h3 class="text-lg font-semibold mb-4">Select Passengers</h3>
    
    <div class="space-y-4">
      <div class="flex justify-between items-center">
        <div>
          <p class="font-medium">Adults</p>
          <p class="text-sm text-gray-500">12 years and above</p>
        </div>
        <div class="flex items-center gap-3">
          <button type="button" class="passenger-minus w-8 h-8 rounded-full border border-gray-300" data-type="adults">-</button>
          <span id="adults-count" class="w-8 text-center">1</span>
          <button type="button" class="passenger-plus w-8 h-8 rounded-full border border-gray-300" data-type="adults">+</button>
        </div>
      </div>
      
      <div class="flex justify-between items-center">
        <div>
          <p class="font-medium">Children</p>
          <p class="text-sm text-gray-500">2-11 years</p>
        </div>
        <div class="flex items-center gap-3">
          <button type="button" class="passenger-minus w-8 h-8 rounded-full border border-gray-300" data-type="children">-</button>
          <span id="children-count" class="w-8 text-center">0</span>
          <button type="button" class="passenger-plus w-8 h-8 rounded-full border border-gray-300" data-type="children">+</button>
        </div>
      </div>
      
      <div class="flex justify-between items-center">
        <div>
          <p class="font-medium">Infants</p>
          <p class="text-sm text-gray-500">Under 2 years</p>
        </div>
        <div class="flex items-center gap-3">
          <button type="button" class="passenger-minus w-8 h-8 rounded-full border border-gray-300" data-type="infants">-</button>
          <span id="infants-count" class="w-8 text-center">0</span>
          <button type="button" class="passenger-plus w-8 h-8 rounded-full border border-gray-300" data-type="infants">+</button>
        </div>
      </div>
    </div>
    
    <div class="flex justify-end gap-3 mt-6">
      <button type="button" id="cancel-passenger" class="px-4 py-2 border bg-white hover:bg-gray-200 cursor-pointer border-gray-300 rounded-xs">Cancel</button>
      <button type="button" id="save-passenger" class="px-4 py-2 bg-[#093704] hover:bg-[#093704]/80 cursor-pointer text-white rounded-xs">Save</button>
    </div>
  </div>
</div>

<script>
// Search functionality for airport dropdowns
class AirportSearch {
  constructor(inputId, resultsId, hiddenInputId) {
    this.input = document.getElementById(inputId);
    this.results = document.getElementById(resultsId);
    this.hiddenInput = document.getElementById(hiddenInputId);
    this.allOptions = Array.from(this.results.querySelectorAll('.airport-result'));
    this.init();
  }

  init() {
    this.input.addEventListener('input', (e) => {
      this.filterResults(e.target.value);
    });

    this.input.addEventListener('focus', () => {
      if (this.input.value) {
        this.filterResults(this.input.value);
      } else {
        this.showAllResults();
      }
    });

    this.input.addEventListener('click', (e) => {
      e.stopPropagation();
      if (this.input.value) {
        this.filterResults(this.input.value);
      } else {
        this.showAllResults();
      }
    });

    document.addEventListener('click', (e) => {
      if (!this.input.contains(e.target) && !this.results.contains(e.target)) {
        this.hideResults();
      }
    });

    // Add click event listeners to all options
    this.allOptions.forEach(option => {
      option.addEventListener('click', () => {
        this.selectOption(option);
      });
    });
  }

  filterResults(query) {
    const searchTerm = query.toLowerCase().trim();
    
    if (searchTerm.length === 0) {
      this.hideResults();
      this.hiddenInput.value = '';
      return;
    }

    let hasVisibleResults = false;
    
    this.allOptions.forEach(option => {
      const text = option.dataset.name.toLowerCase();
      const airportCode = option.querySelector('.font-medium').textContent.toLowerCase();
      const location = option.querySelector('.text-sm').textContent.toLowerCase();
      
      if (text.includes(searchTerm) || airportCode.includes(searchTerm) || location.includes(searchTerm)) {
        option.classList.remove('hidden');
        hasVisibleResults = true;
      } else {
        option.classList.add('hidden');
      }
    });

    if (hasVisibleResults) {
      this.results.classList.remove('hidden');
    } else {
      this.results.classList.add('hidden');
    }
  }

  showAllResults() {
    this.allOptions.forEach(option => {
      option.classList.remove('hidden');
    });
    this.results.classList.remove('hidden');
  }

  hideResults() {
    this.results.classList.add('hidden');
  }

  selectOption(option) {
    this.input.value = option.dataset.name;
    this.hiddenInput.value = option.dataset.id;
    this.hideResults();
  }
}

document.addEventListener('DOMContentLoaded', function() {
  // Initialize airport searches
  const fromSearch = new AirportSearch('from_airport_search', 'from_airport_results', 'from_airport');
  const toSearch = new AirportSearch('to_airport_search', 'to_airport_results', 'to_airport');

  // Set current date
  const now = new Date();
  document.getElementById('current-date').textContent = now.toLocaleDateString();
  
  // Set today's date as min for date inputs
  const today = new Date().toISOString().split('T')[0];
  document.getElementById('depart_date').min = today;
  
  // Trip type handling
  const tripTypeBtns = document.querySelectorAll('.trip-type-btn');
  const tripTypeInput = document.getElementById('trip_type');
  const returnDateInput = document.getElementById('return_date');
  
  tripTypeBtns.forEach(btn => {
    btn.addEventListener('click', function() {
      // Update button styles
      tripTypeBtns.forEach(b => {
        b.classList.remove('bg-[#093704]', 'text-[#FFC83D]');
        b.classList.add('bg-white', 'border', 'border-gray-400', 'text-gray-600');
      });
      this.classList.remove('bg-white', 'border', 'border-gray-400', 'text-gray-600');
      this.classList.add('bg-[#093704]', 'text-[#FFC83D]');
      
      // Update hidden input
      tripTypeInput.value = this.value;
      
      // Handle return date
      if (this.value === 'round_trip') {
        returnDateInput.disabled = false;
        returnDateInput.required = true;
      } else {
        returnDateInput.disabled = true;
        returnDateInput.required = false;
        returnDateInput.value = '';
      }
    });
  });
  
  // Passenger modal handling
  const passengerSelectors = document.querySelectorAll('.passenger-selector');
  const passengerModal = document.getElementById('passenger-modal');
  const passengerCounts = {
    adults: 1,
    children: 0,
    infants: 0
  };
  
  passengerSelectors.forEach(selector => {
    selector.addEventListener('click', function() {
      passengerModal.classList.remove('hidden');
      passengerModal.classList.add('flex');
    });
  });
  
  // Passenger count buttons
  document.querySelectorAll('.passenger-plus').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.getAttribute('data-type');
      if (type === 'infants' && passengerCounts.infants >= passengerCounts.adults) {
        return; // Infants cannot exceed adults
      }
      passengerCounts[type]++;
      updatePassengerDisplay();
    });
  });
  
  document.querySelectorAll('.passenger-minus').forEach(btn => {
    btn.addEventListener('click', function() {
      const type = this.getAttribute('data-type');
      if (passengerCounts[type] > (type === 'adults' ? 1 : 0)) {
        passengerCounts[type]--;
        if (type === 'adults' && passengerCounts.infants > passengerCounts.adults) {
          passengerCounts.infants = passengerCounts.adults;
        }
        updatePassengerDisplay();
      }
    });
  });
  
  document.getElementById('cancel-passenger').addEventListener('click', function() {
    passengerModal.classList.add('hidden');
    passengerModal.classList.remove('flex');
  });
  
  document.getElementById('save-passenger').addEventListener('click', function() {
    updatePassengerInputs();
    updatePassengerSelectors();
    passengerModal.classList.add('hidden');
    passengerModal.classList.remove('flex');
  });
  
  function updatePassengerDisplay() {
    document.getElementById('adults-count').textContent = passengerCounts.adults;
    document.getElementById('children-count').textContent = passengerCounts.children;
    document.getElementById('infants-count').textContent = passengerCounts.infants;
  }
  
  function updatePassengerInputs() {
    document.getElementById('adults').value = passengerCounts.adults;
    document.getElementById('children').value = passengerCounts.children;
    document.getElementById('infants').value = passengerCounts.infants;
  }
  
  function updatePassengerSelectors() {
    document.querySelectorAll('.passenger-selector').forEach(selector => {
      const type = selector.getAttribute('data-type');
      const countSpan = selector.querySelector('.passenger-count');
      countSpan.textContent = passengerCounts[type];
      selector.innerHTML = `<span class="passenger-count">${passengerCounts[type]}</span> ${type.charAt(0).toUpperCase() + type.slice(1)}${passengerCounts[type] !== 1 ? (type === 'children' ? '' : 's') : ''}`;
    });
  }
  
  // Set minimum return date when depart date is selected
  document.getElementById('depart_date').addEventListener('change', function() {
    const departDate = this.value;
    document.getElementById('return_date').min = departDate;
    if (returnDateInput.value && returnDateInput.value < departDate) {
      returnDateInput.value = departDate;
    }
  });

  // Close dropdowns when clicking outside
  document.addEventListener('click', function(e) {
    if (!e.target.closest('.searchable-select')) {
      document.querySelectorAll('#from_airport_results, #to_airport_results').forEach(dropdown => {
        dropdown.classList.add('hidden');
      });
    }
  });
});
</script>

<style>
.searchable-select {
  position: relative;
}

#from_airport_results,
#to_airport_results {
  scrollbar-width: thin;
  scrollbar-color: #cbd5e0 #f7fafc;
}

#from_airport_results::-webkit-scrollbar,
#to_airport_results::-webkit-scrollbar {
  width: 6px;
}

#from_airport_results::-webkit-scrollbar-track,
#to_airport_results::-webkit-scrollbar-track {
  background: #f7fafc;
}

#from_airport_results::-webkit-scrollbar-thumb,
#to_airport_results::-webkit-scrollbar-thumb {
  background-color: #cbd5e0;
  border-radius: 3px;
}
</style>
{% endblock %}