{% extends 'booking/base.html' %}
{% load static %}

{% block title %}Add Extra Services - Flight Booking{% endblock %}

{% block content %}
<div class="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 py-8">
    <div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8">
        <!-- Header -->
        <div class="text-center mb-8">
            <div class="flex items-center justify-center mb-4">
                <div class="w-12 h-12 bg-blue-600 rounded-full flex items-center justify-center">
                    <svg class="w-6 h-6 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                    </svg>
                </div>
            </div>
            <h1 class="text-3xl font-bold text-gray-900 mb-2">Add Extra Services</h1>
            <p class="text-gray-600 text-lg">Enhance your flight experience with optional services</p>
        </div>

        <div class="bg-white rounded-2xl shadow-xl border border-gray-200 overflow-hidden">
            <!-- Flight Summary Header -->
            <div class="bg-gradient-to-r from-blue-600 to-indigo-700 px-6 py-4">
                <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center">
                    <div>
                        <h2 class="text-xl font-semibold text-white">Your Flight Details</h2>
                        <p class="text-blue-100">CEB → MNL • Economy • {{ passengers|length }} Passenger{{ passengers|length|pluralize }}</p>
                    </div>
                    <div class="mt-2 sm:mt-0">
                        <span class="text-2xl font-bold text-white">₱2,500</span>
                        <p class="text-blue-100 text-sm">Base fare</p>
                    </div>
                </div>
            </div>

            <form method="post" id="addons-form">
                {% csrf_token %}
                
                <div class="p-6">
                    <!-- Extra Baggage -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-blue-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M8 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0zM15 16.5a1.5 1.5 0 11-3 0 1.5 1.5 0 013 0z"/>
                                <path d="M3 4a1 1 0 00-1 1v10a1 1 0 001 1h1.05a2.5 2.5 0 014.9 0H10a1 1 0 001-1v-1h4a1 1 0 001-1v-1h2a1 1 0 001-1V5a1 1 0 00-1-1H3z"/>
                            </svg>
                            Extra Baggage
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for add_on in add_ons %}
                            {% if add_on.category == 'baggage' %}
                            <div class="addon-card border-2 border-gray-200 rounded-xl p-4 transition-all duration-300 hover:border-blue-500" data-price="{{ add_on.price }}">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900">{{ add_on.name }}</h4>
                                        <p class="text-gray-600 text-sm mt-1">{{ add_on.description }}</p>
                                    </div>
                                    <div class="text-right ml-4">
                                        <span class="text-lg font-bold text-blue-600">₱{{ add_on.price }}</span>
                                        <div class="mt-2">
                                            <select name="addon_{{ add_on.id }}" class="quantity-selector border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-blue-500 focus:border-blue-500">
                                                <option value="0">0</option>
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- In-Flight Meals -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-orange-600" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M2 10a8 8 0 018-8v8h8a8 8 0 11-16 0z"/>
                                <path d="M12 2.252A8.014 8.014 0 0117.748 8H12V2.252z"/>
                            </svg>
                            In-Flight Meals
                        </h3>
                        
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            {% for add_on in add_ons %}
                            {% if add_on.category == 'meal' %}
                            <div class="addon-card border-2 border-gray-200 rounded-xl p-4 transition-all duration-300 hover:border-orange-500" data-price="{{ add_on.price }}">
                                <div class="flex items-center justify-between">
                                    <div class="flex-1">
                                        <h4 class="font-semibold text-gray-900">{{ add_on.name }}</h4>
                                        <p class="text-gray-600 text-sm mt-1">{{ add_on.description }}</p>
                                    </div>
                                    <div class="text-right ml-4">
                                        <span class="text-lg font-bold text-orange-600">₱{{ add_on.price }}</span>
                                        <div class="mt-2">
                                            <select name="addon_{{ add_on.id }}" class="quantity-selector border rounded-lg px-3 py-2 text-sm focus:ring-2 focus:ring-orange-500 focus:border-orange-500">
                                                <option value="0">0</option>
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                            </select>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            {% endif %}
                            {% endfor %}
                        </div>
                    </div>

                    <!-- Wheelchair Services -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-purple-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zM7 9a1 1 0 100-2 1 1 0 000 2zm7-1a1 1 0 11-2 0 1 1 0 012 0zm-.464 5.535a1 1 0 10-1.415-1.414 3 3 0 01-4.242 0 1 1 0 00-1.415 1.414 5 5 0 007.072 0z" clip-rule="evenodd"/>
                            </svg>
                            Wheelchair Services
                        </h3>
                        
                        <div class="bg-purple-50 border-2 border-purple-200 rounded-xl p-6">
                            <div class="flex items-center justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900">Wheelchair Assistance</h4>
                                    <p class="text-gray-600 text-sm mt-1">Complimentary wheelchair service for passengers who need assistance at the airport</p>
                                    <div class="mt-2 flex items-center text-sm text-green-600">
                                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 20 20">
                                            <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                        </svg>
                                        Free service - Available at all airports
                                    </div>
                                </div>
                                <div class="ml-4">
                                    <label class="inline-flex items-center">
                                        <input type="checkbox" name="wheelchair_service" value="1" class="wheelchair-checkbox h-5 w-5 text-purple-600 focus:ring-purple-500 border-gray-300 rounded">
                                        <span class="ml-2 text-sm text-gray-900">Request wheelchair service</span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Travel Insurance -->
                    <div class="mb-8">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4 flex items-center">
                            <svg class="w-5 h-5 mr-2 text-red-600" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M2.166 4.999A11.954 11.954 0 0010 1.944 11.954 11.954 0 0017.834 5c.11.65.166 1.32.166 2.001 0 5.225-3.34 9.67-8 11.317C5.34 16.67 2 12.225 2 7c0-.682.057-1.35.166-2.001zm11.541 3.708a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"/>
                            </svg>
                            Travel Insurance
                        </h3>
                        
                        <div class="bg-red-50 border-2 border-red-200 rounded-xl p-6 transition-all duration-300" id="insurance-section">
                            <div class="flex flex-col lg:flex-row lg:items-center lg:justify-between">
                                <div class="flex-1">
                                    <h4 class="font-semibold text-gray-900 text-lg">Comprehensive Travel Insurance</h4>
                                    <p class="text-gray-600 text-sm mt-1 mb-3">Protect your trip with our comprehensive travel insurance coverage</p>
                                    
                                    <div class="grid grid-cols-1 md:grid-cols-2 gap-2 text-sm text-gray-700">
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-green-500 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                            Lost or damaged belongings
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-green-500 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                            Trip cancellation
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-green-500 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                            Medical emergencies
                                        </div>
                                        <div class="flex items-center">
                                            <svg class="w-4 h-4 text-green-500 mr-2 flex-shrink-0" fill="currentColor" viewBox="0 0 20 20">
                                                <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                            </svg>
                                            24/7 worldwide assistance
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mt-4 lg:mt-0 lg:ml-6 text-center">
                                    <div class="text-2xl font-bold text-red-600">₱350</div>
                                    <div class="text-sm text-gray-600 mb-3">per passenger</div>
                                    <button type="button" id="insurance-toggle" class="insurance-btn bg-red-600 hover:bg-red-700 text-white font-semibold py-3 px-8 rounded-xl transition-all duration-300 transform hover:scale-105">
                                        Add Travel Insurance
                                    </button>
                                    <input type="hidden" name="travel_insurance" value="0" id="insurance-input">
                                </div>
                            </div>
                            
                            <!-- Insurance Details (Shown when selected) -->
                            <div id="insurance-details" class="mt-4 p-4 bg-white rounded-lg border border-red-200 hidden">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <span class="font-semibold text-gray-900">Travel Insurance Added</span>
                                        <span class="text-sm text-gray-600 ml-2">Coverage for {{ passengers|length }} passenger{{ passengers|length|pluralize }}</span>
                                    </div>
                                    <div class="text-right">
                                        <span class="font-bold text-red-600">₱<span id="insurance-total">350</span></span>
                                        <button type="button" id="remove-insurance" class="ml-3 text-sm text-red-600 hover:text-red-700 font-medium">
                                            Remove
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Selected Services Summary -->
                    <div class="bg-gray-50 rounded-xl p-6 mb-6">
                        <h3 class="text-lg font-semibold text-gray-900 mb-4">Your Selected Services</h3>
                        <div id="selected-addons" class="space-y-2">
                            <p class="text-gray-500 text-sm">No services selected yet</p>
                        </div>
                    </div>

                    <!-- Price Summary -->
                    <div class="bg-blue-50 rounded-xl p-6 border border-blue-200">
                        <div class="flex justify-between items-center">
                            <div>
                                <h3 class="text-lg font-semibold text-gray-900">Total Amount</h3>
                                <p class="text-gray-600 text-sm">Including all selected services</p>
                            </div>
                            <div class="text-right">
                                <div class="text-2xl font-bold text-blue-600" id="total-price">₱2,500</div>
                                <div class="text-sm text-gray-500">
                                    Base: ₱2,500 • Add-ons: ₱<span id="addons-total">0</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="bg-gray-50 px-6 py-4 border-t border-gray-200">
                    <div class="flex flex-col sm:flex-row gap-4 justify-between items-center">
                        <div class="flex gap-4">
                            <button type="submit" 
                                    class="bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 px-8 rounded-xl transition-all duration-300 transform hover:scale-105 shadow-lg flex items-center">
                                <svg class="w-5 h-5 mr-2" fill="currentColor" viewBox="0 0 20 20">
                                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"/>
                                </svg>
                                Continue to Payment
                            </button>
                            <a href="{% url 'bookingapp:clear_add_ons' %}" 
                               class="bg-white border border-gray-300 hover:bg-gray-50 text-gray-700 font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center">
                                Clear All
                            </a>
                        </div>
                        <a href="{% url 'bookingapp:select_seat' %}" 
                           class="text-blue-600 hover:text-blue-700 font-semibold py-3 px-6 rounded-xl transition-all duration-300 flex items-center">
                            Skip Add-ons
                            <svg class="w-5 h-5 ml-2" fill="currentColor" viewBox="0 0 20 20">
                                <path fill-rule="evenodd" d="M10.293 5.293a1 1 0 011.414 0l4 4a1 1 0 010 1.414l-4 4a1 1 0 01-1.414-1.414L12.586 11H5a1 1 0 110-2h7.586l-2.293-2.293a1 1 0 010-1.414z" clip-rule="evenodd"/>
                            </svg>
                        </a>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const basePrice = 2500;
    const insurancePrice = 350;
    const passengerCount = {{ passengers|length }};
    let selectedAddons = new Map();
    let insuranceSelected = false;
    
    // Update price display
    function updatePriceDisplay() {
        let addonsTotal = 0;
        
        // Calculate add-ons total
        selectedAddons.forEach((quantity, addonData) => {
            addonsTotal += addonData.price * quantity;
        });
        
        // Add insurance if selected
        if (insuranceSelected) {
            addonsTotal += insurancePrice * passengerCount;
        }
        
        const totalPrice = basePrice + addonsTotal;
        
        // Update displays
        document.getElementById('addons-total').textContent = addonsTotal.toLocaleString();
        document.getElementById('total-price').textContent = `₱${totalPrice.toLocaleString()}`;
        document.getElementById('insurance-total').textContent = (insurancePrice * passengerCount).toLocaleString();
        
        // Update selected services list
        updateSelectedServicesList();
    }
    
    // Update selected services list
    function updateSelectedServicesList() {
        const container = document.getElementById('selected-addons');
        
        if (selectedAddons.size === 0 && !insuranceSelected) {
            container.innerHTML = '<p class="text-gray-500 text-sm">No services selected yet</p>';
            return;
        }
        
        let html = '';
        
        // Add regular add-ons
        selectedAddons.forEach((quantity, addonData) => {
            if (quantity > 0) {
                const total = addonData.price * quantity;
                html += `
                    <div class="flex justify-between items-center py-2 border-b border-gray-200">
                        <div>
                            <span class="font-medium text-gray-900">${addonData.name}</span>
                            <span class="text-gray-500 text-sm ml-2">×${quantity}</span>
                        </div>
                        <span class="font-semibold text-blue-600">₱${total.toLocaleString()}</span>
                    </div>
                `;
            }
        });
        
        // Add insurance if selected
        if (insuranceSelected) {
            const insuranceTotal = insurancePrice * passengerCount;
            html += `
                <div class="flex justify-between items-center py-2 border-b border-gray-200">
                    <div>
                        <span class="font-medium text-gray-900">Travel Insurance</span>
                        <span class="text-gray-500 text-sm ml-2">${passengerCount} passenger${passengerCount > 1 ? 's' : ''}</span>
                    </div>
                    <span class="font-semibold text-red-600">₱${insuranceTotal.toLocaleString()}</span>
                </div>
            `;
        }
        
        // Add wheelchair service if selected
        const wheelchairCheckbox = document.querySelector('.wheelchair-checkbox');
        if (wheelchairCheckbox && wheelchairCheckbox.checked) {
            html += `
                <div class="flex justify-between items-center py-2">
                    <div>
                        <span class="font-medium text-gray-900">Wheelchair Service</span>
                        <span class="text-gray-500 text-sm ml-2">Airport assistance</span>
                    </div>
                    <span class="font-semibold text-green-600">Complimentary</span>
                </div>
            `;
        }
        
        container.innerHTML = html;
    }
    
    // Handle quantity changes for add-ons
    document.querySelectorAll('.quantity-selector').forEach(select => {
        select.addEventListener('change', function() {
            const quantity = parseInt(this.value);
            const addonCard = this.closest('.addon-card');
            const price = parseFloat(addonCard.dataset.price);
            const addonName = addonCard.querySelector('h4').textContent;
            const addonId = this.name.replace('addon_', '');
            
            // Update selected addons map
            if (quantity > 0) {
                selectedAddons.set(addonId, {
                    name: addonName,
                    price: price,
                    quantity: quantity
                });
                addonCard.classList.add('border-blue-500', 'bg-blue-50');
            } else {
                selectedAddons.delete(addonId);
                addonCard.classList.remove('border-blue-500', 'bg-blue-50');
            }
            
            updatePriceDisplay();
        });
    });
    
    // Handle wheelchair service checkbox
    const wheelchairCheckbox = document.querySelector('.wheelchair-checkbox');
    if (wheelchairCheckbox) {
        wheelchairCheckbox.addEventListener('change', function() {
            updateSelectedServicesList();
        });
    }
    
    // Handle travel insurance toggle
    const insuranceToggle = document.getElementById('insurance-toggle');
    const insuranceInput = document.getElementById('insurance-input');
    const insuranceSection = document.getElementById('insurance-section');
    const insuranceDetails = document.getElementById('insurance-details');
    const removeInsurance = document.getElementById('remove-insurance');
    
    insuranceToggle.addEventListener('click', function() {
        insuranceSelected = true;
        insuranceInput.value = '1';
        insuranceSection.classList.add('border-red-400', 'bg-red-100');
        insuranceDetails.classList.remove('hidden');
        insuranceToggle.textContent = 'Insurance Added';
        insuranceToggle.classList.remove('bg-red-600', 'hover:bg-red-700');
        insuranceToggle.classList.add('bg-green-600', 'hover:bg-green-700');
        insuranceToggle.disabled = true;
        
        updatePriceDisplay();
    });
    
    removeInsurance.addEventListener('click', function() {
        insuranceSelected = false;
        insuranceInput.value = '0';
        insuranceSection.classList.remove('border-red-400', 'bg-red-100');
        insuranceDetails.classList.add('hidden');
        insuranceToggle.textContent = 'Add Travel Insurance';
        insuranceToggle.classList.remove('bg-green-600', 'hover:bg-green-700');
        insuranceToggle.classList.add('bg-red-600', 'hover:bg-red-700');
        insuranceToggle.disabled = false;
        
        updatePriceDisplay();
    });
    
    // Form submission
    document.getElementById('addons-form').addEventListener('submit', function(e) {
        // You can add any final validation here
        console.log('Submitting services:', {
            addons: Object.fromEntries(selectedAddons),
            insurance: insuranceSelected,
            wheelchair: wheelchairCheckbox ? wheelchairCheckbox.checked : false
        });
    });
});
</script>
{% endblock %}

{% block extra_css %}
<style>
.addon-card {
    transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.addon-card:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
}

.quantity-selector {
    background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
    background-position: right 0.5rem center;
    background-repeat: no-repeat;
    background-size: 1.5em 1.5em;
    padding-right: 2.5rem;
    -webkit-print-color-adjust: exact;
    print-color-adjust: exact;
}

.insurance-btn {
    transition: all 0.3s ease;
}

/* Smooth transitions */
button, a, select, .addon-card {
    transition: all 0.3s ease;
}
</style>
{% endblock %}