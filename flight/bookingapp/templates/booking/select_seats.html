{% extends 'ui_test/base.html' %}
{% block title %} Select a seat
{% endblock %}

{% block content %}
{% load static %}
    {% if error_message %}
        <div class="bg-red-100 text-red-700 p-4 rounded mb-4">
            {{ error_message }}
        </div>
    {% endif %}

    <main class=" mx-auto flex-1  flex justify-center w-full  max-w-[1500px] my-7 space-y-5 flex-col ">
        
        <!-- Context-aware messaging -->
        {% if from_addons %}
        <div class="bg-blue-50 border border-blue-200 rounded-lg p-4 mb-6 mx-auto max-w-[1100px]">
            <div class="flex items-center">
                <svg class="w-5 h-5 text-blue-600 mr-3 flex-shrink-0" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <div>
                    <h3 class="font-semibold text-blue-800">Seat Selection Add-on</h3>
                    <p class="text-blue-700 text-sm mt-1">
                        You're selecting seats as part of your add-ons. After seat selection, you'll proceed to the booking summary.
                    </p>
                </div>
            </div>
        </div>
        {% endif %}

        <div class="flex-1 mx-auto max-w-[1200px] px-8 bg-[#FFFCF5] flex  shadow-md/50  py-4 h-[82px]  w-5xl rounded-full justify-between items-center border border-gray-300">

            <!-- from -->
            <div class="flex items-center justify-center flex-1 gap-3  ">
                <div class=" flex-1 flex flex-col justify-center  ">
                    <p class="poppins-bold first-of-type: text-base leading-none ">{{ depart_schedule.flight.route.origin_airport.code }}</p>
                    <p class="text-[#828282] text-xs">{{ depart_schedule.flight.route.origin_airport.city }}</p>
                </div>
                <div class="border-2 h-0 w-10 border-[#093704]"></div>
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold   text-base leading-none ">{{ depart_schedule.flight.route.destination_airport.code }}</p>
                    <p class="text-[#828282] text-xs">{{ depart_schedule.flight.route.destination_airport.city }}</p>
                </div>
            </div>

            <!-- depart -->
            <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-base leading-none">{{ depart_schedule.departure_time|date:"d M Y" }}</p>
                    <p class="text-[#828282] text-xs">Depart</p>
                </div>

            </div>
            <!-- return -->
            <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-base leading-none ">
                        {% if return_schedule %}
                            {{ return_schedule.departure_time|date:"d M Y" }}
                        {% else %}
                            -
                        {% endif %}
                    </p>
                    <p class="text-[#828282] text-xs">Return</p>
                </div>
            </div>    
               

            <!-- passenger -->
           <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-base leading-none">
                        {% with adults=passengers|length %}
                            {{ adults }} Passenger{{ adults|pluralize }}
                        {% endwith %}
                    </p>
                    <p class="text-[#828282] text-xs">Passenger{{ passengers|length|pluralize }}</p>
                </div>
            </div>
            <div class="flex items-center leading-none  flex-1">
                <a href="{% url 'bookingapp:flight_schedules' %}" class="bg-[#093704] hover:bg-[#093704]/80 text-sm cursor-pointer py-2 px-10 rounded-full text-[#FFC83D] transition-colors">Edit search</a>
            </div>
        </div>


         <!-- stepbystep -->
       <div class="bg-[#FFC83D]  mx-auto h-[100px] w-[1100px] shadow-md/50 rounded-[20px] flex flex-col">
            <!-- arrow  -->
            <div class="flex justify-between items-center flex-1 mx-20">
                <div class="   rounded-full p-1 border border-[#093704]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bg-[#093704] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <path d="m17.54,3.64l-2.9,2.9-9.88-1.16c-.15-.02-.3.03-.41.14l-.59.59c-.24.24-.17.66.14.8l7.01,3.36-3.25,3.25-3.27-.65c-.16-.03-.33.02-.45.14l-.7.7c-.25.25-.17.67.16.81l4.27,1.83,1.83,4.27c.14.33.56.41.81.16l.7-.7c.12-.12.17-.29.14-.45l-.65-3.27,3.31-3.31,3.31,7.06c.15.31.56.39.81.14l.66-.66c.11-.11.16-.26.14-.41l-1.16-9.88,2.75-2.75c.7-.7.88-1.84.29-2.65-.74-1.03-2.19-1.12-3.05-.26Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

                <div class="   rounded-full p-1 border border-[#093704]">
                   <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bg-[#093704] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m19,2H5c-.55,0-1,.45-1,1v4h-2v2h2v2h-2v2h2v2h-2v2h2v4c0,.55.45,1,1,1h14c1.1,0,2-.9,2-2V4c0-1.1-.9-2-2-2Zm-6.5,5c1.43,0,2.5,1.07,2.5,2.5s-1.07,2.5-2.5,2.5-2.5-1.07-2.5-2.5,1.07-2.5,2.5-2.5Zm4.5,10h-9v-1c0-1.66,1.34-3,3-3h3c1.66,0,3,1.34,3,3v1Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

                <div class="   rounded-full p-1 border border-[#093704] bg-[#093704]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"   class="bg-[#FFC83D] p-1 rounded-full"
                        fill="#093704" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

                <div class="   rounded-full p-1 border border-[#093704]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bg-[#093704] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m4,5v4h2v-4h4v-2h-4c-1.1,0-2,.9-2,2Z"></path><path d="m6,15h-2v4c0,1.1.9,2,2,2h4v-2h-4v-4Z"></path><path d="m20,19h-4v2h4c1.1,0,2-.9,2-2v-4h-2v4Z"></path><path d="m16,3v2h4v4h2v-4c0-1.1-.9-2-2-2h-4Z"></path><path d="M8 15H18V17H8z"></path><path d="M18 7 8 7 8 11 3 11 3 13 8 13 18 13 23 13 23 11 18 11 18 7z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

                <div class="   rounded-full p-1 border border-[#093704]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bg-[#093704] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m21,7h-1v-3c0-.55-.45-1-1-1H5c-1.65,0-3,1.35-3,3v12c0,2.2,1.79,3,3,3h16c.55,0,1-.45,1-1v-12c0-.55-.45-1-1-1Zm-3,9h-2v-4h2v4ZM5,5h13v2H5c-.55,0-1-.45-1-1s.45-1,1-1Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

                <div class="   rounded-full p-1 border border-[#093704]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"   class="bg-[#093704] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10 10-4.49 10-10S17.51 2 12 2m-1.29 13.71c-.2.2-.45.29-.71.29s-.51-.1-.71-.29l-3-3L7.7 11.3l2.29 2.29 5.29-5.29 1.41 1.41-6 6Z"></path>
                    </svg>
                </div>

            </div>

            <!-- label  -->
            <div class="flex justify-between items-center px-15 pb-4 text-xs">
                <span class="font-medium">Flight Selection</span>
                <span class="font-medium">Passenger Info</span>
                <span class="font-medium">Add-ons</span>
                <span class="font-medium text-[#093704]">Seat Selection</span>
                <span class="font-medium">Payment</span>
                <span class="font-medium">Confirmation</span>
            </div>

        </div>

        <div class="flex w-full flex-1 flex-col mx-auto max-w-[1100px] mt-5 space-y-5">
            <div class="flex flex-1">
                <h1 class="text-2xl  font-bold flex gap-2 justify-center items-center">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="48" height="48"  
                        fill="#093704" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <rect x="4" y="4" width="16" height="7" rx="1" ry="1"></rect><path d="m21,13H3c-.55,0-1,.45-1,1v3c0,.55.45,1,1,1h1v4h2v-4h12v4h2v-4h1c.55,0,1-.45,1-1v-3c0-.55-.45-1-1-1Z"></path>
                    </svg>
                    Select your seats</h1>
            </div>

            <div class="flex  min-h-[1000px]  flex-col gap-10">
                <!-- instruction to seat -->
                <div class="flex-1 max-h-[140px] px-10 py-4 bg-white shadow-lg/20 mx-20 border-l-10 border-[#FFC83D]  ">
                    <h1 class="text-xl font-semibold flex  items-center gap-2">
                        <svg  xmlns="http://www.w3.org/2000/svg" width="38" height="38"  
                            fill="#FFC83D" viewBox="0 0 24 24" >
                            <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                            <path d="M12 22c5.51 0 10-4.49 10-10S17.51 2 12 2 2 6.49 2 12s4.49 10 10 10M11 7h2v6h-2zm0 8h2v2h-2z"></path>
                        </svg>
                        How to select seats ?
                    </h1>
                    <div class="flex flex-col mx-15 gap-2 ">
                        <ul class="list-disc text-xs">
                            <li>Select a passenger and choose a seat</li>
                            <li>A seat is included in your fare. You are not required to purchase a seat assignment to travel. If you decide to purchase a ticket and do not select a seat prior to purchase, a seat will be provided to you without additional charge when you travel.</li>
                        </ul>
                    </div>
                </div>

                <div>
                    
                    <div class="flex items-center gap-5">
                        <h1 class="text-2xl font-semibold">{{ depart_schedule.flight.route.origin_airport }}</h1>
                        <div class="w-5 h-1 bg-black"> </div>
                        <h1 class="text-2xl font-semibold">{{ depart_schedule.flight.route.destination_airport }}</h1>
                    </div>
                    <h4  class="text-sm text-gray-500">Select your departing seat</h4>
                </div>
               
                <div class="flex-1 flex gap-5 h-auto">
                    <div class="flex-1 bg-white shadow-md/50 max-w-[350px] flex-col py-5 flex items-center px-7 space-y-2">
                        <h1 class="text-xl font-semibold">Passenger</h1>
                        <div class="w-full border mx-15 border-gray-300"></div>
                        <!-- passenger name -->
                        {% for passenger in passengers %}
                        {% if passenger.passenger_type != "Infant" %}
                            <div class="passenger-item flex-1 w-full max-h-[80px] px-5 flex justify-center items-center gap-10
                                {% if forloop.first %} border-l-[#093704] border-l-10 bg-[#FFC83D] shadow-sm/50 {% else %}
                                border-l-10 border-l-gray-500 bg-gray-300 text-gray-700 cursor-pointer {% endif %}"
                                onclick="selectPassenger('{{ forloop.counter0 }}', 'depart')"
                                data-passenger-id="{{ forloop.counter0 }}"
                                data-trip="depart"
                                
                            >

                            <h1 class="text-4xl">{{ forloop.counter }}</h1>
                            <div class="flex w-full flex-col">
                                <p class="text-base">{{ passenger.first_name }} {{ passenger.mi }} {{ passenger.last_name }}</p>
                                <p class="seat-status text-[11px] {% if forloop.first %}text-[#093704]{% endif %}" 
                                    id="depart-status-{{ forloop.counter }}">
                                    Not selected
                                </p>
                            </div>
                            <p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="38" height="38"  
                                    fill="{% if forloop.first %}#093704{% else %}gray{% endif %}" viewBox="0 0 24 24" >
                                    <path d="M6 13h8.09l-3.3 3.29 1.42 1.42 5.7-5.71-5.7-5.71-1.42 1.42 3.3 3.29H6z"></path>
                                </svg>
                            </p>
                        </div>
                        {% endif %}
                        {% endfor %}

                    </div>

                    <!-- seats -->
                    <div class="flex-1 bg-[#093704] shadow-md/50 relative flex justify-center ">
                        <div class="flex-1 flex">
                            <div class=" w-full absolute z-10 top-1 right-1 ">
                                <div class=" mx-50 bg-white  h-[158px] shadow-lg/50 px-3 py-5">
                                    <h1 class="text-lg font-semibold">Seatmap Legend</h1>
                                    <div class="flex justify-around mt-6">
                                        <div  class="flex flex-col items-center">
                                            <div class="bg-[#093704] border w-8 h-8"></div>
                                            <p class="text-xs">Unavailable</p>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-white border w-8 h-8"></div>
                                            <p class="text-xs">Charge</p>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-[#FFC83D] border w-8 h-8"></div>
                                            <p class="text-xs">Selected</p>
                                        </div>
                                        
                                        
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 flex items-center">
                                <div class="w-full h-[100px] bg-[#FFC83D]">
                                    
                                </div>
                            </div>

                            <div class="w-[400px] h-auto bg-green-300 pt-[250px] pb-10">
                                <div class="mx-7  ">
                                    <h1 class="text-3xl syncopate-bold text-center">AirBus</h1>
                                    <p class="mt-5 text-center text-xl font-semibold">Front</p>

                                    {% comment %} seats  {% endcomment %}
                                    
                                    <div class="grid grid-cols-4 gap-5 mt-10 justify-items-center ">
                                        {% for seat in depart_seats %}
                                        <div class="w-10 h-10 flex items-center justify-center shadow-md/50 cursor-pointer
                                                {% if not seat.is_available %} bg-[#093704] text-white cursor-not-allowed
                                                {% elif seat.seat_number in selected_seats.values %} bg-[#FFC83D]
                                                {% else %} bg-white hover:bg-yellow-100 {% endif %}"
                                                data-seat="{{ seat.seat_number }}"
                                                {% if seat.is_available %} onclick="selectSeat('{{ seat.seat_number }}', this)" {% endif %}>
                                                {{ seat.seat_number }}
                                            </div>
                                        {% endfor %}
                                    
                                    </div>



                                </div>
                            </div>
                            <div class="flex-1 flex items-center">
                                <div class="w-full h-[100px] bg-[#FFC83D]">
                                        
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                {% if return_seats %}

                <div class="border border-gray-300 w-full">
                </div>
                <div id="return-text" class="hidden">
                     <div class="flex items-center gap-5">
                        <h1 class="text-2xl font-semibold">{{ return_schedule.flight.route.origin_airport }}</h1>
                        <p class="w-5 h-1 bg-black"> </p>
                        <h1 class="text-2xl font-semibold">{{ return_schedule.flight.route.destination_airport }}</h1>
                    </div>
                    <h1  class="text-sm text-gray-500">Select your returning seat</h1>
                </div>
                

                <div id="return-section" class="flex-1 flex gap-5 h-auto hidden">
                    <div class="flex-1 bg-white shadow-md/50 max-w-[350px] flex-col py-5 flex items-center px-7 space-y-2">
                        <h1 class="text-3xl font-bold">Passenger</h1>
                        <div class="w-full border mx-15 border-gray-300"></div>
                        <!-- passenger name -->
                        {% for passenger in passengers %}
                        {% if passenger.passenger_type != "Infant" %}
                            <div class="passenger-item flex-1 w-full max-h-[80px] px-5 flex justify-center items-center gap-10
                                {% if forloop.first %} border-l-[#093704] border-l-10 bg-[#FFC83D] shadow-sm/50 {% else %}
                                border-l-10 border-l-gray-500 bg-gray-300 text-gray-700 cursor-pointer {% endif %}"
                                onclick="selectPassenger('{{ forloop.counter0 }}', 'return')"
                                data-passenger-id="{{ forloop.counter0 }}"
                                data-trip="return"
                            >

                            <h1 class="text-4xl">{{ forloop.counter }}</h1>
                            <div class="flex w-full flex-col">
                                <p class="text-base">{{ passenger.first_name }} {{ passenger.mi }} {{ passenger.last_name }}</p>
                                <p class="seat-status text-[11px] {% if forloop.first %}text-[#093704]{% endif %}" 
                                    id="return-status-{{ forloop.counter0 }}">
                                    Not selected
                                </p>
                            </div>
                            <p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="38" height="38"  
                                    fill="{% if forloop.first %}#093704{% else %}gray{% endif %}" viewBox="0 0 24 24" >
                                    <path d="M6 13h8.09l-3.3 3.29 1.42 1.42 5.7-5.71-5.7-5.71-1.42 1.42 3.3 3.29H6z"></path>
                                </svg>
                            </p>
                        </div>
                        {% endif %}
                        {% endfor %}


                    </div>




                    <!-- return  seats -->
                    <div class="flex-1 bg-[#093704] shadow-md/50 relative flex justify-center ">
                        <div class="flex-1 flex">
                            <div class=" w-full absolute z-10 top-1 right-1 ">
                                <div class=" mx-50 bg-white  h-[158px] shadow-lg/50 px-3 py-5">
                                    <h1 class="text-lg font-semibold">Seatmap Legend</h1>
                                    <div class="flex justify-around mt-6">
                                        <div  class="flex flex-col items-center">
                                            <div class="bg-[#093704] border w-8 h-8"></div>
                                            <p class="text-xs">Unavailable</p>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-white border w-8 h-8"></div>
                                            <p class="text-xs">Charge</p>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-[#FFC83D] border w-8 h-8"></div>
                                            <p class="text-xs">Selected</p>
                                        </div>
                                        
                                        
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 flex items-center">
                                <div class="w-full h-[100px] bg-[#FFC83D]">
                                    
                                </div>
                            </div>

                            <div class="w-[400px] h-auto bg-green-300 pt-[250px] pb-10">
                                <div class="mx-7 ">
                                    <h1 class="text-3xl syncopate-bold text-center">AirBus</h1>
                                    <p class="mt-5 text-center text-xl font-semibold">Front</p>

                                    {% comment %} seats  {% endcomment %}
                                    <div class="grid grid-cols-4 gap-5 mt-10 justify-items-center">
                                        {% for seat in return_seats %}
                                        <div class="w-10 h-10 flex items-center justify-center shadow-md/50 cursor-pointer
                                                {% if not seat.is_available %} bg-[#093704] text-white cursor-not-allowed
                                                {% elif seat.seat_number in selected_seats.values %} bg-[#FFC83D]
                                                {% else %} bg-white hover:bg-yellow-100 {% endif %}"
                                                data-seat="{{ seat.seat_number }}"
                                                {% if seat.is_available %} 
                                                onclick="selectReturnSeat('{{ seat.seat_number }}', this)"  {% endif %}>
                                                {{ seat.seat_number }}
                                            </div>
                                        {% endfor %}
                                    </div>



                                </div>
                            </div>
                            <div class="flex-1 flex items-center">
                                <div class="w-full h-[100px] bg-[#FFC83D]">
                                        
                                </div>
                            </div>

                        </div>
                    </div>
                   
                </div>
                {% endif %}
                
                
                <!-- Updated Navigation Buttons -->
                <div class="flex justify-between items-center continue-button mt-8">
                    <div>
                        {% if from_addons %}
                        <a href="{% url 'bookingapp:add_ons' %}" 
                           class="bg-white hover:bg-gray-100 border border-gray-500 py-2 px-8 rounded-full shadow-md/50 cursor-pointer text-gray-700 transition-colors">
                            ‚Üê Back to Add-ons
                        </a>
                        {% else %}
                        <a href="{% url 'bookingapp:add_ons' %}" 
                           class="bg-white hover:bg-gray-100 border border-gray-500 py-2 px-8 rounded-full shadow-md/50 cursor-pointer text-gray-700 transition-colors">
                            ‚Üê Back to Add-ons
                        </a>
                        {% endif %}
                    </div>
                    
                    <div class="flex gap-4">
                        {% if not from_addons %}
                        <a href="{% url 'bookingapp:booking_summary' %}?skip_seats=true" 
                           class="bg-gray-500 hover:bg-gray-600 py-2 px-8 rounded-full shadow-md/50 cursor-pointer text-white transition-colors">
                            Skip Seats
                        </a>
                        {% endif %}
                        
                        <form action="{% url 'bookingapp:booking_summary' %}" method="POST">
                            {% csrf_token %}
                            <button type="submit" id="continueBtn"
                                    class="bg-[#FFC83D] hover:bg-[#FFC83D]/90 py-2 px-12 rounded-full shadow-md/50 cursor-pointer font-semibold text-[#093704] transition-colors">
                                {% if from_addons %}
                                Continue to Summary
                                {% else %}
                                Continue to Add-ons
                                {% endif %}
                            </button>
                        </form>
                    </div>
                </div>

            </div>

        </div>       

    </main>

<!-- Seat Confirmation Modal -->
<div id="seatModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-[350px]">
    <h2 class="text-lg font-bold mb-4">Confirm Seat</h2>
    <p id="seatModalMessage" class="mb-6 text-gray-700"></p>
    <div class="flex justify-end gap-3">
      <button id="cancelSeatBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400 transition-colors">Cancel</button>
      <button id="confirmSeatBtn" class="px-4 py-2 bg-[#093704] text-white rounded hover:bg-[#093704]/80 transition-colors">Yes</button>
    </div>
  </div>
</div>





<div class="bg-yellow-100 p-4 rounded mb-4 hidden" id="debugInfo">
    <h3 class="font-bold">Debug Info:</h3>
    <p>Active Passenger: <span id="debugActivePassenger">None</span></p>
    <p>Active Trip: <span id="debugActiveTrip">None</span></p>
</div>

<script>
const csrfToken = "{{ csrf_token }}";  // Django CSRF token
let activePassenger = null;
let activeTrip = "depart"; // default
let pendingSeat = null;
let pendingElement = null;
let pendingTrip = null;

// --------------------------
// Modal Handling
// --------------------------
function openSeatModal(seatNumber, element, trip) {
    pendingSeat = seatNumber;
    pendingElement = element;
    pendingTrip = trip;

    document.getElementById("seatModalMessage").textContent = 
        `You selected seat ${seatNumber}. Do you want to confirm?`;

    const modal = document.getElementById("seatModal");
    modal.classList.remove("hidden", "opacity-0");
    modal.classList.add("flex");
}

document.getElementById("cancelSeatBtn").addEventListener("click", function() {
    const modal = document.getElementById("seatModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
});

document.getElementById("confirmSeatBtn").addEventListener("click", function() {
    if (pendingSeat && pendingElement && pendingTrip) {
        confirmSeatSelection(pendingSeat, pendingElement, pendingTrip);
    }
    const modal = document.getElementById("seatModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
});

// --------------------------
// Seat Selection
// --------------------------
function selectSeat(seatNumber, element) {
    if (!activePassenger) {
        alert("‚ö† Please select a passenger first!");
        return;
    }
    openSeatModal(seatNumber, element, "depart");
}

function selectReturnSeat(seatNumber, element) {
    if (!activePassenger) {
        alert("‚ö† Please select a passenger first!");
        return;
    }
    openSeatModal(seatNumber, element, "return");
}

// --------------------------
// Confirm Seat Selection
// --------------------------
function confirmSeatSelection(seatNumber, element, trip) {

    console.log(`Sending to server - passenger: ${activePassenger}, seat: ${seatNumber}, trip: ${trip}`);



    fetch("{% url 'bookingapp:confirm_seat' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
            seat_number: seatNumber,
            passenger_id: activePassenger,
            trip: trip
        })
    })
    .then(res => res.json())
    .then(data => {
         console.log("Server response:", data);
        if (!data.success) {
            alert("‚ùå " + data.message);
            return;
        }

        updateSeatUI(activePassenger, seatNumber, element, trip);

        // Handle infants linked to this adult
        const infantEls = document.querySelectorAll(`.passenger-item[data-adult-id='${activePassenger}']`);
        infantEls.forEach(infantEl => {
            const infantId = infantEl.getAttribute("data-passenger-id");
            updateSeatUI(infantId, seatNumber, element, trip, true);
        });

        moveToNextPassenger(trip);
    });
}

// --------------------------
// Update Seat UI
// --------------------------
function updateSeatUI(passengerId, seatNumber, element, trip, isInfant = false) {
    const attr = trip === "depart" ? "data-seat-selected" : "data-return-seat-selected";

    // Clear old seat
    document.querySelectorAll(`[${attr}='${passengerId}']`).forEach(s => {
        s.classList.remove("bg-[#FFC83D]");
        s.classList.add("bg-white", "hover:bg-yellow-100");
        s.removeAttribute(attr);
    });

    // Highlight new seat
    element.classList.remove("bg-white", "hover:bg-yellow-100");
    element.classList.add("bg-[#FFC83D]");
    element.setAttribute(attr, passengerId);

    // Update passenger status
    const statusEl = document.getElementById(`${trip}-status-${passengerId}`);
    if (statusEl) {
        statusEl.textContent = isInfant ? "üë∂ Infant seat same as adult" : `‚úÖ Seat ${seatNumber} selected`;
        statusEl.classList.remove("text-gray-500", "text-yellow-600");
        statusEl.classList.add("text-green-600");
    }

    // Mark passenger as completed
    const currentEl = document.querySelector(`.passenger-item[data-passenger-id="${passengerId}"][data-trip="${trip}"]`);
    if (currentEl) {
        currentEl.classList.add("bg-green-400", "text-white");
    }
}

// --------------------------
// Move to next passenger
// --------------------------
function moveToNextPassenger(trip) {
    const passengerEls = document.querySelectorAll(`.passenger-item[data-trip="${trip}"]`);
    const currentEl = document.querySelector(`.passenger-item[data-passenger-id="${activePassenger}"][data-trip="${trip}"]`);
    const currentIndex = Array.from(passengerEls).indexOf(currentEl);

    if (currentIndex + 1 < passengerEls.length) {
        setActivePassenger(currentIndex + 1, trip);
    } else if (trip === "depart") {
        // Switch to return trip if exists
        const returnEls = document.querySelectorAll(`.passenger-item[data-trip="return"]`);
        if (returnEls.length > 0) {
            setActivePassenger(0, "return");
            document.getElementById("return-section").classList.remove("hidden");
            document.getElementById("return-section").scrollIntoView({ behavior: "smooth" });
        } else {
            document.getElementById("continueBtn").disabled = false;
        }
    } else if (trip === "return") {
        checkAllSeatsSelected();
    }
}

// --------------------------
// Passenger Selection & Highlighting
// --------------------------
function selectPassenger(passengerId, trip = "depart") {
    activePassenger = passengerId;
    activeTrip = trip;
    highlightPassenger(passengerId, trip);

    // DEBUG: Log which passenger is selected
    console.log(`Selected passenger: ${passengerId} for ${trip} trip`);
}

function highlightPassenger(passengerId, trip) {
    document.querySelectorAll(`.passenger-item[data-trip="${trip}"]`).forEach(p => {
        const pid = p.getAttribute("data-passenger-id");
        const statusEl = document.getElementById(`${trip}-status-${pid}`);

        if (pid === passengerId) {
            p.classList.remove("bg-gray-300", "text-gray-700", "bg-green-400", "text-white");
            p.classList.add("bg-[#FFC83D]", "shadow-sm/50");
            if (statusEl && !statusEl.textContent.includes("‚úÖ")) {
                statusEl.textContent = " Selecting seat...";
                statusEl.classList.remove("text-green-600", "text-gray-500");
                statusEl.classList.add("text-yellow-600");
            }
        } else if (p.classList.contains("bg-green-400")) {
            // keep completed green
        } else {
            p.classList.remove("bg-[#FFC83D]", "shadow-sm/50");
            p.classList.add("bg-gray-300", "text-gray-700");
            if (statusEl && !statusEl.textContent.includes("‚úÖ")) {
                statusEl.textContent = "‚è≥ Waiting...";
                statusEl.classList.remove("text-green-600", "text-yellow-600");
                statusEl.classList.add("text-gray-500");
            }
        }
    });
}

function setActivePassenger(index, trip) {
    const passengerEls = document.querySelectorAll(`.passenger-item[data-trip="${trip}"]`);
    if (index >= 0 && index < passengerEls.length) {
        const nextPassenger = passengerEls[index];
        const passengerId = nextPassenger.getAttribute("data-passenger-id");

        activePassenger = passengerId;
        activeTrip = trip;

        highlightPassenger(passengerId, trip);
        nextPassenger.scrollIntoView({ behavior: "smooth", block: "center" });
    }
}

// --------------------------
// Check if all seats are selected
// --------------------------
function checkAllSeatsSelected() {
    const passengers = document.querySelectorAll("[data-passenger-id]");
    let allDepartSelected = true;
    let allReturnSelected = true;

    passengers.forEach(p => {
        const pid = p.getAttribute("data-passenger-id");
        if (!document.querySelector(`[data-seat-selected='${pid}']`)) allDepartSelected = false;
        if (document.querySelector("#return-section") && !document.querySelector(`[data-return-seat-selected='${pid}']`)) allReturnSelected = false;
    });

    if (allDepartSelected && document.querySelector("#return-section")) {
        document.getElementById("return-section").classList.remove("hidden");
        document.getElementById("return-text").classList.remove("hidden");
    }

    document.getElementById("continueBtn").disabled = !(allDepartSelected && allReturnSelected);
}

// --------------------------
// Initialize on page load
// --------------------------
document.addEventListener("DOMContentLoaded", function () {

    // Show debug info
    document.getElementById('debugInfo').classList.remove('hidden');
    
    // Update debug info when passenger is selected
    const originalSelectPassenger = selectPassenger;
    selectPassenger = function(passengerId, trip) {
        document.getElementById('debugActivePassenger').textContent = passengerId;
        document.getElementById('debugActiveTrip').textContent = trip;
        originalSelectPassenger(passengerId, trip);
    };

    // Handle context from add-ons
    const fromAddons = {{ from_addons|yesno:"true,false" }};
    if (fromAddons) {
        console.log("Seat selection accessed from add-ons page");
        // You can add specific logic for add-ons context here
    }

    // Auto-select first passenger
    const firstPassenger = document.querySelector(".passenger-item[data-trip='depart']");
    if (firstPassenger) {
        activePassenger = firstPassenger.getAttribute("data-passenger-id");
        highlightPassenger(activePassenger, "depart");
    }

    // Pre-fill seats from session
    const sessionSeats = {{ selected_seats|safe }};
    Object.keys(sessionSeats).forEach(passengerId => {
        const seatInfo = sessionSeats[passengerId];
        ["depart", "return"].forEach(trip => {
            if (seatInfo[trip]) {
                const seatDiv = document.querySelector(`[data-seat='${seatInfo[trip]}']`);
                if (seatDiv) {
                    seatDiv.classList.add("bg-[#FFC83D]");
                    const attr = trip === "depart" ? "data-seat-selected" : "data-return-seat-selected";
                    seatDiv.setAttribute(attr, passengerId);
                }
            }
        });

        // Handle infants
        const infantEl = document.querySelector(`.passenger-item[data-passenger-id='${passengerId}']`);
        if (infantEl && infantEl.dataset.adultId) {
            const adultSeat = sessionSeats[infantEl.dataset.adultId]?.depart;
            if (adultSeat) {
                const seatDiv = document.querySelector(`[data-seat='${adultSeat}']`);
                if (seatDiv) {
                    seatDiv.classList.add("bg-[#FFC83D]");
                    seatDiv.setAttribute("data-seat-selected", passengerId);
                }
            }
        }
    });

    checkAllSeatsSelected();
});
</script>




{% endblock %}