{% extends 'booking/base.html' %}
{% block title %} Select a seat
{% endblock %}

{% block content %}
{% load static %}
    {% if error_message %}
        <div class="bg-red-100 text-red-700 p-4 rounded mb-4">
            {{ error_message }}
        </div>
    {% endif %}

    <main class=" mx-auto flex-1  flex justify-center w-full  max-w-[1500px] my-7 space-y-5 flex-col ">
        <!-- edit search  -->
        <div class="flex-1 mx-auto max-w-[1363px] px-30 bg-[#ECEAEA] flex  shadow-md/50 gap-5 py-10 max-h-[82px] w-full rounded-full justify-between items-center">

            <!-- from -->
            <div class="flex items-center leading-none justify-between flex-1 ">
                <div class="  flex flex-col justify-center  ">
                    <p class="poppins-bold text-2xl ">MNL</p>
                    <p class="text-[#828282]">Manila</p>
                </div>
                <div class="border-2 h-0 w-10"></div>
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-2xl ">BXU</p>
                    <p class="text-[#828282]">Butuan City</p>
                </div>
            </div>

            <!-- depart -->
            <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-2xl ">15 May 2025</p>
                    <p class="text-[#828282]">Depart</p>
                </div>

            </div>
            <!-- return -->
            <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-2xl ">30 May 2025</p>
                    <p class="text-[#828282]">Return</p>
                </div>
            </div>    
               

            <!-- passenger -->
           <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-2xl ">1 Adult</p>
                    <p class="text-[#828282]">Passenger</p>
                </div>
            </div>
            <div class="flex items-center leading-none  flex-1">
                <button class="bg-[#2975F7] hover:bg-[#2975F7]/80 cursor-pointer py-3 w-full rounded-full text-white">Edit search</button>
            </div>
        </div>


        <!-- stepbystep -->
        <div class="bg-[#F4EB08]  mx-auto h-[188px] w-[1400px] shadow-md/50 rounded-[20px] flex flex-col">
            <!-- arrow  -->
            <div class="flex justify-between items-center flex-1 mx-20">
                <div class="   rounded-full p-1 border-2 border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="38" height="38"  class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <path d="m17.54,3.64l-2.9,2.9-9.88-1.16c-.15-.02-.3.03-.41.14l-.59.59c-.24.24-.17.66.14.8l7.01,3.36-3.25,3.25-3.27-.65c-.16-.03-.33.02-.45.14l-.7.7c-.25.25-.17.67.16.81l4.27,1.83,1.83,4.27c.14.33.56.41.81.16l.7-.7c.12-.12.17-.29.14-.45l-.65-3.27,3.31-3.31,3.31,7.06c.15.31.56.39.81.14l.66-.66c.11-.11.16-.26.14-.41l-1.16-9.88,2.75-2.75c.7-.7.88-1.84.29-2.65-.74-1.03-2.19-1.12-3.05-.26Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-1 border-dashed text-white"></div>

                <div class="   rounded-full p-1 border-2 border-[#2975F7]">
                   <svg  xmlns="http://www.w3.org/2000/svg" width="38" height="38"  class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m19,2H5c-.55,0-1,.45-1,1v4h-2v2h2v2h-2v2h2v2h-2v2h2v4c0,.55.45,1,1,1h14c1.1,0,2-.9,2-2V4c0-1.1-.9-2-2-2Zm-6.5,5c1.43,0,2.5,1.07,2.5,2.5s-1.07,2.5-2.5,2.5-2.5-1.07-2.5-2.5,1.07-2.5,2.5-2.5Zm4.5,10h-9v-1c0-1.66,1.34-3,3-3h3c1.66,0,3,1.34,3,3v1Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-1 border-dashed text-white"></div>

                <div class="   rounded-full p-1 border-2 border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="38" height="38"   class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-1 border-dashed text-white"></div>

                <div class="   rounded-full p-1 border-2 border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="38" height="38"  class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m4,5v4h2v-4h4v-2h-4c-1.1,0-2,.9-2,2Z"></path><path d="m6,15h-2v4c0,1.1.9,2,2,2h4v-2h-4v-4Z"></path><path d="m20,19h-4v2h4c1.1,0,2-.9,2-2v-4h-2v4Z"></path><path d="m16,3v2h4v4h2v-4c0-1.1-.9-2-2-2h-4Z"></path><path d="M8 15H18V17H8z"></path><path d="M18 7 8 7 8 11 3 11 3 13 8 13 18 13 23 13 23 11 18 11 18 7z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-1 border-dashed text-white"></div>

                <div class="   rounded-full p-1 border-2 border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="38" height="38"  class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m21,7h-1v-3c0-.55-.45-1-1-1H5c-1.65,0-3,1.35-3,3v12c0,2.2,1.79,3,3,3h16c.55,0,1-.45,1-1v-12c0-.55-.45-1-1-1Zm-3,9h-2v-4h2v4ZM5,5h13v2H5c-.55,0-1-.45-1-1s.45-1,1-1Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border-1 border-dashed text-white"></div>

                <div class="   rounded-full p-1 border-2 border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="38" height="38"   class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10 10-4.49 10-10S17.51 2 12 2m-1.29 13.71c-.2.2-.45.29-.71.29s-.51-.1-.71-.29l-3-3L7.7 11.3l2.29 2.29 5.29-5.29 1.41 1.41-6 6Z"></path>
                    </svg>
                </div>

            </div>

            <!-- label  -->
             <div></div>

        </div>

        <div class="flex w-full flex-1 flex-col mx-auto max-w-[1363px] mt-5 space-y-5">
            <div class="flex flex-1">
                <h1 class="text-3xl  font-bold flex gap-2 justify-center items-center">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="48" height="48"  
                        fill="#NaNNaNNaN" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <rect x="4" y="4" width="16" height="7" rx="1" ry="1"></rect><path d="m21,13H3c-.55,0-1,.45-1,1v3c0,.55.45,1,1,1h1v4h2v-4h12v4h2v-4h1c.55,0,1-.45,1-1v-3c0-.55-.45-1-1-1Z"></path>
                    </svg>
                    Select your seats</h1>
            </div>

            <div class="flex  min-h-[1000px]  flex-col gap-10">
                <!-- instruction to seat -->
                <div class="flex-1 max-h-[140px] px-10 py-4 bg-white shadow-lg/20 mx-20 border-l-10 border-orange-400  ">
                    <h1 class="text-2xl font-semibold flex  items-center gap-2">
                        <svg  xmlns="http://www.w3.org/2000/svg" width="38" height="38"  
                            fill="orange" viewBox="0 0 24 24" >
                            <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                            <path d="M12 22c5.51 0 10-4.49 10-10S17.51 2 12 2 2 6.49 2 12s4.49 10 10 10M11 7h2v6h-2zm0 8h2v2h-2z"></path>
                        </svg>
                        How to select seats ?
                    </h1>
                    <div class="flex flex-col mx-15 gap-2 ">
                        <ul class="list-disc text-sm">
                            <li>Select a passenger and choose a seat</li>
                            <li>A seat is included in your fare. You are not required to purchase a seat assignment to travel. If you decide to purchase a ticket and do not select a seat prior to purchase, a seat will be provided to you without additional charge when you travel.</li>
                        </ul>
                    </div>
                </div>
                {% if messages %}
                    <ul>
                        {% for message in messages %}
                        <li class="{{ message.tags }}">{{ message }}</li>
                        {% endfor %}
                    </ul>
                {% endif %}

                <div class="flex-1 flex gap-5 h-auto">
                    <div class="flex-1 bg-white shadow-md/50 max-w-[400px] flex-col py-5 flex items-center px-7 space-y-2">
                        <h1 class="text-3xl font-bold">Passenger</h1>
                        <div class="w-full border mx-15"></div>
                        <!-- passenger name -->
                        {% for passenger in passengers %}
                        <div class="passenger-item flex-1 w-full max-h-[110px] px-5 flex justify-center items-center gap-10 

                        {% if forloop.first %} border-l-[#2975F7] border-l-10 bg-[#F4EB08] shadow-sm/50 {% else %} 
                            border-l-10 border-l-gray-500 bg-gray-300 text-gray-700 cursor-pointer {% endif %}"
                            onclick="selectPassenger('{{ forloop.counter0 }}', 'depart')"
                            data-passenger-id="{{ forloop.counter0 }}"
                            data-trip="depart"
                            >

                            <h1 class="text-4xl ">{{ forloop.counter }}</h1>
                            <div class="flex w-full flex-col" >
                                <p class="text-xl">{{ passenger.first_name }} {{ passenger.mi }} {{ passenger.last_name }}</p>
                                <p class="seat-status text-sm {% if forloop.first %}text-[#2975F7]{% endif %}" 
                                    id="depart-status-{{ forloop.counter0 }}">
                                    Not selected
                                </p>
                            </div>
                            <p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"  
                                    fill="{% if forloop.first %}#2975F7{% else %}gray{% endif %}" viewBox="0 0 24 24" >
                                    <path d="M6 13h8.09l-3.3 3.29 1.42 1.42 5.7-5.71-5.7-5.71-1.42 1.42 3.3 3.29H6z"></path>
                                </svg>
                            </p>
                        </div>
                        {% endfor %}

                    </div>

                    <!-- seats -->
                    <div class="flex-1 bg-[#2975F7] shadow-md/50 relative flex justify-center ">
                        <div class="flex-1 flex">
                            <div class=" w-full absolute z-10 top-1 right-1 ">
                                <div class=" mx-50 bg-white  h-[158px] shadow-lg/50 px-7 py-5">
                                    <h1 class="text-lg font-semibold">Seatmap Legend</h1>
                                    <div class="flex justify-around mt-6">
                                        <div  class="flex flex-col items-center">
                                            <div class="bg-[#2975F7] border w-10 h-10"></div>
                                            <p>Unavailable</p>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-white border w-10 h-10"></div>
                                            <p>Charge</p>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-[#F4EB08] border w-10 h-10"></div>
                                            <p>Selected</p>
                                        </div>
                                        
                                        
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 flex items-center">
                                <div class="w-full h-[100px] bg-[#F4EB08]">
                                    
                                </div>
                            </div>

                            <div class="w-[450px] h-auto bg-blue-300 pt-[250px] pb-10">
                                <div class="mx-7 ">
                                    <h1 class="text-4xl syncopate-bold text-center">AirBus</h1>
                                    <p class="mt-5 text-center text-2xl font-semibold">Front</p>

                                    {% comment %} seats  {% endcomment %}
                                    <div class="grid grid-cols-4 gap-5">
                                        {% for seat in depart_seats %}
                                        <div class="w-13 h-13 flex items-center justify-center shadow-md/50 cursor-pointer
                                                {% if not seat.is_available %} bg-[#2975F7] text-white cursor-not-allowed
                                                {% elif seat.seat_number in selected_seats.values %} bg-[#F4EB08]
                                                {% else %} bg-white hover:bg-yellow-100 {% endif %}"
                                                data-seat="{{ seat.seat_number }}"
                                                {% if seat.is_available %} onclick="selectSeat('{{ seat.seat_number }}', this)" {% endif %}>
                                                {{ seat.seat_number }}
                                            </div>
                                        {% endfor %}
                                    </div>



                                </div>
                            </div>
                            <div class="flex-1 flex items-center">
                                <div class="w-full h-[100px] bg-[#F4EB08]">
                                        
                                </div>
                            </div>

                        </div>
                    </div>
                </div>

                {% if return_seats %}
                <div id="return-section" class="flex-1 flex gap-5 h-auto hidden">
                    <div class="flex-1 bg-white shadow-md/50 max-w-[400px] flex-col py-5 flex items-center px-7 space-y-2">
                        <h1 class="text-3xl font-bold">Passenger</h1>
                        <div class="w-full border mx-15"></div>
                        <!-- passenger name -->
                        {% for passenger in passengers %}
                        <div class="passenger-item flex-1 w-full max-h-[110px] px-5 flex justify-center items-center gap-10 
                                    {% if forloop.first %} border-l-[#2975F7] border-l-10 bg-[#F4EB08] shadow-sm/50 {% else %} 
                                    border-l-10 border-l-gray-500 bg-gray-300 text-gray-700 cursor-pointer {% endif %}"
                                    data-passenger-id="{{ forloop.counter0 }}"
                                    data-trip="return"
                                    onclick="selectPassenger('{{ forloop.counter0 }}','return')">


                            <h1 class="text-4xl ">{{ forloop.counter }}</h1>
                            <div class="flex w-full flex-col" >
                                <p class="text-xl">{{ passenger.first_name }} {{ passenger.mi }} {{ passenger.last_name }}</p>
                                <p class="{% if forloop.first %}text-[#2975F7]{% endif %} text-xl">Select</p>
                            </div>
                            <p>
                                <svg xmlns="http://www.w3.org/2000/svg" width="48" height="48"  
                                    fill="{% if forloop.first %}#2975F7{% else %}gray{% endif %}" viewBox="0 0 24 24" >
                                    <path d="M6 13h8.09l-3.3 3.29 1.42 1.42 5.7-5.71-5.7-5.71-1.42 1.42 3.3 3.29H6z"></path>
                                </svg>
                            </p>
                        </div>
                        {% endfor %}

                    </div>




                    <!-- return  seats -->
                    <div class="flex-1 bg-[#2975F7] shadow-md/50 relative flex justify-center ">
                        <div class="flex-1 flex">
                            <div class=" w-full absolute z-10 top-1 right-1 ">
                                <div class=" mx-50 bg-white  h-[158px] shadow-lg/50 px-7 py-5">
                                    <h1 class="text-lg font-semibold">Seatmap Legend</h1>
                                    <div class="flex justify-around mt-6">
                                        <div  class="flex flex-col items-center">
                                            <div class="bg-[#2975F7] border w-10 h-10"></div>
                                            <p>Unavailable</p>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-white border w-10 h-10"></div>
                                            <p>Charge</p>
                                        </div>
                                        <div class="flex flex-col items-center">
                                            <div class="bg-[#F4EB08] border w-10 h-10"></div>
                                            <p>Selected</p>
                                        </div>
                                        
                                        
                                    </div>
                                </div>
                            </div>
                            <div class="flex-1 flex items-center">
                                <div class="w-full h-[100px] bg-[#F4EB08]">
                                    
                                </div>
                            </div>

                            <div class="w-[450px] h-auto bg-blue-300 pt-[250px] pb-10">
                                <div class="mx-7 ">
                                    <h1 class="text-4xl syncopate-bold text-center">AirBus</h1>
                                    <p class="mt-5 text-center text-2xl font-semibold">Front</p>

                                    {% comment %} seats  {% endcomment %}
                                    <div class="grid grid-cols-4 gap-5">
                                        {% for seat in return_seats %}
                                        <div class="w-13 h-13 flex items-center justify-center shadow-md/50 cursor-pointer
                                                {% if not seat.is_available %} bg-[#2975F7] text-white cursor-not-allowed
                                                {% elif seat.seat_number in selected_seats.values %} bg-[#F4EB08]
                                                {% else %} bg-white hover:bg-yellow-100 {% endif %}"
                                                data-seat="{{ seat.seat_number }}"
                                                {% if seat.is_available %} 
                                                onclick="selectReturnSeat('{{ seat.seat_number }}', this)"  {% endif %}>
                                                {{ seat.seat_number }}
                                            </div>
                                        {% endfor %}
                                    </div>



                                </div>
                            </div>
                            <div class="flex-1 flex items-center">
                                <div class="w-full h-[100px] bg-[#F4EB08]">
                                        
                                </div>
                            </div>

                        </div>
                    </div>
                   
                </div>
                {% endif %}
                
                
              <div class="flex justify-end continue-button ">
                    <form action="{% url 'bookingapp:booking_summary' %}" method="POST">
                        {% csrf_token %}
                    <button type="submit"  id="continueBtn"
                     class="bg-[#F4EB08] hover:bg-[#c5c02e]/90 py-2 px-20 rounded-full shadow-md/50 cursor-pointer"  > Continue </button>
                    </form>
                </div>

            </div>

        </div>       

    </main>

<!-- Seat Confirmation Modal -->
<div id="seatModal" class="fixed inset-0 hidden items-center justify-center bg-black/50 z-50">
  <div class="bg-white rounded-lg shadow-lg p-6 w-[350px]">
    <h2 class="text-lg font-bold mb-4">Confirm Seat</h2>
    <p id="seatModalMessage" class="mb-6 text-gray-700"></p>
    <div class="flex justify-end gap-3">
      <button id="cancelSeatBtn" class="px-4 py-2 bg-gray-300 rounded hover:bg-gray-400">Cancel</button>
      <button id="confirmSeatBtn" class="px-4 py-2 bg-[#2975F7] text-white rounded hover:bg-[#1d5edb]">Yes</button>
    </div>
  </div>
</div>



<script>
const csrfToken = "{{ csrf_token }}";  // Django CSRF token
let activePassenger = null;
let activeTrip = "depart"; // default
let pendingSeat = null;
let pendingElement = null;
let pendingTrip = null;

// --------------------------
// Modal Handling
// --------------------------
function openSeatModal(seatNumber, element, trip) {
    pendingSeat = seatNumber;
    pendingElement = element;
    pendingTrip = trip;

    document.getElementById("seatModalMessage").textContent = 
        `You selected seat ${seatNumber}. Do you want to confirm?`;

    const modal = document.getElementById("seatModal");
    modal.classList.remove("hidden", "opacity-0");
    modal.classList.add("flex");
}

document.getElementById("cancelSeatBtn").addEventListener("click", function() {
    const modal = document.getElementById("seatModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
});

document.getElementById("confirmSeatBtn").addEventListener("click", function() {
    if (pendingSeat && pendingElement && pendingTrip) {
        confirmSeatSelection(pendingSeat, pendingElement, pendingTrip);
    }
    const modal = document.getElementById("seatModal");
    modal.classList.add("hidden");
    modal.classList.remove("flex");
});

// --------------------------
// Seat Selection
// --------------------------
function selectSeat(seatNumber, element) {
    if (!activePassenger) {
        alert("⚠ Please select a passenger first!");
        return;
    }
    openSeatModal(seatNumber, element, "depart");
}

function selectReturnSeat(seatNumber, element) {
    if (!activePassenger) {
        alert("⚠ Please select a passenger first!");
        return;
    }
    openSeatModal(seatNumber, element, "return");
}

// --------------------------
// Confirm Seat Selection (single function)
// --------------------------
function confirmSeatSelection(seatNumber, element, trip) {
    fetch("{% url 'bookingapp:confirm_seat' %}", {
        method: "POST",
        headers: {
            "X-CSRFToken": csrfToken,
            "Content-Type": "application/x-www-form-urlencoded"
        },
        body: new URLSearchParams({
            seat_number: seatNumber,
            passenger_id: activePassenger,
            trip: trip
        })
    })
    .then(res => res.json())
    .then(data => {
        if (!data.success) {
            alert("❌ " + data.message);
            return;
        }

        // Clear old seat
        const attr = trip === "depart" ? "data-seat-selected" : "data-return-seat-selected";
        document.querySelectorAll(`[${attr}='${activePassenger}']`).forEach(s => {
            s.classList.remove("bg-[#F4EB08]");
            s.classList.add("bg-white", "hover:bg-yellow-100");
            s.removeAttribute(attr);
        });

        // Highlight new seat
        element.classList.remove("bg-white", "hover:bg-yellow-100");
        element.classList.add("bg-[#F4EB08]");
        element.setAttribute(attr, activePassenger);

        // Update passenger status
        const statusEl = document.getElementById(`${trip}-status-${activePassenger}`);
        if (statusEl) {
            statusEl.textContent = `✅ Seat ${seatNumber} selected`;
            statusEl.classList.remove("text-gray-500", "text-yellow-600");
            statusEl.classList.add("text-green-600");
        }

        // Mark passenger as completed
        const currentEl = document.querySelector(`.passenger-item[data-passenger-id="${activePassenger}"][data-trip="${trip}"]`);
        if (currentEl) {
            currentEl.classList.add("bg-green-400", "text-white");
        }

        // Move to next passenger
        const passengerEls = document.querySelectorAll(`.passenger-item[data-trip="${trip}"]`);
        const currentIndex = Array.from(passengerEls).indexOf(currentEl);

        if (currentIndex + 1 < passengerEls.length) {
            setActivePassenger(currentIndex + 1, trip);
        } else if (trip === "depart") {
            // Switch to return trip if exists
            const returnEls = document.querySelectorAll(`.passenger-item[data-trip="return"]`);
            if (returnEls.length > 0) {
                setActivePassenger(0, "return");
                document.getElementById("return-section").classList.remove("hidden");
                document.getElementById("return-section").scrollIntoView({ behavior: "smooth" });
            } else {
                document.getElementById("continueBtn").disabled = false;
            }
        } else if (trip === "return") {
            checkAllSeatsSelected();
        }
    });
}

// --------------------------
// Passenger Selection & Highlighting
// --------------------------
function selectPassenger(passengerId, trip = "depart") {
    activePassenger = passengerId;
    activeTrip = trip;
    highlightPassenger(passengerId, trip);
}

function highlightPassenger(passengerId, trip) {
    document.querySelectorAll(`.passenger-item[data-trip="${trip}"]`).forEach(p => {
        const pid = p.getAttribute("data-passenger-id");
        const statusEl = document.getElementById(`${trip}-status-${pid}`);

        if (pid === passengerId) {
            p.classList.remove("bg-gray-300", "text-gray-700", "bg-green-400", "text-white");
            p.classList.add("bg-[#F4EB08]", "shadow-sm/50");
            if (statusEl && !statusEl.textContent.includes("✅")) {
                statusEl.textContent = "✏️ Selecting seat...";
                statusEl.classList.remove("text-green-600", "text-gray-500");
                statusEl.classList.add("text-yellow-600");
            }
        } else if (p.classList.contains("bg-green-400")) {
            // keep completed green
        } else {
            p.classList.remove("bg-[#F4EB08]", "shadow-sm/50");
            p.classList.add("bg-gray-300", "text-gray-700");
            if (statusEl && !statusEl.textContent.includes("✅")) {
                statusEl.textContent = "⏳ Waiting...";
                statusEl.classList.remove("text-green-600", "text-yellow-600");
                statusEl.classList.add("text-gray-500");
            }
        }
    });
}

function setActivePassenger(index, trip) {
    const passengerEls = document.querySelectorAll(`.passenger-item[data-trip="${trip}"]`);
    if (index >= 0 && index < passengerEls.length) {
        const nextPassenger = passengerEls[index];
        const passengerId = nextPassenger.getAttribute("data-passenger-id");

        activePassenger = passengerId;
        activeTrip = trip;

        highlightPassenger(passengerId, trip);
        nextPassenger.scrollIntoView({ behavior: "smooth", block: "center" });
    }
}

// --------------------------
// Check if all seats are selected
// --------------------------
function checkAllSeatsSelected() {
    const passengers = document.querySelectorAll("[data-passenger-id]");
    let allDepartSelected = true;
    let allReturnSelected = true;

    passengers.forEach(p => {
        const pid = p.getAttribute("data-passenger-id");
        if (!document.querySelector(`[data-seat-selected='${pid}']`)) allDepartSelected = false;
        if (document.querySelector("#return-section") && !document.querySelector(`[data-return-seat-selected='${pid}']`)) allReturnSelected = false;
    });

    if (allDepartSelected && document.querySelector("#return-section")) {
        document.getElementById("return-section").classList.remove("hidden");
    }

    document.getElementById("continueBtn").disabled = !(allDepartSelected && allReturnSelected);
}

// --------------------------
// Initialize on page load
// --------------------------
document.addEventListener("DOMContentLoaded", function () {
    // Auto-select first passenger
    const firstPassenger = document.querySelector(".passenger-item[data-trip='depart']");
    if (firstPassenger) {
        activePassenger = firstPassenger.getAttribute("data-passenger-id");
        highlightPassenger(activePassenger, "depart");
    }

    // Pre-fill seats from session
    const sessionSeats = {{ selected_seats|safe }};
    Object.keys(sessionSeats).forEach(passengerId => {
        if (sessionSeats[passengerId].depart) {
            const seatDiv = document.querySelector("[data-seat='" + sessionSeats[passengerId].depart + "']");
            if (seatDiv) {
                seatDiv.classList.add("bg-[#F4EB08]");
                seatDiv.setAttribute("data-seat-selected", passengerId);
            }
        }
        if (sessionSeats[passengerId].return) {
            const seatDiv = document.querySelector("[data-seat='" + sessionSeats[passengerId].return + "']");
            if (seatDiv) {
                seatDiv.classList.add("bg-[#F4EB08]");
                seatDiv.setAttribute("data-return-seat-selected", passengerId);
            }
        }
    });

    checkAllSeatsSelected();
});
</script>



{% endblock %}