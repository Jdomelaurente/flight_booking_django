{% extends 'ui_test/base.html' %}
{% load static %}

{% block title %}Schedule{% endblock %}

{% block content %}
<style>
    .no-scrollbar::-webkit-scrollbar {
        display: none;
    }
    .no-scrollbar {
        -ms-overflow-style: none;
        scrollbar-width: none;
    }
    .transition {
        transition: all 0.3s ease;
    }
    .addon-grid {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
        gap: 8px;
        margin-top: 10px;
    }
    .included-addon {
        background-color: #f0f9ff;
        border: 1px solid #bae6fd;
        border-radius: 6px;
        padding: 8px;
    }
    .optional-addon {
        background-color: #f8fafc;
        border: 1px solid #e2e8f0;
        border-radius: 6px;
        padding: 8px;
    }
    .selected-flight {
        border: 2px solid #10b981;
        background-color: #f0fdf4;
    }
    .selected-button {
        background-color: #10b981 !important;
        pointer-events: none;
    }
    .checkmark {
        display: inline-flex;
        align-items: center;
        justify-content: center;
    }
</style>

<script>
document.addEventListener('DOMContentLoaded', function () {
    // Add click handlers for all select buttons
    document.querySelectorAll('.select-flight-btn').forEach(button => {
        button.addEventListener('click', function(e) {
            e.preventDefault();
            const scheduleId = this.dataset.scheduleId;
            const scheduleData = this.dataset.scheduleData;
            const flightType = this.dataset.flightType; // 'departure' or 'return'
            
            if (scheduleData) {
                const data = JSON.parse(scheduleData);
                showAddOnsModal(data, scheduleId, flightType);
            }
        });
    });

    // Confirm selection handler - ONLY if the element exists
    const confirmSelectionBtn = document.getElementById('confirmSelection');
    if (confirmSelectionBtn) {
        confirmSelectionBtn.addEventListener('click', function() {
            const scheduleId = this.dataset.scheduleId;
            const flightType = this.dataset.flightType;
            
            if (scheduleId) {
                // Submit the form
                const form = document.getElementById(`selectForm-${scheduleId}`);
                if (form) {
                    // Add flight type to the form
                    const flightTypeInput = document.createElement('input');
                    flightTypeInput.type = 'hidden';
                    flightTypeInput.name = 'flight_type';
                    flightTypeInput.value = flightType;
                    form.appendChild(flightTypeInput);
                    
                    form.submit();
                }
            }
        });
    }

    // Modal event listeners
    const addOnsModal = document.getElementById('addOnsModal');
    if (addOnsModal) {
        addOnsModal.addEventListener('click', function(e) {
            if (e.target.id === 'addOnsModal') {
                closeModal();
            }
        });
    }

    const unselectModal = document.getElementById('unselectModal');
    if (unselectModal) {
        unselectModal.addEventListener('click', function(e) {
            if (e.target.id === 'unselectModal') {
                closeUnselectModal();
            }
        });
    }

    // Unselect button handler - opens modal
    const unselectBtn = document.getElementById('unselectBtn');
    if (unselectBtn) {
        unselectBtn.addEventListener('click', function(e) {
            e.preventDefault();
            showUnselectModal();
        });
    }

    // Confirm unselect handler
    const confirmUnselectBtn = document.getElementById('confirmUnselect');
    if (confirmUnselectBtn) {
        confirmUnselectBtn.addEventListener('click', function() {
            fetch("{% url 'bookingapp:reset_selection' %}", {
                method: "POST",
                headers: {
                    "Content-Type": "application/x-www-form-urlencoded",
                    "X-CSRFToken": "{{ csrf_token }}"
                },
                credentials: "same-origin"
            })
            .then(() => {
                window.location.reload();
            })
            .catch(err => console.log("Reset failed:", err));
        });
    }
});

function showAddOnsModal(scheduleData, scheduleId, flightType) {
    // Set modal title
    const flightTypeText = flightType === 'return' ? 'Return Flight' : 'Departure Flight';
    const modalFlightInfo = document.getElementById('modalFlightInfo');
    if (modalFlightInfo) {
        modalFlightInfo.textContent = `${flightTypeText}: ${scheduleData.flight_number} - ${scheduleData.airline}`;
    }
    
    // Set schedule ID and flight type for confirmation
    const confirmBtn = document.getElementById('confirmSelection');
    if (confirmBtn) {
        confirmBtn.dataset.scheduleId = scheduleId;
        confirmBtn.dataset.flightType = flightType;
    }
    
    // Clear previous add-ons
    const addonsContainer = document.getElementById('includedAddons');
    if (addonsContainer) {
        addonsContainer.innerHTML = '';
        
        // Add included add-ons
        if (scheduleData.included_addons && scheduleData.included_addons.length > 0) {
            scheduleData.included_addons.forEach(addon => {
                const addonElement = document.createElement('div');
                addonElement.className = 'included-addon mb-2 p-3 bg-green-50 border border-green-200 rounded-lg';
                addonElement.innerHTML = `
                    <div class="flex items-center justify-between">
                        <div>
                            <h4 class="font-semibold text-green-800">${addon.name}</h4>
                            ${addon.description ? `<p class="text-sm text-green-600 mt-1">${addon.description}</p>` : ''}
                        </div>
                        <span class="bg-green-100 text-green-800 text-xs px-2 py-1 rounded-full">Included</span>
                    </div>
                `;
                addonsContainer.appendChild(addonElement);
            });
        } else {
            addonsContainer.innerHTML = '<p class="text-gray-500 text-center py-4">No included add-ons for this flight.</p>';
        }
    }
    
    // Show modal
    const modal = document.getElementById('addOnsModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function closeModal() {
    const modal = document.getElementById('addOnsModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

function showUnselectModal() {
    const modal = document.getElementById('unselectModal');
    if (modal) {
        modal.classList.remove('hidden');
    }
}

function closeUnselectModal() {
    const modal = document.getElementById('unselectModal');
    if (modal) {
        modal.classList.add('hidden');
    }
}

// Auto-scroll to return section when departure is selected
{% if request.session.depart_schedule_id and return_schedules %}
document.addEventListener('DOMContentLoaded', function() {
    const returnSection = document.getElementById('return-section');
    if (returnSection) {
        setTimeout(() => {
            returnSection.scrollIntoView({ behavior: 'smooth' });
        }, 500);
    }
});
{% endif %}
</script>

<!-- Add-ons Modal -->
<div id="addOnsModal" class="fixed inset-0 backdrop-blur-md bg-black/30 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-xs max-w-md w-full mx-4">
        <div class="p-10">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Flight Add-ons</h3>
                <button onclick="closeModal()" class="text-gray-500 hover:text-red-500 cursor-pointer">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-4">
                <h4 id="modalFlightInfo" class="font-medium text-gray-700"></h4>
                <p class="text-sm text-gray-500 mt-1">Included with your flight:</p>
            </div>
            
            <div id="includedAddons" class="max-h-60 overflow-y-auto mb-6">
                <!-- Add-ons will be populated here -->
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 hover:bg-gray-100 cursor-pointer rounded-xs">
                    Cancel
                </button>
                <button id="confirmSelection" class="px-4 py-2 bg-[#FFC83D] hover:bg-[#FFC83D]/80 cursor-pointer text-[#093704] font-medium rounded-xs">
                    Confirm Selection
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Unselect Confirmation Modal -->
<div id="unselectModal" class="fixed inset-0 backdrop-blur-md bg-black/30 hidden flex items-center justify-center z-50">
    <div class="bg-white rounded-xs max-w-md w-full mx-4">
        <div class="p-6">
            <div class="flex justify-between items-center mb-4">
                <h3 class="text-lg font-semibold text-gray-800">Unselect Flights</h3>
                <button onclick="closeUnselectModal()" class="text-gray-500 hover:text-gray-700">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
                    </svg>
                </button>
            </div>
            
            <div class="mb-6">
                <div class="flex items-center justify-center mb-4">
                    <div class="bg-red-100 p-3 rounded-full">
                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.964-.833-2.732 0L4.35 16.5c-.77.833.192 2.5 1.732 2.5z"></path>
                        </svg>
                    </div>
                </div>
                <h4 class="text-center font-medium text-gray-700 mb-2">Are you sure you want to unselect all flights?</h4>
                <p class="text-sm text-gray-500 text-center">This will clear your current flight selections and you'll need to select them again.</p>
            </div>
            
            <div class="flex justify-end space-x-3">
                <button onclick="closeUnselectModal()" class="px-4 py-2 text-gray-600 hover:text-gray-800 border border-gray-300 hover:bg-gray-100 cursor-pointer rounded-xs">
                    Cancel
                </button>
                <button id="confirmUnselect" class="px-4 py-2 bg-red-500 hover:bg-red-600 cursor-pointer text-white font-medium rounded-xs">
                    Yes, Unselect All
                </button>
            </div>
        </div>
    </div>
</div>



<div class="max-w-8xl w-full mx-auto p-4 space-y-5">
    <!-- Schedule Header Card -->
    <div class="bg-[#093704] rounded-lg p-6 mx-10">
        <div class="flex flex-col md:flex-row justify-between items-center">
            <!-- Trip Type -->
            <div class="flex-1 mb-4 md:mb-0 md:pr-4">
                <p class="text-gray-300 text-sm font-semibold mb-1">Type</p>
                <div class="flex items-center">
                    <h2 class="text-white font-semibold">
                        {% if return_date %}Round-Trip{% else %}One-Way{% endif %}
                    </h2>
                </div>
            </div>

            <!-- Departure -->
            <div class="flex-1 mb-4 md:mb-0 md:px-4 border-l-0 md:border-l md:border-gray-600 md:pl-6">
                <p class="text-gray-300 text-sm font-semibold mb-1">Depart</p>
                <div class="flex items-center">
                    <div>
                        <div class="flex items-center">
                            <div class="text-center mr-2">
                                <h3 class="text-white font-bold leading-none">{{ origin.code }}</h3>
                                <p class="text-gray-300 text-xs">{{ origin.location }}</p>
                            </div>
                            <div class="text-center ml-2">
                                <h3 class="text-white font-bold leading-none">{{ destination.code }}</h3>
                                <p class="text-gray-300 text-xs">{{ destination.location }}</p>
                            </div>
                        </div>
                        <p class="text-white font-medium mt-1">{{ departure_date }}</p>
                    </div>
                </div>
            </div>

            <!-- Return -->
            {% if return_date %}
            <div class="flex-1 mb-4 md:mb-0 md:px-4 border-l-0 md:border-l md:border-gray-600 md:pl-6">
                <p class="text-gray-300 text-sm font-semibold mb-1">Return</p>
                <div class="flex items-center">
                    <div>
                        <div class="flex items-center">
                            <div class="text-center mr-2">
                                <h3 class="text-white font-bold leading-none">{{ destination.code }}</h3>
                                <p class="text-gray-300 text-xs">{{ destination.location }}</p>
                            </div>
                            <div class="text-center ml-2">
                                <h3 class="text-white font-bold leading-none">{{ origin.code }}</h3>
                                <p class="text-gray-300 text-xs">{{ origin.location }}</p>
                            </div>
                        </div>
                        <p class="text-white font-medium mt-1">{{ return_date }}</p>
                    </div>
                </div>
            </div>
            {% endif %}

            <!-- Passenger Count -->
            <div class="flex-1 mb-4 md:mb-0 md:px-4 border-l-0 md:border-l md:border-gray-600 md:pl-6">
                <p class="text-gray-300 text-sm font-semibold mb-1">Passenger Count</p>
                <div class="flex items-center">
                    <h2 class="text-white text-lg font-semibold">{{ passenger_count }}</h2>
                </div>
            </div>

            <!-- Unselect Button (shows only when flights are selected) -->
            <div class="mt-4 md:mt-0 md:pl-4">
                {% if request.session.depart_schedule_id or request.session.return_schedule_id %}
                <button id="unselectBtn" class="py-3 px-10 rounded-xs bg-red-500 hover:bg-red-400 text-white font-medium cursor-pointer transition-colors duration-200 shadow-md flex items-center">
                    Unselect 
                </button>
                {% else %}
                <a href="#" class="py-3 px-10 rounded-xs bg-white hover:bg-gray-200 text-[#093704] font-semibold cursor-pointer transition-colors duration-200 shadow-md flex items-center">
                    Edit Search
                </a>
                {% endif %}
            </div>
        </div>
    </div>
</div>

<!-- step by step process -->
<div class="bg-[#FFC83D] w-full h-[160px] mx-auto flex flex-col">
    <!-- arrow  -->
    <div class="flex justify-between items-center flex-1 mx-20">
        <div class="rounded-full p-1 border border-[#093704]">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" class="bg-[#093704] p-1 rounded-full" fill="white" viewBox="0 0 24 24">
                <path d="m17.54,3.64l-2.9,2.9-9.88-1.16c-.15-.02-.3.03-.41.14l-.59.59c-.24.24-.17.66.14.8l7.01,3.36-3.25,3.25-3.27-.65c-.16-.03-.33.02-.45.14l-.7.7c-.25.25-.17.67.16.81l4.27,1.83,1.83,4.27c.14.33.56.41.81.16l.7-.7c.12-.12.17-.29.14-.45l-.65-3.27,3.31-3.31,3.31,7.06c.15.31.56.39.81.14l.66-.66c.11-.11.16-.26.14-.41l-1.16-9.88,2.75-2.75c.7-.7.88-1.84.29-2.65-.74-1.03-2.19-1.12-3.05-.26Z"></path>
            </svg>
        </div>

        <div class="flex-1 h-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

        <div class="rounded-full p-1 border border-[#093704]">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" class="bg-[#093704] p-1 rounded-full" fill="white" viewBox="0 0 24 24">
                <path d="m19,2H5c-.55,0-1,.45-1,1v4h-2v2h2v2h-2v2h2v2h-2v2h2v4c0,.55.45,1,1,1h14c1.1,0,2-.9,2-2V4c0-1.1-.9-2-2-2Zm-6.5,5c1.43,0,2.5,1.07,2.5,2.5s-1.07,2.5-2.5,2.5-2.5-1.07-2.5-2.5,1.07-2.5,2.5-2.5Zm4.5,10h-9v-1c0-1.66,1.34-3,3-3h3c1.66,0,3,1.34,3,3v1Z"></path>
            </svg>
        </div>

        <div class="flex-1 h-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

        <div class="rounded-full p-1 border border-[#093704]">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" class="bg-[#093704] p-1 rounded-full" fill="white" viewBox="0 0 24 24">
                <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4z"></path>
            </svg>
        </div>

        <div class="flex-1 h-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

        <div class="rounded-full p-1 border border-[#093704]">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" class="bg-[#093704] p-1 rounded-full" fill="white" viewBox="0 0 24 24">
                <path d="m4,5v4h2v-4h4v-2h-4c-1.1,0-2,.9-2,2Z"></path><path d="m6,15h-2v4c0,1.1.9,2,2,2h4v-2h-4v-4Z"></path><path d="m20,19h-4v2h4c1.1,0,2-.9,2-2v-4h-2v4Z"></path><path d="m16,3v2h4v4h2v-4c0-1.1-.9-2-2-2h-4Z"></path><path d="M8 15H18V17H8z"></path><path d="M18 7 8 7 8 11 3 11 3 13 8 13 18 13 23 13 23 11 18 11 18 7z"></path>
            </svg>
        </div>

        <div class="flex-1 h-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

        <div class="rounded-full p-1 border border-[#093704]">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" class="bg-[#093704] p-1 rounded-full" fill="white" viewBox="0 0 24 24">
                <path d="m21,7h-1v-3c0-.55-.45-1-1-1H5c-1.65,0-3,1.35-3,3v12c0,2.2,1.79,3,3,3h16c.55,0,1-.45,1-1v-12c0-.55-.45-1-1-1Zm-3,9h-2v-4h2v4ZM5,5h13v2H5c-.55,0-1-.45-1-1s.45-1,1-1Z"></path>
            </svg>
        </div>

        <div class="flex-1 h-1 border-t-4 border-dashed border-[#093704] mx-4"></div>

        <div class="rounded-full p-1 border border-[#093704]">
            <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" class="bg-[#093704] p-1 rounded-full" fill="white" viewBox="0 0 24 24">
                <path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10 10-4.49 10-10S17.51 2 12 2m-1.29 13.71c-.2.2-.45.29-.71.29s-.51-.1-.71-.29l-3-3L7.7 11.3l2.29 2.29 5.29-5.29 1.41 1.41-6 6Z"></path>
            </svg>
        </div>
    </div>
</div>

<div class="mx-25 mt-10">
    <!-- Departure Flights Section -->
    <div id="departure-section">
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="font-medium text-gray-400">Select your departing flight</h1>
                <div class="flex text-3xl gap-5">
                    <h1 class="font-semibold">{{ origin.code }} - {{ origin.location }}</h1>
                    <div>-</div>
                    <h1 class="font-semibold">{{ destination.code }} - {{ destination.location }}</h1>
                </div>
            </div>
            {% if request.session.depart_schedule_id %}
            <div class="flex items-center gap-2 text-green-600 text-sm">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span>Departure flight selected</span>
            </div>
            {% endif %}
        </div>

        <!-- Date Selector -->
        <div class="bg-[#093704] py-1 h-15 flex mt-5 justify-around rounded-xs gap-1">
            <!-- prev -->
            <div class="bg-white rounded-sm flex items-center py-3 px-2 hover:bg-gray-100 cursor-pointer">
                <img src="{% static 'bookingapp/asset/arrow-left.svg' %}" alt="" class="">
            </div>

            <!-- date cards -->
            {% for i in dates %}
            <button type="button" class="flex gap-0.5 items-center bg-white hover:bg-gray-100 cursor-pointer flex-col justify-center px-10 rounded-sm">
                <h1 class="text-xs font-semibold">{{ departure_date }}</h1>
                <p class="text-xs">₱1,123.00</p>
            </button>
            {% endfor %}

            <!-- next -->
            <div class="bg-white rounded-sm flex items-center py-3 px-2 hover:bg-gray-100 cursor-pointer">
                <img src="{% static 'bookingapp/asset/arrow-right.svg' %}" alt="" class="">
            </div>
        </div>

        <!-- Filters -->
        <div class="w-full flex text-xs mt-5 gap-2">
            <h1 class="text-gray-500 text-lg">Filter: </h1>
            <button class="bg-white hover:bg-gray-100 cursor-pointer border-gray-500 border py-1.5 px-5">Time of Flight</button>
            <button class="bg-white hover:bg-gray-100 cursor-pointer border-gray-500 border py-1.5 px-5">Stops</button>
            <button class="bg-white hover:bg-gray-100 cursor-pointer border-gray-500 border py-1.5 px-5">Price</button>
        </div>

        <!-- Flight Listings -->
        <div class="flex-1 space-y-3 my-2 text-sm">
            {% if schedules %}
            {% for schedule in schedules %}
            <div class="w-full flex justify-between gap-2 {% if request.session.depart_schedule_id == schedule.id|stringformat:'i' %}selected-flight{% endif %}">
                <!-- Flight Info -->
                <div class="border flex-1 py-4 px-7 flex gap-5 items-center justify-center rounded-sm bg-white">
                    <div class="flex-1 flex items-center justify-center gap-3">
                        <div>
                            <h1 class="text-lg leading-none">{{ schedule.departure_time|date:"H:i" }}</h1>
                            <p class="text-xs">Depart-{{ schedule.flight.route.origin_airport.code }}</p>
                        </div>
                        <div>============</div>
                        <div>
                            <h1 class="text-lg leading-none">{{ schedule.arrival_time|date:"H:i" }}</h1>
                            <p class="text-xs">Arrive-{{ schedule.flight.route.destination_airport.code }}</p>
                        </div>
                    </div>
                    
                    <div class="border h-10 mx-5"></div>
                    
                    <!-- Itinerary -->
                    <div class="w-[250px] flex flex-col">
                        <h1>{{ schedule.duration }}</h1>
                        <!-- flight number -->
                        <div class="flex items-center gap-1">
                            <h1 class="font-semibold">{{ schedule.flight.flight_number }}</h1>
                            <p class="text-gray-500 text-xs">operated by</p>
                            <h1 class="font-semibold">{{ schedule.flight.airline.name }}</h1>
                        </div>

                        <a href="#" class="underline text-xs">See itinerary details</a>
                    </div>
                </div>
                
                <!-- Price Options -->
                <div class="flex-1 gap-1 max-w-[450px] flex">
                    {% for seat_class in schedule.available_seat_classes %}
                    <div class="flex-1 border rounded-sm bg-white p-2 flex justify-center flex-col">
                        <h1 class="font-medium text-left text-gray-500">{{ seat_class.name }}</h1>
                        <p class="font-semibold text-lg">PHP {{ schedule.price|floatformat:2 }}</p>
                        
                        {% if request.session.depart_schedule_id == schedule.id|stringformat:'i' %}
                            <!-- Selected State -->
                            <div class="flex items-center gap-1 bg-green-600 px-2 py-1 text-white rounded-sm text-xs justify-center">
                                <svg class="checkmark" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 6L9 17l-5-5"></path>
                                </svg>
                                <span>Selected</span>
                            </div>
                        {% else %}
                            <!-- Select Button with Modal Trigger -->
                            <form id="selectForm-{{ schedule.id }}" method="POST" action="{% url 'bookingapp:select_schedule' %}" class="hidden">
                                {% csrf_token %}
                                <input type="hidden" name="schedule_id" value="{{ schedule.id }}">
                            </form>
                            <button type="button" 
                                    class="w-full bg-[#FFC83D] hover:bg-[#FFC83D]/80 py-1 cursor-pointer rounded-sm select-flight-btn"
                                    data-schedule-id="{{ schedule.id }}"
                                    data-flight-type="departure"
                                    data-schedule-data='{
                                        "flight_number": "{{ schedule.flight.flight_number }}",
                                        "airline": "{{ schedule.flight.airline.name }}",
                                        "included_addons": [
                                            {% for addon in schedule.included_addons %}
                                            {
                                                "name": "{{ addon.name }}",
                                                "description": "{{ addon.description|default:'' }}"
                                            }{% if not forloop.last %},{% endif %}
                                            {% endfor %}
                                        ]
                                    }'>
                                Select
                            </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
            {% else %}
            <div class="w-full text-center py-8 bg-white rounded-sm border">
                <p class="text-gray-500">No departure flights found for the selected date.</p>
            </div>
            {% endif %}
        </div>

        {% if schedules %}
        <div class="w-full flex justify-center mt-4">
            <button type="button" class="px-5 py-2 bg-white hover:bg-gray-100 cursor-pointer border border-gray-400">see more..</button>
        </div>
        {% endif %}
    </div>

    <!-- Return Flights Section -->
    {% if return_schedules %}
    <div id="return-section" class="mt-10">
        <div class="border-t border-gray-300 my-8"></div>
        
        <div class="flex justify-between items-center mb-4">
            <div>
                <h1 class="font-medium text-gray-400">Select your returning flight</h1>
                <div class="flex text-3xl gap-5">
                    <h1 class="font-semibold">{{ destination.code }} - {{ destination.location }}</h1>
                    <div>-</div>
                    <h1 class="font-semibold">{{ origin.code }} - {{ origin.location }}</h1>
                </div>
            </div>
            {% if request.session.return_schedule_id %}
            <div class="flex items-center gap-2 text-green-600 text-sm">
                <svg class="w-5 h-5" fill="currentColor" viewBox="0 0 20 20">
                    <path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd"></path>
                </svg>
                <span>Return flight selected</span>
            </div>
            {% endif %}
        </div>

        <!-- Return Date Selector -->
        <div class="bg-[#093704] py-1 h-15 flex mt-5 justify-around rounded-xs gap-1.5">
            <!-- prev -->
            <div class="bg-white rounded-sm flex items-center py-3 px-2 hover:bg-gray-100 cursor-pointer">
                <img src="{% static 'bookingapp/asset/arrow-left.svg' %}" alt="" class="">
            </div>

            <!-- date cards -->
            {% for i in dates %}
            <button type="button" class="flex gap-0.5 items-center bg-white hover:bg-gray-100 cursor-pointer flex-col justify-center px-10 rounded-sm">
                <h1 class="text-sm font-semibold">{{ return_date }}</h1>
                <p class="text-xs">₱1,123.00</p>
            </button>
            {% endfor %}

            <!-- next -->
            <div class="bg-white rounded-sm flex items-center py-3 px-2 hover:bg-gray-100 cursor-pointer">
                <img src="{% static 'bookingapp/asset/arrow-right.svg' %}" alt="" class="">
            </div>
        </div>

        <!-- Return Flight Filters -->
        <div class="w-full text-xs mt-5 gap-2">
            <button class="bg-white hover:bg-gray-100 cursor-pointer border-gray-500 border py-1.5 px-5">Time of Flight</button>
            <button class="bg-white hover:bg-gray-100 cursor-pointer border-gray-500 border py-1.5 px-5">Stops</button>
            <button class="bg-white hover:bg-gray-100 cursor-pointer border-gray-500 border py-1.5 px-5">Price</button>
        </div>

        <!-- Return Flight Listings -->
        <div class="flex-1 space-y-3 my-2 text-sm">
            {% for return_schedule in return_schedules %}
            <div class="w-full flex justify-between gap-2 {% if request.session.return_schedule_id == return_schedule.id|stringformat:'i' %}selected-flight{% endif %}">
                <!-- Flight Info -->
                <div class="border flex-1 py-4 px-7 flex gap-5 items-center justify-center rounded-sm bg-white">
                    <div class="flex-1 flex items-center justify-center gap-3">
                        <div>
                            <h1 class="text-lg leading-none">{{ return_schedule.departure_time|date:"H:i" }}</h1>
                            <p class="text-xs">Depart-{{ return_schedule.flight.route.origin_airport.code }}</p>
                        </div>
                        <div>============</div>
                        <div>
                            <h1 class="text-lg leading-none">{{ return_schedule.arrival_time|date:"H:i" }}</h1>
                            <p class="text-xs">Arrive-{{ return_schedule.flight.route.destination_airport.code }}</p>
                        </div>
                    </div>
                    
                    <div class="border h-10 mx-5"></div>
                    
                    <!-- Itinerary -->
                    <div class="w-[250px] flex flex-col">
                        <h1>{{ return_schedule.duration }}</h1>
                        <!-- flight number -->
                        <div class="flex items-center gap-1">
                            <h1 class="font-semibold">{{ return_schedule.flight.flight_number }}</h1>
                            <p class="text-gray-500 text-xs">operated by</p>
                            <h1 class="font-semibold">{{ return_schedule.flight.airline.name }}</h1>
                        </div>

                        <a href="#" class="underline text-xs">See itinerary details</a>
                    </div>
                </div>
                
                <!-- Price Options -->
                <div class="flex-1 gap-1 max-w-[450px] flex">
                    {% for seat_class in return_schedule.available_seat_classes %}
                    <div class="flex-1 border rounded-sm bg-white p-2 flex justify-center flex-col">
                        <h1 class="font-medium text-left text-gray-500">{{ seat_class.name }}</h1>
                        <p class="font-semibold text-lg">PHP {{ return_schedule.price|floatformat:2 }}</p>
                        
                        {% if request.session.return_schedule_id == return_schedule.id|stringformat:'i' %}
                            <!-- Selected State -->
                            <div class="flex items-center gap-1 bg-green-600 px-2 py-1 text-white rounded-sm text-xs justify-center">
                                <svg class="checkmark" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                                    <path d="M20 6L9 17l-5-5"></path>
                                </svg>
                                <span>Selected</span>
                            </div>
                        {% else %}
                            <!-- Select Button with Modal Trigger -->
                            <form id="selectForm-{{ return_schedule.id }}" method="POST" action="{% url 'bookingapp:select_schedule' %}" class="hidden">
                                {% csrf_token %}
                                <input type="hidden" name="schedule_id" value="{{ return_schedule.id }}">
                            </form>
                            <button type="button" 
                                    class="w-full bg-[#FFC83D] hover:bg-[#FFC83D]/80 py-1 cursor-pointer rounded-sm select-flight-btn"
                                    data-schedule-id="{{ return_schedule.id }}"
                                    data-flight-type="return"
                                    data-schedule-data='{
                                        "flight_number": "{{ return_schedule.flight.flight_number }}",
                                        "airline": "{{ return_schedule.flight.airline.name }}",
                                        "included_addons": [
                                            {% for addon in return_schedule.included_addons %}
                                            {
                                                "name": "{{ addon.name }}",
                                                "description": "{{ addon.description|default:'' }}"
                                            }{% if not forloop.last %},{% endif %}
                                            {% endfor %}
                                        ]
                                    }'>
                                Select
                            </button>
                        {% endif %}
                    </div>
                    {% endfor %}
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="w-full flex justify-center mt-4">
            <button type="button" class="px-5 py-2 bg-white hover:bg-gray-100 cursor-pointer border border-gray-400">see more..</button>
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}