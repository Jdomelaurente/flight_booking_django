{% extends 'booking/base.html' %}
{% block title %}Passenger Information{% endblock %}

{% block content %}
{% load static %}
<style>
.field-error, .date-error {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.border-red-500 {
    border-color: #ef4444;
}

.passenger-tab.incomplete {
    background-color: #fef2f2;
    color: #dc2626;
    border-left: 8px solid #dc2626;
}

.passenger-tab.complete {
    background-color: #f0f9ff;
    color: #0369a1;
    border-left: 8px solid #0369a1;
}

.form-group {
    margin-bottom: 1rem;
}

.form-label {
    display: block;
    margin-bottom: 0.5rem;
    font-weight: 500;
}

.form-input {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    transition: border-color 0.15s ease-in-out;
}

.form-input:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
}

.form-input.error {
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.1);
}

.form-select {
    width: 100%;
    padding: 0.5rem;
    border: 1px solid #d1d5db;
    border-radius: 0.375rem;
    background-color: white;
}

.date-fields {
    display: flex;
    gap: 1rem;
}

.date-field {
    flex: 1;
}

.checkbox-group {
    display: flex;
    align-items: center;
    gap: 0.5rem;
}

.checkbox-label {
    margin: 0;
    font-size: 0.875rem;
}
</style>

{% if messages %}
<div class="messages">
    {% for message in messages %}
    <div class="alert alert-{{ message.tags }}">
        {{ message }}
    </div>
    {% endfor %}
</div>
{% endif %}

{% if form.errors %}
<div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded">
    <strong>Form errors:</strong>
    <ul>
        {% for field in form %}
            {% for error in field.errors %}
                <li>{{ field.label }}: {{ error }}</li>
            {% endfor %}
        {% endfor %}
        {% for error in form.non_field_errors %}
            <li>{{ error }}</li>
        {% endfor %}
    </ul>
</div>
{% endif %}

<main class="mx-auto flex justify-center relative mt-7 space-y-5 flex-col">
    <!-- Search Summary -->
    <div class="flex-1 mx-auto max-w-[1200px] px-8 bg-[#ECEAEA] flex shadow-md py-4 h-[82px] w-5xl rounded-full justify-between items-center">
        <div class="flex items-center justify-center flex-1 gap-3">
            <div class="flex-1 flex flex-col justify-center">
                <p class="poppins-bold text-base leading-none">MNL</p>
                <p class="text-[#828282] text-xs">Manila</p>
            </div>
            <div class="border-2 h-0 w-10"></div>
            <div class="flex flex-col justify-center">
                <p class="poppins-bold text-base leading-none">BXU</p>
                <p class="text-[#828282] text-xs">Butuan City</p>
            </div>
        </div>

        <div class="flex items-center leading-none justify-center flex-1">
            <div class="flex flex-col justify-center">
                <p class="poppins-bold text-base leading-none">15 May 2025</p>
                <p class="text-[#828282] text-xs">Depart</p>
            </div>
        </div>

        <div class="flex items-center leading-none justify-center flex-1">
            <div class="flex flex-col justify-center">
                <p class="poppins-bold text-base leading-none">30 May 2025</p>
                <p class="text-[#828282] text-xs">Return</p>
            </div>
        </div>

        <div class="flex items-center leading-none justify-center flex-1">
            <div class="flex flex-col justify-center">
                <p class="poppins-bold text-base leading-none">1 Adult</p>
                <p class="text-[#828282] text-xs">Passenger</p>
            </div>
        </div>

        <div class="flex items-center leading-none flex-1">
            <button class="bg-[#2975F7] hover:bg-[#2975F7]/80 text-sm cursor-pointer py-2 px-10 rounded-full text-white">
                Edit search
            </button>
        </div>
    </div>

    <!-- Progress Steps -->
    <div class="bg-[#F4EB08] mx-auto h-[100px] w-[1100px] shadow-md rounded-[20px] flex flex-col">
        <div class="flex justify-between items-center flex-1 mx-20">
            <!-- Progress steps icons would go here -->
        </div>
    </div>

    <!-- Passenger Forms -->
    <div class="flex w-full flex-1 flex-col mx-auto max-w-[1200px] mt-5">
        <div class="flex mx-20">
            <h1 class="text-xl font-bold flex justify-center gap-2 items-center">
                <svg xmlns="http://www.w3.org/2000/svg" width="28" height="28" fill="#2975F7" viewBox="0 0 24 24">
                    <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2M9 8c1.15 0 2 .85 2 2s-.85 2-2 2-2-.85-2-2 .85-2 2-2m-3 8c0-1.66 1.34-3 3-3s3 1.34 3 3zm12-1h-4v-2h4zm0-4h-5V9h5z"/>
                </svg>
                Passenger Information
            </h1>
        </div>

        <form action="{% url 'bookingapp:save_passengers' %}" method="post" id="passenger-form">
            {% csrf_token %}
            
            <div class="flex w-full justify-center items-center mt-5">
                <div class="flex bg-white shadow-md w-[1000px] min-h-[600px]">
                    <!-- Passenger Sidebar -->
                    <div class="w-[200px] bg-gray-100 border-r">
                        {% for passenger in passenger_list %}
                            <div class="passenger-tab py-4 px-3 border-b cursor-pointer transition-colors 
                                       {% if forloop.first %}active bg-white border-l-4 border-[#2975F7]{% endif %}" 
                                 data-passenger="{{ passenger.number }}">
                                <p class="text-sm font-medium">Passenger {{ passenger.number }}</p>
                                <p class="text-xs text-gray-600">{{ passenger.type }}</p>
                                <div class="status-indicator mt-1 text-xs hidden"></div>
                            </div>
                        {% endfor %}
                    </div>

                    <!-- Passenger Forms -->
                    <div class="flex-1 p-8">
                        {% for passenger in passenger_list %}
                        <div class="passenger-form {% if not forloop.first %}hidden{% endif %}" 
                             id="passenger-{{ passenger.number }}" 
                             data-type="{{ passenger.type }}">
                            
                            <div class="mb-6">
                                <h2 class="text-xl font-bold text-gray-900">Passenger {{ passenger.number }} ({{ passenger.type }})</h2>
                                <p class="text-sm text-gray-600 mt-1">
                                    Please ensure names match exactly with your valid government-issued ID
                                </p>
                            </div>

                            {% if passenger.type == "Infant" %}
                            <div class="form-group">
                                <label class="form-label">Accompanying Adult <span class="text-red-500">*</span></label>
                                <select name="infant_adult_{{ passenger.number }}" class="form-select" required>
                                    <option value="" disabled selected>Select accompanying adult</option>
                                    {% for adult_num in passenger.adult_options %}
                                        <option value="{{ adult_num }}">Adult {{ adult_num }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Personal Information -->
                            <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-6">
                                <div class="form-group">
                                    <label class="form-label">Gender <span class="text-red-500">*</span></label>
                                    <select name="gender_{{ passenger.number }}" class="form-select" required>
                                        <option value="" disabled selected>Select gender</option>
                                        <option value="male">Male</option>
                                        <option value="female">Female</option>
                                    </select>
                                </div>

                                <div class="form-group md:col-span-2">
                                    <label class="form-label">First Name <span class="text-red-500">*</span></label>
                                    <input type="text" name="first_name_{{ passenger.number }}" 
                                           placeholder="Juan" class="form-input" required
                                           pattern="[A-Za-z\s]{2,}" title="Please enter a valid first name">
                                </div>

                                <!-- Change this line in your template -->
                                <div class="form-group">
                                    <label class="form-label">Middle Initial</label>
                                    <input type="text" name="mi_{{ passenger.number }}" 
                                        placeholder="L" class="form-input"
                                        maxlength="1" pattern="[A-Za-z]?" title="Optional middle initial (one letter)">
                                </div>

                                <div class="form-group md:col-span-4">
                                    <label class="form-label">Last Name <span class="text-red-500">*</span></label>
                                    <input type="text" name="last_name_{{ passenger.number }}" 
                                           placeholder="Dela Cruz" class="form-input" required
                                           pattern="[A-Za-z\s]{2,}" title="Please enter a valid last name">
                                </div>
                            </div>

                            <!-- Date of Birth -->
                            <div class="form-group mb-6">
                                <h3 class="text-lg font-semibold mb-3">Date of Birth <span class="text-red-500">*</span></h3>
                                <div class="date-fields">
                                    <div class="date-field">
                                        <label class="form-label">Day</label>
                                        <select name="dob_day_{{ passenger.number }}" class="form-select" required>
                                            <option value="" disabled selected>Day</option>
                                            {% for day in "x"|rjust:"31" %}
                                                <option value="{{ forloop.counter }}">{{ forloop.counter }}</option>
                                            {% endfor %}
                                        </select>
                                    </div>
                                    
                                    <div class="date-field">
                                        <label class="form-label">Month</label>
                                        <select name="dob_month_{{ passenger.number }}" class="form-select" required>
                                            <option value="" disabled selected>Month</option>
                                            <option value="1">January</option>
                                            <option value="2">February</option>
                                            <option value="3">March</option>
                                            <option value="4">April</option>
                                            <option value="5">May</option>
                                            <option value="6">June</option>
                                            <option value="7">July</option>
                                            <option value="8">August</option>
                                            <option value="9">September</option>
                                            <option value="10">October</option>
                                            <option value="11">November</option>
                                            <option value="12">December</option>
                                        </select>
                                    </div>
                                    
                                    <div class="date-field">
                                        <label class="form-label">Year</label>
                                        <select name="dob_year_{{ passenger.number }}" class="form-select" required>
                                            <option value="" disabled selected>Year</option>
                                        </select>
                                    </div>
                                </div>
                                <div class="age-validation mt-2 text-sm hidden"></div>
                            </div>

                            <!-- Passport & Nationality -->
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                <div class="form-group">
                                    <label class="form-label">Passport Number <span class="text-red-500">*</span></label>
                                    <input type="text" name="passport_{{ passenger.number }}" 
                                           placeholder="DASD4D44ASD" class="form-input uppercase" required
                                           pattern="[A-Z0-9]{5,}" title="Please enter a valid passport number">
                                </div>

                                <div class="form-group">
                                    <label class="form-label">Nationality <span class="text-red-500">*</span></label>
                                    <input type="text" name="nationality_{{ passenger.number }}" 
                                           placeholder="Philippines" class="form-input" required
                                           pattern="[A-Za-z\s]{3,}" title="Please enter a valid nationality">
                                </div>
                            </div>

                            <!-- Additional Options -->
                            <div class="form-group space-y-3">
                                <div class="checkbox-group">
                                    <input type="checkbox" name="declaration_{{ passenger.number }}" 
                                           id="declaration_{{ passenger.number }}" class="form-checkbox">
                                    <label for="declaration_{{ passenger.number }}" class="checkbox-label">
                                        I have a declaration / special request
                                    </label>
                                </div>
                                
                                <div class="checkbox-group">
                                    <input type="checkbox" name="pwd_{{ passenger.number }}" 
                                           id="pwd_{{ passenger.number }}" class="form-checkbox">
                                    <label for="pwd_{{ passenger.number }}" class="checkbox-label">
                                        I am a Person with Disability
                                    </label>
                                </div>
                            </div>

                            <!-- Navigation -->
                            <div class="flex justify-between items-center mt-8 pt-6 border-t">
                                {% if not forloop.first %}
                                <button type="button" class="prev-passenger-btn flex items-center gap-2 text-[#2975F7] hover:text-[#2975F7]/80 font-medium">
                                    <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="currentColor">
                                        <path d="M15.41 7.41L14 6l-6 6 6 6 1.41-1.41L10.83 12z"/>
                                    </svg>
                                    Previous Passenger
                                </button>
                                {% else %}
                                <div></div>
                                {% endif %}

                                {% if not forloop.last %}
                                <button type="button" class="next-passenger-btn bg-[#2975F7] hover:bg-[#2975F7]/90 text-white px-6 py-2 rounded-full font-medium transition-colors">
                                    Next Passenger
                                </button>
                                {% else %}
                                <button type="submit" class="confirm-btn bg-green-600 hover:bg-green-700 text-white px-8 py-2 rounded-full font-medium transition-colors">
                                    Confirm & Continue
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>

            <!-- Contact Information -->
            <div class="flex w-full justify-center items-center mt-10">
                <div class="flex bg-white flex-col shadow-md w-[1000px] px-8 py-8">
                    <h2 class="text-xl font-bold mb-2">Contact Information</h2>
                    <p class="text-sm text-gray-600 mb-6">
                        We'll use this to contact you about changes to your booking and send your itinerary.
                    </p>

                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
                        <div class="form-group">
                            <label class="form-label">First Name <span class="text-red-500">*</span></label>
                            <input type="text" name="f_name_contact" value="{{ student.first_name }}" 
                                   {% if student %}readonly{% endif %} class="form-input" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Last Name <span class="text-red-500">*</span></label>
                            <input type="text" name="l_name_contact" value="{{ student.last_name }}" 
                                   {% if student %}readonly{% endif %} class="form-input" required>
                        </div>

                        {% comment %} <div class="form-group">
                            <label class="form-label">Middle Initial</label>
                            <input type="text" name="m_name_contact" class="form-input uppercase"
                                   maxlength="1" pattern="[A-Z]">
                        </div> {% endcomment %}
                    </div>

                    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                        <div class="form-group">
                            <label class="form-label">Mobile Number <span class="text-red-500">*</span></label>
                            <input type="tel" name="number_contact" value="{{ student.phone }}" 
                                   {% if student %}readonly{% endif %} class="form-input" 
                                   pattern="[0-9]{10,}" placeholder="09171234567" required>
                        </div>

                        <div class="form-group">
                            <label class="form-label">Email Address <span class="text-red-500">*</span></label>
                            <input type="email" name="email_contact" value="{{ student.email }}" 
                                   {% if student %}readonly{% endif %} class="form-input" 
                                   placeholder="juan.delacruz@example.com" required>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Terms and Conditions -->
            <div class="flex w-full justify-center items-center mt-7">
                <div class="flex bg-white flex-col shadow-md w-[1000px] px-8 py-6">
                    <div class="checkbox-group">
                        <input type="checkbox" id="terms_accept" required class="form-checkbox">
                        <label for="terms_accept" class="checkbox-label">
                            I confirm that I have read, understood, and agree to the updated 
                            <a href="#" class="text-[#2975F7] hover:underline">Privacy Policy</a>. 
                            I consent to the collection, use, processing and sharing of my personal information.
                        </label>
                    </div>
                </div>
            </div>

            <!-- Submit Button -->
            <div class="flex w-full justify-center items-center mt-6">
                <div class="flex justify-end w-[1000px]">
                    <button type="submit" id="submit-btn" class="bg-[#2975F7] hover:bg-[#2975F7]/90 text-white px-12 py-3 rounded-full font-medium text-lg transition-colors">
                        Confirm Passenger Details
                    </button>
                </div>
            </div>
        </form>
    </div>
</main>

<script>
document.addEventListener('DOMContentLoaded', function() {
    // Initialize the form
    initPassengerForm();
});

function initPassengerForm() {
    const passengerForms = document.querySelectorAll('.passenger-form');
    const passengerTabs = document.querySelectorAll('.passenger-tab');
    let currentPassenger = 1;
    let validationEnabled = false;

    // Initialize year dropdowns
    initYearDropdowns();

    // Setup event listeners
    setupEventListeners();

    function initYearDropdowns() {
        const currentYear = new Date().getFullYear();
        document.querySelectorAll('select[name^="dob_year_"]').forEach(select => {
            // Clear existing options except the first one
            while (select.options.length > 1) {
                select.remove(1);
            }
            
            for (let year = currentYear; year >= 1900; year--) {
                const option = document.createElement('option');
                option.value = year;
                option.textContent = year;
                select.appendChild(option);
            }
        });
    }

    function setupEventListeners() {
        // Passenger tab clicks
        passengerTabs.forEach(tab => {
            tab.addEventListener('click', () => {
                const passengerNum = parseInt(tab.dataset.passenger);
                if (validationEnabled && passengerNum > currentPassenger) {
                    // Don't allow skipping ahead if validation is enabled
                    return;
                }
                showPassenger(passengerNum);
            });
        });

        // Next passenger buttons
        document.querySelectorAll('.next-passenger-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                validateAndProceed(currentPassenger, currentPassenger + 1);
            });
        });

        // Previous passenger buttons
        document.querySelectorAll('.prev-passenger-btn').forEach(btn => {
            btn.addEventListener('click', () => {
                showPassenger(currentPassenger - 1);
            });
        });

        // Real-time validation
        setupRealTimeValidation();

        // Form submission
        document.getElementById('passenger-form').addEventListener('submit', function(e) {
            console.log('Form submission attempted');
            
            // Show loading state
            const submitBtn = document.getElementById('submit-btn');
            const originalText = submitBtn.innerHTML;
            submitBtn.innerHTML = 'Processing...';
            submitBtn.disabled = true;
            
            // Validate all passengers
            if (!validateAllPassengers()) {
                e.preventDefault();
                showNotification('Please fix all validation errors before submitting.', 'error');
                
                // Restore button state
                submitBtn.innerHTML = originalText;
                submitBtn.disabled = false;
                
                // Show which passengers are invalid
                const invalidPassengers = [];
                passengerForms.forEach((form, index) => {
                    const passengerNum = index + 1;
                    if (!validatePassenger(passengerNum)) {
                        invalidPassengers.push(passengerNum);
                    }
                });
                
                console.log('Invalid passengers:', invalidPassengers);
                showNotification(`Please complete passenger(s): ${invalidPassengers.join(', ')}`, 'error');
            } else {
                console.log('Form validation passed, submitting...');
                // Form will submit normally - button will stay in loading state
            }
        });
    }

    function showPassenger(passengerNum) {
        // Hide all forms
        passengerForms.forEach(form => form.classList.add('hidden'));
        
        // Show selected form
        const targetForm = document.getElementById(`passenger-${passengerNum}`);
        if (targetForm) {
            targetForm.classList.remove('hidden');
        }

        // Update tabs
        passengerTabs.forEach(tab => {
            tab.classList.remove('active', 'bg-white', 'border-l-4', 'border-[#2975F7]');
        });

        const targetTab = document.querySelector(`[data-passenger="${passengerNum}"]`);
        if (targetTab) {
            targetTab.classList.add('active', 'bg-white', 'border-l-4', 'border-[#2975F7]');
        }

        currentPassenger = passengerNum;
        updateNavigation();
    }

    function validateAndProceed(current, next) {
        validationEnabled = true;
        
        if (validatePassenger(current)) {
            markPassengerComplete(current);
            showPassenger(next);
        } else {
            markPassengerIncomplete(current);
            showNotification('Please fix the validation errors before proceeding.', 'error');
        }
    }

    function validatePassenger(passengerNum) {
        const form = document.getElementById(`passenger-${passengerNum}`);
        
        if (!form) {
            console.error(`Form for passenger ${passengerNum} not found`);
            return false;
        }
        
        let isValid = true;

        // Clear previous errors
        clearErrors(form);

        // Validate required fields
        const requiredFields = form.querySelectorAll('[required]');
        requiredFields.forEach(field => {
            if (!field.value.trim()) {
                console.log(`Required field empty: ${field.name}`);
                showFieldError(field, 'This field is required');
                isValid = false;
            }
        });

        // Validate name fields - only if they exist and have values
        const firstName = form.querySelector('[name^="first_name_"]');
        const lastName = form.querySelector('[name^="last_name_"]');
        
        if (firstName && firstName.value.trim() && !isValidName(firstName.value)) {
            showFieldError(firstName, 'Please enter a valid first name (letters only, min 2 characters)');
            isValid = false;
        }

        if (lastName && lastName.value.trim() && !isValidName(lastName.value)) {
            showFieldError(lastName, 'Please enter a valid last name (letters only, min 2 characters)');
            isValid = false;
        }

        // Validate date of birth
        try {
            if (!validateDateOfBirth(passengerNum)) {
                isValid = false;
            }
        } catch (error) {
            console.error('Date validation error:', error);
            isValid = false;
        }

        // Validate passport - only if it exists and has value
        const passport = form.querySelector('[name^="passport_"]');
        if (passport && passport.value.trim() && !isValidPassport(passport.value)) {
            showFieldError(passport, 'Please enter a valid passport number (min 5 alphanumeric characters)');
            isValid = false;
        }

        // Validate nationality - only if it exists and has value
        const nationality = form.querySelector('[name^="nationality_"]');
        if (nationality && nationality.value.trim() && !isValidName(nationality.value)) {
            showFieldError(nationality, 'Please enter a valid nationality');
            isValid = false;
        }

        // Special validation for infants
        if (form.dataset.type === 'Infant') {
            const adultSelect = form.querySelector('[name^="infant_adult_"]');
            if (adultSelect && !adultSelect.value) {
                showFieldError(adultSelect, 'Please select an accompanying adult');
                isValid = false;
            }
        }

        return isValid;
    }

    // ADD THE MISSING VALIDATE DATE OF BIRTH FUNCTION
    function validateDateOfBirth(passengerNum) {
        const daySelect = document.querySelector(`[name="dob_day_${passengerNum}"]`);
        const monthSelect = document.querySelector(`[name="dob_month_${passengerNum}"]`);
        const yearSelect = document.querySelector(`[name="dob_year_${passengerNum}"]`);

        if (!daySelect || !monthSelect || !yearSelect) {
            console.error(`Date fields not found for passenger ${passengerNum}`);
            return false;
        }

        const day = daySelect.value;
        const month = monthSelect.value;
        const year = yearSelect.value;

        if (!day || !month || !year) {
            return false;
        }

        try {
            // Basic date validation
            const birthDate = new Date(year, month - 1, day);
            const today = new Date();
            
            // Check if date is valid
            if (isNaN(birthDate.getTime())) {
                showDateError(passengerNum, 'Please select a valid date');
                return false;
            }
            
            if (birthDate > today) {
                showDateError(passengerNum, 'Date of birth cannot be in the future');
                return false;
            }

            // Age validation based on passenger type
            const form = document.getElementById(`passenger-${passengerNum}`);
            const passengerType = form.dataset.type;
            const age = calculateAge(birthDate, today);

            if (!validateAgeForPassengerType(age, passengerType)) {
                showDateError(passengerNum, getAgeErrorMessage(age, passengerType));
                return false;
            }

            return true;
        } catch (error) {
            console.error('Date validation error:', error);
            showDateError(passengerNum, 'Invalid date selected');
            return false;
        }
    }

    function calculateAge(birthDate, today) {
        let years = today.getFullYear() - birthDate.getFullYear();
        let months = today.getMonth() - birthDate.getMonth();
        let days = today.getDate() - birthDate.getDate();

        if (days < 0) {
            months--;
            days += new Date(today.getFullYear(), today.getMonth(), 0).getDate();
        }

        if (months < 0) {
            years--;
            months += 12;
        }

        return { years, months, days };
    }

    function validateAgeForPassengerType(age, type) {
        switch (type) {
            case 'Adult':
                return age.years >= 18;
            case 'Child':
                return age.years >= 2 && age.years < 12;
            case 'Infant':
                return age.years < 2 || (age.years === 2 && age.months === 0 && age.days === 0);
            default:
                return true;
        }
    }

    function getAgeErrorMessage(age, type) {
        const ageText = `${age.years} years, ${age.months} months`;
        
        switch (type) {
            case 'Adult':
                return `Adults must be 18 years or older. Passenger is ${ageText}`;
            case 'Child':
                return `Children must be 2-11 years old. Passenger is ${ageText}`;
            case 'Infant':
                return `Infants must be under 2 years old. Passenger is ${ageText}`;
            default:
                return 'Invalid age for passenger type';
        }
    }

    function isValidName(name) {
        return /^[A-Za-z\s]{2,}$/.test(name);
    }

    function isValidPassport(passport) {
        return /^[A-Z0-9]{5,}$/.test(passport);
    }

    function showFieldError(field, message) {
        field.classList.add('error');
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'field-error text-red-500 text-xs mt-1';
        errorDiv.textContent = message;
        
        field.parentNode.appendChild(errorDiv);
    }

    function showDateError(passengerNum, message) {
        const form = document.getElementById(`passenger-${passengerNum}`);
        if (!form) return;
        
        const dateSection = form.querySelector('.date-fields');
        if (!dateSection) return;
        
        const errorDiv = document.createElement('div');
        errorDiv.className = 'date-error text-red-500 text-sm mt-2 font-medium';
        errorDiv.textContent = message;
        
        dateSection.parentNode.appendChild(errorDiv);
    }

    function clearErrors(form) {
        if (!form) {
            console.warn('clearErrors: form is null');
            return;
        }
        
        // Remove error classes from fields
        const errorFields = form.querySelectorAll('.error');
        if (errorFields) {
            errorFields.forEach(field => field.classList.remove('error'));
        }
        
        // Remove field error messages
        const fieldErrors = form.querySelectorAll('.field-error');
        if (fieldErrors) {
            fieldErrors.forEach(error => error.remove());
        }
        
        // Remove date error messages
        const dateErrors = form.querySelectorAll('.date-error');
        if (dateErrors) {
            dateErrors.forEach(error => error.remove());
        }
    }

    function markPassengerComplete(passengerNum) {
        const tab = document.querySelector(`[data-passenger="${passengerNum}"]`);
        if (!tab) return;
        
        const status = tab.querySelector('.status-indicator');
        if (!status) return;
        
        status.textContent = '✓ Complete';
        status.className = 'status-indicator mt-1 text-xs text-green-600';
        status.classList.remove('hidden');
        
        tab.classList.add('complete');
        tab.classList.remove('incomplete');
    }

    function markPassengerIncomplete(passengerNum) {
        const tab = document.querySelector(`[data-passenger="${passengerNum}"]`);
        if (!tab) return;
        
        const status = tab.querySelector('.status-indicator');
        if (!status) return;
        
        status.textContent = '✗ Incomplete';
        status.className = 'status-indicator mt-1 text-xs text-red-600';
        status.classList.remove('hidden');
        
        tab.classList.add('incomplete');
        tab.classList.remove('complete');
    }

    function setupRealTimeValidation() {
        // Add input event listeners for real-time validation
        document.querySelectorAll('.form-input, .form-select').forEach(field => {
            field.addEventListener('blur', function() {
                if (validationEnabled) {
                    const fieldName = this.getAttribute('name');
                    if (fieldName && fieldName.includes('_')) {
                        const passengerNum = fieldName.split('_').pop();
                        validatePassenger(passengerNum);
                    }
                }
            });
        });
    }

    function validateAllPassengers() {
        validationEnabled = true;
        let allValid = true;

        console.log('=== Starting validation for all passengers ===');
        
        // Show all forms temporarily for validation
        passengerForms.forEach(form => form.classList.remove('hidden'));
        
        try {
            passengerForms.forEach((form, index) => {
                const passengerNum = index + 1;
                console.log(`Validating passenger ${passengerNum}`);
                
                const isValid = validatePassenger(passengerNum);
                console.log(`Passenger ${passengerNum} valid: ${isValid}`);
                
                if (!isValid) {
                    allValid = false;
                    markPassengerIncomplete(passengerNum);
                    
                    // Show first invalid passenger
                    if (allValid === false) {
                        showPassenger(passengerNum);
                        // Scroll to the first error
                        const firstError = form.querySelector('.error');
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                    }
                } else {
                    markPassengerComplete(passengerNum);
                }
            });

            // Restore the current passenger view
            showPassenger(currentPassenger);
            
            console.log('All passengers valid:', allValid);
            return allValid;
        } catch (error) {
            console.error('Validation error:', error);
            showNotification('There was an error validating the form. Please check all fields.', 'error');
            return false;
        }
    }

    function updateNavigation() {
        // Update button states based on current passenger
        // This can be expanded to show/hide buttons based on passenger position
    }

    function showNotification(message, type) {
        // Remove existing notifications
        const existingNotification = document.querySelector('.custom-notification');
        if (existingNotification) {
            existingNotification.remove();
        }
        
        // Create notification element
        const notification = document.createElement('div');
        notification.className = `custom-notification fixed top-4 right-4 p-4 rounded-lg shadow-lg z-50 ${
            type === 'error' ? 'bg-red-500 text-white' : 'bg-green-500 text-white'
        }`;
        notification.textContent = message;
        
        document.body.appendChild(notification);
        
        // Auto remove after 5 seconds
        setTimeout(() => {
            notification.remove();
        }, 5000);
    }

    // Initialize first passenger
    showPassenger(1);

    // Debug functions
    function debugValidation() {
        console.log('=== DEBUG VALIDATION ===');
        
        passengerForms.forEach((form, index) => {
            const passengerNum = index + 1;
            console.log(`\nPassenger ${passengerNum}:`);
            
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                console.log(`${field.name}: "${field.value}" - Valid: ${field.value.trim() !== ''}`);
            });
            
            // Check date fields
            const day = document.querySelector(`[name="dob_day_${passengerNum}"]`)?.value;
            const month = document.querySelector(`[name="dob_month_${passengerNum}"]`)?.value;
            const year = document.querySelector(`[name="dob_year_${passengerNum}"]`)?.value;
            console.log(`Date: ${day}/${month}/${year}`);
        });
    }

    function debugFormState() {
        console.log('=== FORM DEBUG INFO ===');
        console.log('Current passenger:', currentPassenger);
        console.log('Total passengers:', passengerForms.length);
        
        passengerForms.forEach((form, index) => {
            const passengerNum = index + 1;
            console.log(`\nPassenger ${passengerNum} (${form.dataset.type}):`);
            console.log('Visible:', !form.classList.contains('hidden'));
            
            const requiredFields = form.querySelectorAll('[required]');
            requiredFields.forEach(field => {
                console.log(`  ${field.name}: "${field.value}"`);
            });
        });
    }

    // Make debug functions available globally
    window.debugValidation = debugValidation;
    window.debugFormState = debugFormState;
}
</script>
{% endblock %}