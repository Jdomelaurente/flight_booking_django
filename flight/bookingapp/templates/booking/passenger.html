{% extends 'booking/base.html' %}
{% block title %} Select a Flight Schedule
{% endblock %}

{% block content %}
{% load static %}
<style>
.field-error, .date-error {
    animation: fadeIn 0.3s ease-in;
}

@keyframes fadeIn {
    from { opacity: 0; transform: translateY(-5px); }
    to { opacity: 1; transform: translateY(0); }
}

.border-red-500 {
    border-color: #ef4444;
}
</style>

    <main class=" mx-auto  flex justify-center relative mt-7 space-y-5 flex-col ">
        <!-- edit search  -->
        <div class="flex-1 mx-auto max-w-[1200px] px-8 bg-[#ECEAEA] flex  shadow-md/50  py-4 h-[82px]  w-5xl rounded-full justify-between items-center">

            <!-- from -->
            <div class="flex items-center justify-center flex-1 gap-3  ">
                <div class=" flex-1 flex flex-col justify-center  ">
                    <p class="poppins-bold first-of-type: text-base leading-none ">MNL</p>
                    <p class="text-[#828282] text-xs">Manila</p>
                </div>
                <div class="border-2 h-0 w-10"></div>
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold   text-base leading-none ">BXU</p>
                    <p class="text-[#828282] text-xs">Butuan City</p>
                </div>
            </div>

            <!-- depart -->
            <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-base leading-none">15 May 2025</p>
                    <p class="text-[#828282] text-xs">Depart</p>
                </div>

            </div>
            <!-- return -->
            <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-base leading-none ">30 May 2025</p>
                    <p class="text-[#828282] text-xs">Return</p>
                </div>
            </div>    
               

            <!-- passenger -->
           <div class="flex items-center leading-none  justify-center   flex-1">
                <div class="  flex flex-col justify-center ">
                    <p class="poppins-bold text-base leading-none">1 Adult</p>
                    <p class="text-[#828282] text-xs">Passenger</p>
                </div>
            </div>
            <div class="flex items-center leading-none  flex-1">
                <button class="bg-[#2975F7] hover:bg-[#2975F7]/80 text-sm cursor-pointer py-2 px-10 rounded-full text-white">Edit search</button>
            </div>
        </div>


        <!-- stepbystep -->
       <div class="bg-[#F4EB08]  mx-auto h-[100px] w-[1100px] shadow-md/50 rounded-[20px] flex flex-col">
            <!-- arrow  -->
            <div class="flex justify-between items-center flex-1 mx-20">
                <div class="   rounded-full p-1 border border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <path d="m17.54,3.64l-2.9,2.9-9.88-1.16c-.15-.02-.3.03-.41.14l-.59.59c-.24.24-.17.66.14.8l7.01,3.36-3.25,3.25-3.27-.65c-.16-.03-.33.02-.45.14l-.7.7c-.25.25-.17.67.16.81l4.27,1.83,1.83,4.27c.14.33.56.41.81.16l.7-.7c.12-.12.17-.29.14-.45l-.65-3.27,3.31-3.31,3.31,7.06c.15.31.56.39.81.14l.66-.66c.11-.11.16-.26.14-.41l-1.16-9.88,2.75-2.75c.7-.7.88-1.84.29-2.65-.74-1.03-2.19-1.12-3.05-.26Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border text-white"></div>

                <div class="   rounded-full p-1 border border-[#2975F7]">
                   <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m19,2H5c-.55,0-1,.45-1,1v4h-2v2h2v2h-2v2h2v2h-2v2h2v4c0,.55.45,1,1,1h14c1.1,0,2-.9,2-2V4c0-1.1-.9-2-2-2Zm-6.5,5c1.43,0,2.5,1.07,2.5,2.5s-1.07,2.5-2.5,2.5-2.5-1.07-2.5-2.5,1.07-2.5,2.5-2.5Zm4.5,10h-9v-1c0-1.66,1.34-3,3-3h3c1.66,0,3,1.34,3,3v1Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border text-white"></div>

                <div class="   rounded-full p-1 border border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"   class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2m-2 10h-4v4h-2v-4H7v-2h4V7h2v4h4z"></path>
                    </svg>
                </div>

                <div class="flex-1 border text-white"></div>

                <div class="   rounded-full p-1 border border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m4,5v4h2v-4h4v-2h-4c-1.1,0-2,.9-2,2Z"></path><path d="m6,15h-2v4c0,1.1.9,2,2,2h4v-2h-4v-4Z"></path><path d="m20,19h-4v2h4c1.1,0,2-.9,2-2v-4h-2v4Z"></path><path d="m16,3v2h4v4h2v-4c0-1.1-.9-2-2-2h-4Z"></path><path d="M8 15H18V17H8z"></path><path d="M18 7 8 7 8 11 3 11 3 13 8 13 18 13 23 13 23 11 18 11 18 7z"></path>
                    </svg>
                </div>

                <div class="flex-1 border text-white"></div>

                <div class="   rounded-full p-1 border border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"  class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="m21,7h-1v-3c0-.55-.45-1-1-1H5c-1.65,0-3,1.35-3,3v12c0,2.2,1.79,3,3,3h16c.55,0,1-.45,1-1v-12c0-.55-.45-1-1-1Zm-3,9h-2v-4h2v4ZM5,5h13v2H5c-.55,0-1-.45-1-1s.45-1,1-1Z"></path>
                    </svg>
                </div>

                <div class="flex-1 border text-white"></div>

                <div class="   rounded-full p-1 border border-[#2975F7]">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="22" height="22"   class="bg-[#2975F7] p-1 rounded-full"
                        fill="white" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="M12 2C6.49 2 2 6.49 2 12s4.49 10 10 10 10-4.49 10-10S17.51 2 12 2m-1.29 13.71c-.2.2-.45.29-.71.29s-.51-.1-.71-.29l-3-3L7.7 11.3l2.29 2.29 5.29-5.29 1.41 1.41-6 6Z"></path>
                    </svg>
                </div>

            </div>

            <!-- label  -->
             <div></div>

        </div>

        <div class="flex w-full flex-1 flex-col mx-auto max-w-[1200px] mt-5 ">
            <div class="flex mx-20 ">
                <h1 class="text-xl  font-bold flex justify-center gap-2 items-center">
                    <svg  xmlns="http://www.w3.org/2000/svg" width="28" height="28"  
                        fill="#NaNNaNNaN" viewBox="0 0 24 24" >
                        <!--Boxicons v3.0 https://boxicons.com | License  https://docs.boxicons.com/free-->
                        <path d="M20 4H4c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h16c1.1 0 2-.9 2-2V6c0-1.1-.9-2-2-2M9 8c1.15 0 2 .85 2 2s-.85 2-2 2-2-.85-2-2 .85-2 2-2m-3 8c0-1.66 1.34-3 3-3s3 1.34 3 3zm12-1h-4v-2h4zm0-4h-5V9h5z"></path>
                    </svg>
                    Passenger Information</h1>
            </div>

        <form  action="{% url 'bookingapp:save_passengers' %}"  method="post">
        {% csrf_token  %}
            <div class="flex w-full justify-center items-center mt-5">
                <div class="flex bg-white shadow-md/50 w-[1000px] ">

                    <!-- passenger sidebar -->
                    <div class="w-[200px] bg-gray-200">
                        {% for passenger in passenger_list %}
                            <div class="py-5 flex justify-center passenger-tab cursor-pointer {% if forloop.first %}bg-white border-l-8 border-[#2975F7] z-10{% endif %}" 
                                data-passenger="{{ passenger.number }}">
                                <p class="text-xs">Passenger {{ passenger.number }} ({{ passenger.type }})</p>
                                <span class="passenger-warning text-red-500 text-xs hidden mt-1"></span>
                            </div>

                        {% endfor %}

                    </div>

                    <!-- passenger forms -->
                    <div class="w-full mx-20 py-15">
                        {% for passenger in passenger_list %}
                        <div class="passenger-form transition-opacity duration-300 {% if not forloop.first %}hidden{% else %}block{% endif %}" 
                        id="passenger-form-{{ passenger.number }}" data-type="{{ passenger.type }}">

                            <h1 class="text-lg font-bold">Passenger {{ passenger.number }} ({{ passenger.type }})</h1>
                            <p class="text-xs text-gray-500">
                                Please make sure that you enter your name exactly as it is shown on your Valid ID
                            </p>

                            {% if passenger.type == "Infant" %}
                            <div class="flex flex-col mt-5 w-[200px]">
                                <label class="text-sm flex">Accompanying Adult <p class="text-red-500">*</p></label>
                                <select name="infant_adult_{{ passenger.number }}" class="border py-2 px-1">
                                    <option hidden></option>
                                    {% for adult_num in passenger.adult_options %}
                                        <option value="{{ adult_num }}">Adult {{ adult_num }}</option>
                                    {% endfor %}
                                </select>
                            </div>
                            {% endif %}

                            <!-- Name fields -->
                            <div class="flex mt-5 justify-between space-x-5">
                                <div class="flex-1 flex flex-col max-w-[100px]">
                                    <label class="text-sm flex">Gender <p class="text-red-500">*</p></label>
                                    
                                    <select id="" name="gender_{{ passenger.number }}" class="border py-2 px-1">
                                        <option value="" hidden> </option>
                                        <option value="male">male</option>
                                        <option value="female">female</option>
                                    </select>
                                </div>
                                <div class="flex-1 flex flex-col">
                                    <label class="text-sm flex">First name <p class="text-red-500">*</p></label>
                                    <input type="text" name="first_name_{{ passenger.number }}" placeholder="Juan" class="border py-2 px-1">

                                </div>
                                <div class="flex-1 flex flex-col">
                                    <label class="text-sm flex">Last name <p class="text-red-500">*</p></label>
                                    <input type="text" name="last_name_{{ passenger.number }}" placeholder="Dela Cruz" class="border py-2 px-1">

                                </div>
                                <div class="flex-1 flex flex-col max-w-[100px]">
                                    <label class="text-sm flex">M.I.</label>
                                    <input type="text" name="mi_{{ passenger.number }}" placeholder="L" class="border py-2 px-1">

                                </div>
                            </div>

                            <!-- DOB -->
                            <div class="flex mt-5 flex-col">
                                <h1 class="text-lg font-medium">Date of Birth</h1>
                                <div class="flex-1 flex space-x-10 w-full">
                                    <div class="flex-1 flex space-x-5">
                                        <div class="flex flex-col w-[120px]">
                                            <label class="text-sm flex">Day <p class="text-red-500">*</p></label>
                                            <!-- <input type="text"  placeholder="30" class="border py-2 px-1"> -->
                                            <select name="dob_day_{{ passenger.number }}" id=""  class="border py-2 px-1">
                                                <option hidden></option>
                                                <option value="1">1</option>
                                                <option value="2">2</option>
                                                <option value="3">3</option>
                                                <option value="4">4</option>
                                                <option value="5">5</option>
                                                <option value="6">6</option>
                                                <option value="7">7</option>
                                                <option value="8">8</option>
                                                <option value="9">9</option>
                                                <option value="10">10</option>
                                                <option value="11">11</option>
                                                <option value="12">12</option>
                                                <option value="13">13</option>
                                                <option value="14">14</option>
                                                <option value="15">15</option>
                                                <option value="16">16</option>
                                                <option value="17">17</option>
                                                <option value="18">18</option>
                                                <option value="19">19</option>
                                                <option value="20">20</option>
                                                <option value="21">21</option>
                                                <option value="22">22</option>
                                                <option value="23">23</option>
                                                <option value="24">24</option>
                                                <option value="25">25</option>
                                                <option value="26">26</option>
                                                <option value="27">27</option>
                                                <option value="28">28</option>
                                                <option value="29">29</option>
                                                <option value="30">30</option>
                                                <option value="31">31</option>
                                            </select>
                                            
                                        </div>
                                        <div class="flex flex-col w-[120px]">
                                            <label class="text-sm flex">Month <p class="text-red-500">*</p></label>
                                            <select name="dob_month_{{  passenger.number }}" class="border py-2 px-1">
                                                <option hidden></option>
                                                <option value="1">Jan</option>
                                                <option value="2">Feb</option>
                                                <option value="3">Mar</option>
                                                <option value="4">Apr</option>
                                                <option value="5">May</option>
                                                <option value="6">Jun</option>
                                                <option value="7">Jul</option>
                                                <option value="8">Aug</option>
                                                <option value="9">Sep</option>
                                                <option value="10">Oct</option>
                                                <option value="11">Nov</option>
                                                <option value="12">Dec</option>
                                            </select>
                                        </div>
                                        <div class="flex flex-col w-[120px]">
                                            <label class="text-sm flex">Year <p class="text-red-500">*</p></label>
                                            <select id="dob-year-{{ passenger }}" name="dob_year_{{  passenger.number }}" class="border py-2 px-1">
                                                <option hidden></option>
                                            </select>

                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Passport + Nationality -->
                            <div class="flex-1 flex mt-5 space-x-5">
                                <div class="flex flex-col flex-1">
                                    <label class="text-sm flex">Passport <p class="text-red-500">*</p></label>
                                    <input type="text" name="passport_{{  passenger.number }}" placeholder="DASD4D44ASD" class="border py-2 px-1">
                                </div>
                                <div class="flex flex-col flex-1">
                                    <label class="text-sm flex">Nationality <p class="text-red-500">*</p></label>
                                    <input type="text" name="nationality_{{  passenger.number }}" placeholder="Philippines" class="border py-2 px-1">
                                </div>
                            </div>

                            <!-- Checkboxes -->
                            <div class="flex-1 flex flex-col mt-5 space-x-5">
                                <div class="flex gap-2 flex-1">
                                    <input type="checkbox" name="declaration_{{  passenger.number }}">
                                    <label class="text-xs">I have a declaration / request</label>
                                </div>
                                <div class="flex gap-2 flex-1">
                                    <input type="checkbox" name="pwd_{{  passenger.number }}">
                                    <label class="text-xs">I am a Person with Disability</label>
                                </div>
                            </div>

                            <!-- Next passenger button -->
                            <div class="flex-1 flex flex-col mt-5 items-end space-x-5">
                                {% if not forloop.last %}
                                <button type="button" class="next-passenger shadow-sm/20 hover:bg-gray-100 flex items-center py-1 px-5 text-[#2975F7] hover:text-[#2975F7]/80 rounded-full cursor-pointer justify-center gap-2" data-current="{{ passenger.number }}">
                                    Next passenger
                                    <svg xmlns="http://www.w3.org/2000/svg" width="22" height="22" fill="#2975F7" viewBox="0 0 22 22">
                                        <path d="M6 13h8.09l-3.3 3.29 1.42 1.42 5.7-5.71-5.7-5.71-1.42 1.42 3.3 3.29H6z"></path>
                                    </svg>
                                </button>
                                {% endif %}
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                </div>
            </div>
        


            <!-- contact -->
            <div class="flex  w-full justify-center items-center mt-10 " >
                <div class="flex bg-white flex-col shadow-md/50 w-[1000px] px-10 py-10 ">
                    <h1 class="font-bold text-lg">Contact information</h1>
                    <p class="text-xs text-gray-500">Let us know how we may reach you if there are changes or questions related to your booking and payment. We will also be sending your itinerary to below email.</p>

                    <div class="flex mt-5 justify-between space-x-5 mx-15">
                        <div class="flex-1 flex flex-col ">
                            <label for="" class="text-sm flex">First name <p class="text-red-500">*</p></label>
                            <input type="text" placeholder="JUan" name="f_name_contact" value="{{ student.first_name }}" {% if student %}readonly{% endif %} class="border py-2 px-1">
                        </div>
                        <div class="flex-1 flex flex-col ">
                            <label for="" class="text-sm flex">Last name <p class="text-red-500">*</p></label>
                            <input type="text" placeholder="Delata" name="l_name_contact" value="{{ student.last_name }}" {% if student %}readonly{% endif %} class="border py-2 px-1">
                        </div>
                        <div class="flex-1 flex flex-col max-w-[100px]">
                            <label for="" class="text-sm flex">M.I. </label>
                            <input type="text" placeholder="L" name="m_name_contact" class="border py-2 px-1">
                        </div>
                        
                    </div>

                    <div class="flex mt-5  space-x-5 mx-15">
                        <!-- <div class="flex-1 flex flex-col max-w-[100px]">
                            <label for="" class="text-sm flex">Country Code <p class="text-red-500">*</p></label>
                            <input type="text" placeholder="ex. Mr/Mrs" class="border py-2 px-3" value="(+63)">
                        </div> -->
                        <div class="flex-1 flex flex-col">
                            <label for="" class="text-sm flex">Mobile Number <p class="text-red-500">*</p></label>
                            <input type="text" placeholder="099xxxxxx" name="number_contact" value="{{ student.phone }}" {% if student %}readonly{% endif %} class="border py-2 px-1">
                        </div>
                         <div class="flex-1 flex flex-col">
                            <label for="" class="text-sm flex">Email <p class="text-red-500">*</p></label>
                            <input type="text" placeholder="johnjoe@example.com" name="email_contact" value="{{ student.email }}" {% if student %}readonly{% endif %} class="border py-2 px-3" >
                        </div>
                        

                    </div>

                    <!-- <div class="flex mt-5  space-x-5 mx-15">
                        <div class="flex-1 flex flex-col">
                            <label for="" class="text-sm flex">Email <p class="text-red-500">*</p></label>
                            <input type="text" placeholder="johnjoe@example.com" name="email_contact" value="{{ student.email }}" {% if student %}readonly{% endif %} class="border py-2 px-3" >
                        </div>
                        
                        <div class="flex-1 flex flex-col max-w-[300px]">
                            <label for="" class="text-sm flex">Confirm Email <p class="text-red-500">*</p></label>
                            <input type="text" placeholder=""  name="confirm_email_contact" class="border py-2 px-1">
                        </div> 

                    </div> -->

                </div>
            </div>

       

            <div class="flex  w-full justify-center items-center mt-7 " >
                <div class="flex bg-white flex-col shadow-md/50 w-[1000px] px-10 py-5 ">
                    <div class="flex gap-4">
                        <input type="checkbox" required>
                        <label for="" class="text-xs text-gray-600">I confirm that I have read, understood, and agree to the updated Cebu <strong class="text-[#2975F7] hover:text-[#2975F7]/80 cursor-pointer">Privacy Policy</strong> PacificÂ . I consent to the collection, use, processing and sharing of my personal information in accordance therewith.</label>
                    </div>
                    
                    
                </div>
            </div>    
            
            <div class="flex  w-full justify-center items-center mt-2  " >
                <div class="flex flex-col w-[911px] py-5 items-end">
                    <div class="flex gap-4 ">
                        <button type="submit"
                         class="px-20 rounded-full py-2 bg-[#2975F7] hover:bg-[#2975F7]/80 cursor-pointer shadow-lg/50 text-white">Confirm</button>
                    </div>
                </div>
            </div> 
        </div>    
        </form>



    </main>
<!-- JS to switch passengers -->
<script>
document.addEventListener("DOMContentLoaded", function() {

    let validationTriggered = false;

    function showPassenger(passengerNumber) {
        // Hide all forms
        document.querySelectorAll(".passenger-form").forEach(form => {
            form.classList.add("invisible", "opacity-0");
            form.classList.remove("opacity-100");
        });

        // Show selected form
        const form = document.getElementById(`passenger-form-${passengerNumber}`);
        if (form) {
            form.classList.remove("invisible");
            form.classList.add("opacity-100");
        }

        // Reset all tabs
        document.querySelectorAll(".passenger-tab").forEach(tab => {
            tab.classList.remove("bg-white", "border-l-8", "border-[#2975F7]", "z-10", "bg-red-100", "text-red-600");
        });

        // Highlight active tab
        const activeTab = document.querySelector(`.passenger-tab[data-passenger="${passengerNumber}"]`);
        if (activeTab) {
            const passengerType = form.dataset.type;
            if (validationTriggered && isPassengerIncomplete(passengerNumber, passengerType)) {
                activeTab.classList.add("bg-red-100", "text-red-600");
            } else {
                activeTab.classList.add("bg-white", "border-l-8", "border-[#2975F7]", "z-10");
            }
        }

        if (validationTriggered) highlightIncompletePassengers();
        
        // Hide next passenger button for last passenger
        updateNextButtonVisibility();
    }

    function isValidDate(day, month, year) {
        // Check if all fields are filled
        if (!day || !month || !year) return false;
        
        // Convert to numbers
        day = parseInt(day);
        month = parseInt(month);
        year = parseInt(year);
        
        // Basic range validation
        if (year < 1900 || year > new Date().getFullYear()) return false;
        if (month < 1 || month > 12) return false;
        if (day < 1 || day > 31) return false;
        
        // Check valid days in month
        const daysInMonth = new Date(year, month, 0).getDate();
        return day <= daysInMonth;
    }

    function calculateAge(day, month, year) {
        const birthDate = new Date(year, month - 1, day);
        const today = new Date();
        
        let age = today.getFullYear() - birthDate.getFullYear();
        const monthDiff = today.getMonth() - birthDate.getMonth();
        
        if (monthDiff < 0 || (monthDiff === 0 && today.getDate() < birthDate.getDate())) {
            age--;
        }
        
        return age;
    }

    function calculateExactAge(day, month, year) {
        const birthDate = new Date(year, month - 1, day);
        const today = new Date();
        
        let years = today.getFullYear() - birthDate.getFullYear();
        let months = today.getMonth() - birthDate.getMonth();
        let days = today.getDate() - birthDate.getDate();
        
        if (days < 0) {
            months--;
            // Get days in previous month
            const prevMonth = new Date(today.getFullYear(), today.getMonth(), 0);
            days += prevMonth.getDate();
        }
        
        if (months < 0) {
            years--;
            months += 12;
        }
        
        return {
            years: years,
            months: months,
            days: days,
            totalMonths: (years * 12) + months
        };
    }

    function validatePassengerAge(passengerNumber, passengerType) {
        const day = document.querySelector(`[name="dob_day_${passengerNumber}"]`).value;
        const month = document.querySelector(`[name="dob_month_${passengerNumber}"]`).value;
        const year = document.querySelector(`[name="dob_year_${passengerNumber}"]`).value;
        
        if (!isValidDate(day, month, year)) {
            return { valid: false, error: "Please enter a valid date of birth" };
        }
        
        const exactAge = calculateExactAge(parseInt(day), parseInt(month), parseInt(year));
        const simpleAge = calculateAge(parseInt(day), parseInt(month), parseInt(year));
        
        // STRICT AGE VALIDATION
        switch(passengerType) {
            case "Adult":
                if (simpleAge < 18) {
                    if (simpleAge === 17 && exactAge.months >= 0) {
                        return { 
                            valid: false, 
                            error: `Adult must be 18 years or older. Passenger is ${simpleAge} years, ${exactAge.months} months old` 
                        };
                    }
                    return { 
                        valid: false, 
                        error: `Adult must be 18 years or older. Passenger is ${simpleAge} years old` 
                    };
                }
                break;
                
            case "Child":
                if (simpleAge < 2) {
                    if (simpleAge === 1 && exactAge.months >= 0) {
                        return { 
                            valid: false, 
                            error: `Child must be 2-11 years old. Passenger is ${simpleAge} year, ${exactAge.months} months old` 
                        };
                    }
                    return { 
                        valid: false, 
                        error: `Child must be 2-11 years old. Passenger is ${simpleAge} year${simpleAge !== 1 ? 's' : ''} old` 
                    };
                }
                if (simpleAge >= 12) {
                    return { 
                        valid: false, 
                        error: `Child must be 2-11 years old. Passenger is ${simpleAge} years old` 
                    };
                }
                break;
                
            case "Infant":
                if (exactAge.totalMonths >= 24) { // 24 months = 2 years
                    return { 
                        valid: false, 
                        error: `Infant must be under 2 years old. Passenger is ${exactAge.years} year${exactAge.years !== 1 ? 's' : ''}, ${exactAge.months} month${exactAge.months !== 1 ? 's' : ''} old` 
                    };
                }
                if (simpleAge >= 2) {
                    return { 
                        valid: false, 
                        error: `Infant must be under 2 years old. Passenger is ${simpleAge} years old` 
                    };
                }
                break;
        }
        
        return { valid: true, age: simpleAge, exactAge: exactAge };
    }

    function validateInfantAdultSelection(passengerNumber) {
        const adultSelect = document.querySelector(`[name="infant_adult_${passengerNumber}"]`);
        if (!adultSelect || !adultSelect.value) {
            return { valid: false, error: "Please select accompanying adult for infant" };
        }
        
        // Validate that the selected adult exists and is actually an adult
        const selectedAdult = parseInt(adultSelect.value);
        const adultForm = document.getElementById(`passenger-form-${selectedAdult}`);
        
        if (!adultForm) {
            return { valid: false, error: "Selected adult passenger not found" };
        }
        
        if (adultForm.dataset.type !== "Adult") {
            return { valid: false, error: "Infant must be accompanied by an Adult passenger" };
        }
        
        return { valid: true };
    }

    function validateNameFields(passengerNumber) {
        const firstName = document.querySelector(`[name="first_name_${passengerNumber}"]`);
        const lastName = document.querySelector(`[name="last_name_${passengerNumber}"]`);
        let valid = true;
        
        // Clear previous errors
        clearFieldError(firstName);
        clearFieldError(lastName);
        
        // Validate first name
        if (!firstName.value || firstName.value.trim() === "") {
            firstName.classList.add("border-red-500");
            showFieldError(firstName, "First name is required");
            valid = false;
        } else if (firstName.value.trim().length < 2) {
            firstName.classList.add("border-red-500");
            showFieldError(firstName, "First name must be at least 2 characters");
            valid = false;
        } else {
            firstName.classList.remove("border-red-500");
        }
        
        // Validate last name
        if (!lastName.value || lastName.value.trim() === "") {
            lastName.classList.add("border-red-500");
            showFieldError(lastName, "Last name is required");
            valid = false;
        } else if (lastName.value.trim().length < 2) {
            lastName.classList.add("border-red-500");
            showFieldError(lastName, "Last name must be at least 2 characters");
            valid = false;
        } else {
            lastName.classList.remove("border-red-500");
        }
        
        return valid;
    }

    function validateGender(passengerNumber) {
        const genderSelect = document.querySelector(`[name="gender_${passengerNumber}"]`);
        let valid = true;
        
        clearFieldError(genderSelect);
        
        if (!genderSelect.value) {
            genderSelect.classList.add("border-red-500");
            showFieldError(genderSelect, "Please select gender");
            valid = false;
        } else {
            genderSelect.classList.remove("border-red-500");
        }
        
        return valid;
    }

    function validatePassport(passengerNumber) {
        const passportField = document.querySelector(`[name="passport_${passengerNumber}"]`);
        let valid = true;
        
        clearFieldError(passportField);
        
        if (!passportField.value || passportField.value.trim() === "") {
            passportField.classList.add("border-red-500");
            showFieldError(passportField, "Passport number is required");
            valid = false;
        } else if (passportField.value.trim().length < 5) {
            passportField.classList.add("border-red-500");
            showFieldError(passportField, "Passport number must be at least 5 characters");
            valid = false;
        } else {
            passportField.classList.remove("border-red-500");
        }
        
        return valid;
    }

    function validateNationality(passengerNumber) {
        const nationalityField = document.querySelector(`[name="nationality_${passengerNumber}"]`);
        let valid = true;
        
        clearFieldError(nationalityField);
        
        if (!nationalityField.value || nationalityField.value.trim() === "") {
            nationalityField.classList.add("border-red-500");
            showFieldError(nationalityField, "Nationality is required");
            valid = false;
        } else if (nationalityField.value.trim().length < 3) {
            nationalityField.classList.add("border-red-500");
            showFieldError(nationalityField, "Please enter a valid nationality");
            valid = false;
        } else {
            nationalityField.classList.remove("border-red-500");
        }
        
        return valid;
    }

    function validateDateFields(passengerNumber, passengerType) {
        const dayField = document.querySelector(`[name="dob_day_${passengerNumber}"]`);
        const monthField = document.querySelector(`[name="dob_month_${passengerNumber}"]`);
        const yearField = document.querySelector(`[name="dob_year_${passengerNumber}"]`);
        let valid = true;
        
        // Clear previous errors
        clearFieldError(dayField);
        clearFieldError(monthField);
        clearFieldError(yearField);
        clearDateError(passengerNumber);
        
        // Check if any date field is empty
        if (!dayField.value || !monthField.value || !yearField.value) {
            [dayField, monthField, yearField].forEach(field => {
                if (!field.value) {
                    field.classList.add("border-red-500");
                    showFieldError(field, "This field is required");
                }
            });
            return false;
        }
        
        // Validate date format and logic
        const ageValidation = validatePassengerAge(passengerNumber, passengerType);
        if (!ageValidation.valid) {
            [dayField, monthField, yearField].forEach(field => {
                field.classList.add("border-red-500");
            });
            showDateError(passengerNumber, ageValidation.error);
            valid = false;
        } else {
            [dayField, monthField, yearField].forEach(field => {
                field.classList.remove("border-red-500");
            });
        }
        
        return valid;
    }

    function validatePassenger(passengerNumber, passengerType) {
        const form = document.getElementById(`passenger-form-${passengerNumber}`);
        let valid = true;
        
        // Clear previous error messages
        clearPassengerErrors(passengerNumber);

        // Validate all required fields
        if (!validateNameFields(passengerNumber)) valid = false;
        if (!validateGender(passengerNumber)) valid = false;
        if (!validateDateFields(passengerNumber, passengerType)) valid = false;
        if (!validatePassport(passengerNumber)) valid = false;
        if (!validateNationality(passengerNumber)) valid = false;

        // Special validation for infants
        if (passengerType === "Infant") {
            const infantValidation = validateInfantAdultSelection(passengerNumber);
            if (!infantValidation.valid) {
                const adultSelect = form.querySelector(`[name="infant_adult_${passengerNumber}"]`);
                adultSelect.classList.add("border-red-500");
                showFieldError(adultSelect, infantValidation.error);
                valid = false;
            }
        }

        return valid;
    }

    function showFieldError(field, message) {
        // Remove existing error
        const existingError = field.parentNode.querySelector(".field-error");
        if (existingError) existingError.remove();
        
        // Create error element
        const errorElement = document.createElement("div");
        errorElement.className = "field-error text-red-500 text-xs mt-1";
        errorElement.textContent = message;
        
        field.parentNode.appendChild(errorElement);
    }

    function clearFieldError(field) {
        if (field && field.parentNode) {
            const existingError = field.parentNode.querySelector(".field-error");
            if (existingError) existingError.remove();
        }
    }

    function showDateError(passengerNumber, message) {
        // Remove existing date error
        const form = document.getElementById(`passenger-form-${passengerNumber}`);
        const existingError = form.querySelector(".date-error");
        if (existingError) existingError.remove();
        
        // Find date section
        const dateSection = form.querySelector(".flex-col.mt-5");
        if (dateSection) {
            const errorElement = document.createElement("div");
            errorElement.className = "date-error text-red-500 text-xs mt-2 font-medium";
            errorElement.textContent = message;
            dateSection.appendChild(errorElement);
        }
    }

    function clearDateError(passengerNumber) {
        const form = document.getElementById(`passenger-form-${passengerNumber}`);
        const existingError = form.querySelector(".date-error");
        if (existingError) existingError.remove();
    }

    function clearPassengerErrors(passengerNumber) {
        const form = document.getElementById(`passenger-form-${passengerNumber}`);
        
        // Clear field errors
        form.querySelectorAll(".field-error").forEach(error => error.remove());
        
        // Clear date errors
        form.querySelectorAll(".date-error").forEach(error => error.remove());
        
        // Remove red borders
        form.querySelectorAll(".border-red-500").forEach(field => {
            field.classList.remove("border-red-500");
        });
    }

    function isPassengerIncomplete(passengerNumber, passengerType) {
        return !validatePassenger(passengerNumber, passengerType);
    }

    function highlightIncompletePassengers() {
        document.querySelectorAll(".passenger-tab").forEach(tab => {
            const passengerNumber = parseInt(tab.dataset.passenger);
            const passengerForm = document.getElementById(`passenger-form-${passengerNumber}`);
            const passengerType = passengerForm.dataset.type;
            const warning = tab.querySelector(".passenger-warning");

            if (isPassengerIncomplete(passengerNumber, passengerType)) {
                tab.classList.add("bg-red-100", "text-red-600");
                tab.classList.remove("bg-white", "border-l-8", "border-[#2975F7]");
                
                
            } else {
                tab.classList.remove("bg-red-100", "text-red-600");
                tab.classList.add("bg-white", "border-l-8", "border-[#2975F7]");
                warning.textContent = "";
                warning.classList.add("hidden");
            }
        });
    }

    // NEW: Check if all previous passengers are complete
    function arePreviousPassengersComplete(currentPassenger) {
        for (let i = 1; i < currentPassenger; i++) {
            const passengerForm = document.getElementById(`passenger-form-${i}`);
            const passengerType = passengerForm.dataset.type;
            if (isPassengerIncomplete(i, passengerType)) {
                return false;
            }
        }
        return true;
    }

    // NEW: Update sidebar clickability
    function updateSidebarClickability() {
        document.querySelectorAll(".passenger-tab").forEach(tab => {
            const passengerNumber = parseInt(tab.dataset.passenger);
            
            if (validationTriggered && passengerNumber > 1) {
                // Disable sidebar tabs if previous passengers are incomplete
                if (!arePreviousPassengersComplete(passengerNumber)) {
                    tab.style.pointerEvents = "none";
                    tab.style.opacity = "0.5";
                    tab.style.cursor = "not-allowed";
                } else {
                    tab.style.pointerEvents = "auto";
                    tab.style.opacity = "1";
                    tab.style.cursor = "pointer";
                }
            } else {
                // Always enable first passenger and when validation hasn't started
                tab.style.pointerEvents = "auto";
                tab.style.opacity = "1";
                tab.style.cursor = "pointer";
            }
        });
    }

    // NEW: Update next button visibility
    function updateNextButtonVisibility() {
        const totalPassengers = {{ passenger_list|length }};
        const currentPassenger = getCurrentPassengerNumber();
        
        // Hide next button for last passenger
        if (currentPassenger === totalPassengers) {
            document.querySelectorAll('.next-passenger').forEach(btn => {
                btn.style.display = 'none';
            });
        } else {
            document.querySelectorAll('.next-passenger').forEach(btn => {
                btn.style.display = 'flex';
            });
        }
    }

    // NEW: Get current passenger number
    function getCurrentPassengerNumber() {
        const visibleForm = document.querySelector('.passenger-form:not(.invisible)');
        if (visibleForm) {
            return parseInt(visibleForm.id.split('-')[2]);
        }
        return 1;
    }

    // Real-time validation for all fields
    function setupRealTimeValidation() {
        // Name fields
        document.querySelectorAll("input[name^='first_name_'], input[name^='last_name_']").forEach(input => {
            input.addEventListener("blur", function() {
                if (validationTriggered) {
                    const name = this.getAttribute("name");
                    const passengerNumber = name.split("_")[2];
                    const passengerForm = document.getElementById(`passenger-form-${passengerNumber}`);
                    const passengerType = passengerForm.dataset.type;
                    
                    validatePassenger(passengerNumber, passengerType);
                    highlightIncompletePassengers();
                    updateSidebarClickability();
                }
            });
        });

        // Gender fields
        document.querySelectorAll("select[name^='gender_']").forEach(select => {
            select.addEventListener("change", function() {
                if (validationTriggered) {
                    const name = this.getAttribute("name");
                    const passengerNumber = name.split("_")[1];
                    const passengerForm = document.getElementById(`passenger-form-${passengerNumber}`);
                    const passengerType = passengerForm.dataset.type;
                    
                    validatePassenger(passengerNumber, passengerType);
                    highlightIncompletePassengers();
                    updateSidebarClickability();
                }
            });
        });

        // Date fields
        document.querySelectorAll("select[name^='dob_']").forEach(select => {
            select.addEventListener("change", function() {
                if (validationTriggered) {
                    const name = this.getAttribute("name");
                    const passengerNumber = name.split("_")[2];
                    const passengerForm = document.getElementById(`passenger-form-${passengerNumber}`);
                    const passengerType = passengerForm.dataset.type;
                    
                    validatePassenger(passengerNumber, passengerType);
                    highlightIncompletePassengers();
                    updateSidebarClickability();
                }
            });
        });

        // Passport and nationality
        document.querySelectorAll("input[name^='passport_'], input[name^='nationality_']").forEach(input => {
            input.addEventListener("blur", function() {
                if (validationTriggered) {
                    const name = this.getAttribute("name");
                    const passengerNumber = name.split("_")[1];
                    const passengerForm = document.getElementById(`passenger-form-${passengerNumber}`);
                    const passengerType = passengerForm.dataset.type;
                    
                    validatePassenger(passengerNumber, passengerType);
                    highlightIncompletePassengers();
                    updateSidebarClickability();
                }
            });
        });

        // Infant adult selection
        document.querySelectorAll("select[name^='infant_adult_']").forEach(select => {
            select.addEventListener("change", function() {
                if (validationTriggered) {
                    const name = this.getAttribute("name");
                    const passengerNumber = name.split("_")[2];
                    
                    validatePassenger(passengerNumber, "Infant");
                    highlightIncompletePassengers();
                    updateSidebarClickability();
                }
            });
        });
    }

    // Next buttons - Only validate current passenger
    document.querySelectorAll(".next-passenger").forEach(btn => {
        btn.addEventListener("click", () => {
            const current = parseInt(btn.dataset.current);
            const currentForm = document.getElementById(`passenger-form-${current}`);
            const passengerType = currentForm.dataset.type;

            validationTriggered = true;

            // Only validate current passenger for next button
            if (validatePassenger(current, passengerType)) {
                showPassenger(current + 1);
                updateSidebarClickability();
            } else {
                showPassenger(current);
                // Scroll to first error
                const firstError = currentForm.querySelector(".border-red-500");
                if (firstError) {
                    firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                }
            }
        });
    });

    // Sidebar clicks - Check if previous passengers are complete
    document.querySelectorAll(".passenger-tab").forEach(tab => {
        tab.addEventListener("click", () => {
            const passenger = parseInt(tab.dataset.passenger);

            // Only allow clicking if validation hasn't started OR all previous passengers are complete
            if (!validationTriggered || arePreviousPassengersComplete(passenger)) {
                showPassenger(passenger);
            } else {
                // Find and show the first incomplete passenger
                for (let i = 1; i < passenger; i++) {
                    const passengerForm = document.getElementById(`passenger-form-${i}`);
                    const passengerType = passengerForm.dataset.type;
                    if (isPassengerIncomplete(i, passengerType)) {
                        showPassenger(i);
                        const firstError = passengerForm.querySelector(".border-red-500");
                        if (firstError) {
                            firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                        }
                        break;
                    }
                }
            }
        });
    });

    // Populate year dropdowns
    document.querySelectorAll("select[name^='dob_year_']").forEach(select => {
        const currentYear = new Date().getFullYear();
        for (let year = currentYear; year >= 1900; year--) {
            const option = document.createElement("option");
            option.value = year;
            option.textContent = year;
            select.appendChild(option);
        }
    });

    // Setup real-time validation
    setupRealTimeValidation();

    // Form submission - Validate ALL passengers
    const form = document.querySelector("form");
    form.addEventListener("submit", function(e) {
        validationTriggered = true;
        const totalPassengers = {{ passenger_list|length }};
        let allValid = true;

        for (let i = 1; i <= totalPassengers; i++) {
            const passengerForm = document.getElementById(`passenger-form-${i}`);
            const passengerType = passengerForm.dataset.type;

            if (!validatePassenger(i, passengerType)) {
                allValid = false;
                // Show the first invalid passenger
                if (allValid === false) {
                    showPassenger(i);
                    const firstError = passengerForm.querySelector(".border-red-500");
                    if (firstError) {
                        firstError.scrollIntoView({ behavior: 'smooth', block: 'center' });
                    }
                    break;
                }
            }
        }

        highlightIncompletePassengers();
        updateSidebarClickability();

        if (!allValid) {
            e.preventDefault();
        }
    });

    // Initialize first passenger
    showPassenger(1);
    updateSidebarClickability();
    updateNextButtonVisibility();
});
</script>




{% endblock %}