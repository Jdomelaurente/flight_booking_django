{% extends "master.html" %}

{% block content %}
<div class="mb-2 flex justify-between items-center">
  <!-- Left: Greeting -->
  <div>
    <h1 class="unbounded font-bold text-gray-900 text-xl mb-1">Dashboard</h1>
    <p class="poppins text-sm text-gray-500">Hi {{ username }} have a nice day!</p>
  </div>

  <!-- Right: Profile Button -->
  <div class="relative">
    <button onclick="toggleSubmenu('profileMenu')" 
      class="flex items-center bg-[#053322] px-4 py-1 rounded shadow hover:shadow-md transition poppins">
      <i class="ph ph-user-circle text-white text-2xl"></i>
      <span class="ml-3 text-white">{{ username }}</span>
      <i class="ph ph-caret-down ml-2 text-white"></i>
    </button>

    <!-- Profile Dropdown -->
    <div id="profileMenu" 
      class="absolute right-0 top-full mt-2 w-48 bg-white shadow-lg rounded-lg hidden z-10">
      <a href="{% url 'profile' %}" 
        class="block px-4 py-2  text-gray-700 hover:bg-gray-100 poppins">
        <i class="ph ph-user mr-2"></i> Profile
      </a>
      <a href="{% url 'logout' %}" 
        class="block px-4 py-2  text-gray-700 hover:bg-gray-100 poppins">
        <i class="ph ph-sign-out mr-2"></i> Logout
      </a>
    </div>
  </div>
</div>

<!-- Main Dashboard Layout -->
<div class="grid grid-cols-1 lg:grid-cols-3 gap-4 ">

  <!-- Left Column (span 2/3 on large screens) -->
  <div class="lg:col-span-2 flex flex-col gap-4">

    <!-- Top Stats -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
      <!-- Passenger Today -->
      <div class="bg-white rounded shadow-md p-6 flex justify-between items-center">
        <div class="flex flex-col justify-between h-full text-left">
          <p class="poppins text-gray-700 mb-2">Passenger Today</p>
          <p class="unbounded font-bold">{{ passenger_today }}</p>
        </div>
        <div class="bg-[#053322] rounded-full p-3 flex items-center justify-center">
          <i class="ph ph-users text-white text-md"></i>
        </div>
      </div>

      <!-- Total Revenue -->
      <div class="bg-white rounded shadow-md p-6 flex justify-between items-center">
        <div class="flex flex-col justify-between h-full text-left">
          <p class="poppins text-gray-700 mb-4">Total Revenue</p>
          <p class="unbounded font-bold">₱{{ total_revenue }}</p>
        </div>
        <div class="bg-[#053322] rounded-full p-3 flex items-center justify-center">
          <i class="ph ph-money text-white text-md"></i>
        </div>
      </div>

      <!-- Total Booking -->
      <div class="bg-white rounded shadow-md p-6 flex justify-between items-center">
        <div class="flex flex-col justify-between h-full text-left">
          <p class="poppins text-gray-700 mb-4">Total Booking</p>
          <p class="unbounded  font-bold">{{ total_bookings }}</p>
        </div>
        <div class="bg-[#053322] rounded-full p-3 flex items-center justify-center">
          <i class="ph ph-check-circle text-white text-md"></i>
        </div>
      </div>

      <!-- Active Flights -->
      <div class="bg-white rounded shadow-md p-6 flex justify-between items-center">
        <div class="flex flex-col justify-between h-full text-left">
          <p class="poppins text-gray-700 mb-4">Active Flights</p>
          <p class="unbounded   font-bold">{{ total_on_flight }}</p>
        </div>
        <div class="bg-[#053322] rounded-full p-3 flex items-center justify-center">
          <i class="ph ph-airplane text-white text-md"></i>
        </div>
      </div>
    </div>

    <!-- Charts Row (2 in a row) -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-1">
      <!-- Ticket Sales Chart -->
      <div class="bg-white shadow rounded p-6 flex flex-col">
        <div class="flex justify-between items-center mb-4">
          <h3 class="font-semibold unbounded">Ticket Sales</h3>
          <div class="relative inline-block text-left">
            <button id="filterDropdownBtn"
              class="flex items-center text-xs bg-gray-100 px-2 py-1 rounded">
              <i class="ph ph-calendar mr-2"></i> 
              <span id="filterLabel">This Week</span>
              <i class="ph ph-caret-down ml-1"></i>
            </button>
            <div id="filterDropdown"
              class="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg hidden z-50">
              <button data-range="week" class="block w-full px-2 py-1 text-xs text-left hover:bg-gray-100">This Week</button>
              <button data-range="month" class="block w-full px-2 py-1 text-xs text-left hover:bg-gray-100">This Month</button>
              <button data-range="year" class="block w-full px-2 py-1 text-xs text-left hover:bg-gray-100">This Year</button>
            </div>
          </div>
        </div>
        <p class="font-medium mb-4 poppins">Tickets Sold: {{ total_tickets_sold }}</p>
        <canvas id="ticketSalesChart" class="w-full h-56"></canvas>
      </div>

      <!-- Flight Schedule Chart -->
      <div class="bg-white shadow rounded p-6 flex flex-col relative">
        <div class="flex justify-between items-center mb-14">
          <h3 class="font-semibold unbounded">Flight Schedule</h3>
          <div class="relative">
            <button id="flightFilterDropdownBtn"
              class="flex items-center text-xs bg-gray-100 px-2 py-1 rounded">
              <i class="ph ph-calendar-dots mr-2"></i>
              <span id="flightFilterLabel">This Week</span>
              <i class="ph ph-caret-down ml-1"></i>
            </button>
            <div id="flightFilterDropdown"
              class="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg hidden z-50">
              <button data-range="week" class="block w-full px-2 py-1 text-xs text-left hover:bg-gray-100">This Week</button>
              <button data-range="month" class="block w-full px-2 py-1 text-xs text-left hover:bg-gray-100">This Month</button>
              <button data-range="year" class="block w-full px-2 py-1 text-xs text-left hover:bg-gray-100">This Year</button>
            </div>
          </div>
        </div>
        <canvas id="flightScheduleChart" class="w-full h-56"></canvas>
      </div>
    </div>

  </div>

  <!-- Right Column: Revenue Breakdown -->
  <div class="bg-white shadow rounded p-6 flex flex-col relative">
    <div class="flex justify-between items-center mb-4">
      <h3 class="font-semibold unbounded">Revenue</h3>
      <div class="relative">
        <button id="revenueFilterDropdownBtn"
          class="flex items-center text-xs bg-gray-100 px-2 py-1 rounded">
          <i class="ph ph-chart-pie mr-1"></i>
          <span id="revenueFilterLabel">By Airline</span>
          <i class="ph ph-caret-down ml-1"></i>
        </button>
        <div id="revenueFilterDropdown"
          class="absolute right-0 mt-2 w-32 bg-white border rounded shadow-lg hidden z-50">
          <button data-type="airline" class="block w-full px-2 py-1 text-xs text-left hover:bg-gray-100">By Airline</button>
          <button data-type="class" class="block w-full px-2 py-1 text-xs text-left hover:bg-gray-100">By Seat Class</button>
        </div>
      </div>
    </div>

    <!-- Container with slightly smaller width -->
    <div style="width:100%; width:350px; height:250px; margin:0 auto;">
      <canvas id="revenueBreakdownChart"></canvas>
    </div>
  </div>
</div> <!-- ✅ close main grid here -->

<!-- ✅ Recent Bookings Section -->
<div class="bg-white shadow rounded p-6 mt-6">
  <h3 class="font-semibold unbounded mb-4">Recent Bookings</h3>
  <div class="overflow-x-auto">
    <table class="table-auto border-collapse border border-gray-300 w-full poppins text-sm">
      <thead>
        <tr class="bg-gray-100">
          <th class="border border-gray-300 px-4 py-2">Booking ID</th>
          <th class="border border-gray-300 px-4 py-2">Passenger</th>
          <th class="border border-gray-300 px-4 py-2">Flight</th>
          <th class="border border-gray-300 px-4 py-2">Date</th>
          <th class="border border-gray-300 px-4 py-2">Status</th>
        </tr>
      </thead>
      <tbody>
        {% for booking in recent_bookings %}
        <tr class="hover:bg-gray-50">
          <td class="border border-gray-300 px-4 py-2">{{ booking.id }}</td>
          <td class="border border-gray-300 px-4 py-2">{{ booking.student.first_name }} {{ booking.student.last_name }}</td>
          <td class="border border-gray-300 px-4 py-2">
            {{ booking.schedule.flight.flight_number }}  
            ({{ booking.schedule.flight.origin_airport.code }} → {{ booking.schedule.flight.destination_airport.code }})
          </td>
          <td class="border border-gray-300 px-4 py-2">{{ booking.created_at|date:"M d, Y H:i" }}</td>
          <td class="border border-gray-300 px-4 py-2">
            <span class="px-2 py-1 rounded text-xs 
              {% if booking.status == 'Confirmed' %} bg-green-100 text-green-800 
              {% elif booking.status == 'Pending' %} bg-yellow-100 text-yellow-800 
              {% else %} bg-red-100 text-red-800 {% endif %}">
              {{ booking.status }}
            </span>
          </td>
        </tr>
        {% empty %}
        <tr>
          <td colspan="5" class="text-center py-4">No recent bookings found.</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
  </div>
</div>


<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  
  // ---------------- Ticket Sales Line Chart ----------------
  const ctx = document.getElementById("ticketSalesChart").getContext("2d");
  const ticketSalesChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: {{ ticket_sales_labels|safe }},
      datasets: [{
        label: "Tickets Sold",
        data: {{ ticket_sales_data|safe }},
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        borderColor: "#053322",
        backgroundColor: "rgba(5, 51, 34, 0.2)"
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: { stepSize: 1, callback: v => Number.isInteger(v) ? v : null }
        }
      }
    }
  });

  // ---------------- Flight Schedule Bar Chart ----------------
  const ctxFlights = document.getElementById('flightScheduleChart').getContext('2d');
  const flightScheduleChart = new Chart(ctxFlights, {
    type: 'bar',
    data: {
      labels: {{ flight_schedule_labels|safe }},
      datasets: [{ label: 'Flights Scheduled', data: {{ flight_schedule_data|safe }}, backgroundColor: '#053322' }]
    },
    options: { responsive: true, plugins: { legend: { display: false } }, scales: { y: { beginAtZero: true, ticks: { stepSize: 1, callback: v => Number.isInteger(v) ? v : null } } } }
  });

  // ---------------- Revenue Breakdown Pie Chart ----------------
const ctxRevenue = document.getElementById("revenueBreakdownChart").getContext("2d");
let revenueBreakdownChart = new Chart(ctxRevenue, {
  type: "pie",
  data: { 
    labels: {{ revenue_labels|safe }}, 
    datasets: [{ 
      data: {{ revenue_data|safe }}, 
      backgroundColor: ["#053322", "#1b5e20", "#2e7d32", "#66bb6a", "#a5d6a7"]
    }] 
  },
  options: { 
    responsive: true,  
    maintainAspectRatio: false, 
    plugins: { 
      legend: { position: "bottom" },
      tooltip: {
        callbacks: {
          label: function(context) {
            let value = context.raw; // get the numeric value
            return '₱' + value.toLocaleString(); // add peso sign and format
          }
        }
      }
    } 
  }
});


  // ---------------- Dropdown Filters ----------------
  const setupDropdown = (btnId, menuId, labelId, fetchUrl) => {
    const btn = document.getElementById(btnId);
    const menu = document.getElementById(menuId);
    const label = document.getElementById(labelId);
    btn.addEventListener("click", () => menu.classList.toggle("hidden"));
    menu.querySelectorAll("button").forEach(item => {
      item.addEventListener("click", () => {
        const param = item.dataset.range || item.dataset.type;
        label.textContent = item.textContent;
        menu.classList.add("hidden");
        fetch(`${fetchUrl}${param}`, { headers: { "X-Requested-With": "XMLHttpRequest" } })
        .then(res => res.json())
        .then(data => {
          if (btnId === "filterDropdownBtn") {
            ticketSalesChart.data.labels = data.labels; ticketSalesChart.data.datasets[0].data = data.data; ticketSalesChart.update();
          } else if (btnId === "flightFilterDropdownBtn") {
            flightScheduleChart.data.labels = data.labels; flightScheduleChart.data.datasets[0].data = data.data; flightScheduleChart.update();
          } else if (btnId === "revenueFilterDropdownBtn") {
            revenueBreakdownChart.data.labels = data.labels; revenueBreakdownChart.data.datasets[0].data = data.data; revenueBreakdownChart.update();
          }
        });
      });
    });
  };

  setupDropdown("filterDropdownBtn", "filterDropdown", "filterLabel", "{% url 'admin_dashboard' %}?range=");
  setupDropdown("flightFilterDropdownBtn", "flightFilterDropdown", "flightFilterLabel", "{% url 'admin_dashboard' %}?chart=flight&flight_range=");
  setupDropdown("revenueFilterDropdownBtn", "revenueFilterDropdown", "revenueFilterLabel", "{% url 'admin_dashboard' %}?chart=revenue&type=");

  function toggleSubmenu(menuId) {
    const menu = document.getElementById(menuId);
    menu.classList.toggle('hidden');
  }

</script>
{% endblock %}
