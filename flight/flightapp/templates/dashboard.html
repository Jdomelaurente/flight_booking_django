{% extends "master.html" %}

{% block content %}
<div class="mb-2">
  <h1 class="unbounded font-bold text-gray-900 text-2xl mb-1">Dashboard</h1>
  <p class="poppins text-sm text-gray-500">Hi {{ username }} have a nice day!</p>
</div>

<!-- Main Dashboard Layout -->
<div class="grid grid-cols-1 lg:grid-cols-1 gap-4 mb-4">

  <!-- Top Stats -->
  <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
    <!-- Passenger Today -->
    <div class="bg-white rounded shadow-md p-6 flex justify-between items-center">
      <div class="flex flex-col justify-between h-full text-left">
        <p class="poppins text-gray-700 mb-2">Passenger Today</p>
        <p class="unbounded text-gray-900 text-base font-bold">{{ passenger_today }}</p>
      </div>
      <div class="bg-[#053322] rounded-full p-3 flex items-center justify-center">
        <i class="ph ph-users text-white text-md"></i>
      </div>
    </div>

    <!-- Total Revenue -->
    <div class="bg-white rounded shadow-md p-6 flex justify-between items-center">
      <div class="flex flex-col justify-between h-full text-left">
        <p class="poppins text-gray-700 mb-4">Total Revenue</p>
        <p class="unbounded text-gray-900 text-base font-bold">â‚±{{ total_revenue }}</p>
      </div>
      <div class="bg-[#053322] rounded-full p-3 flex items-center justify-center">
        <i class="ph ph-money text-white text-md"></i>
      </div>
    </div>

    <!-- Total Booking -->
    <div class="bg-white rounded shadow-md p-6 flex justify-between items-center">
      <div class="flex flex-col justify-between h-full text-left">
        <p class="poppins text-gray-700 mb-4">Total Booking</p>
        <p class="unbounded text-gray-900 text-base font-bold">{{ total_bookings }}</p>
      </div>
      <div class="bg-[#053322] rounded-full p-3 flex items-center justify-center">
        <i class="ph ph-check-circle text-white text-md"></i>
      </div>
    </div>

    <!-- Active Flights -->
    <div class="bg-white rounded shadow-md p-6 flex justify-between items-center">
      <div class="flex flex-col justify-between h-full text-left">
        <p class="poppins text-gray-700 mb-4">Active Flights</p>
        <p class="unbounded text-gray-900 text-base font-bold">{{ total_on_flight }}</p>
      </div>
      <div class="bg-[#053322] rounded-full p-3 flex items-center justify-center">
        <i class="ph ph-airplane text-white text-md"></i>
      </div>
    </div>
  </div>

  <!-- Charts -->
  <div class="grid grid-cols-1 lg:grid-cols-2 gap-4 mt-4">
    <!-- Ticket Sales Chart -->
    <div class="bg-white shadow rounded p-6">
      <div class="flex justify-between items-center mb-4">
        <h3 class="text-lg font-semibold unbounded">Ticket Sales</h3>

    <div class="relative inline-block text-left">
      <button id="filterDropdownBtn"
        class="flex items-center text-sm bg-gray-100 px-3 py-1 rounded">
        <i class="ph ph-calendar mr-2"></i> 
        <span id="filterLabel">This Week</span>
        <i class="ph ph-caret-down ml-1"></i>
      </button>

      <!-- Dropdown Menu -->
      <div id="filterDropdown"
        class="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg hidden z-50">
        <button data-range="week"
          class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100">This Week</button>
        <button data-range="month"
          class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100">This Month</button>
        <button data-range="year"
          class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100">This Year</button>
      </div>
    </div>

      </div>
     <p class="font-medium mb-4 poppins">Tickets Sold: {{ total_tickets_sold }}</p>
      <canvas id="ticketSalesChart" class="w-full h-56"></canvas>
    </div>

<!-- Flight Schedule Chart -->
<div class="bg-white shadow rounded p-6 relative">
  <div class="flex justify-between items-center mb-4">
    <h3 class="text-lg font-semibold unbounded mb-9">Flight Schedule</h3>
    <!-- Dropdown Button -->
    <div class="relative">
      <button id="flightFilterDropdownBtn"
        class="flex items-center text-sm bg-gray-100 px-3 py-1 rounded">
        <i class="ph ph-calendar-dots mr-2"></i>
        <!-- Default = This Week -->
        <span id="flightFilterLabel">This Week</span>
        <i class="ph ph-caret-down ml-1"></i>
      </button>
      <!-- Dropdown Menu -->
      <div id="flightFilterDropdown"
        class="absolute right-0 mt-2 w-40 bg-white border rounded shadow-lg hidden z-50">
        <button data-range="week"
          class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100">This Week</button>
        <button data-range="month"
          class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100">This Month</button>
        <button data-range="year"
          class="block w-full px-4 py-2 text-sm text-left hover:bg-gray-100">This Year</button>
      </div>
    </div>
  </div>
  <canvas id="flightScheduleChart" class="w-full h-56"></canvas>
</div>

  </div>

</div>

<!-- Chart.js -->
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

<script>
  // ------------------------------
  // Ticket Sales Line Chart
  // ------------------------------
  const ctx = document.getElementById("ticketSalesChart").getContext("2d");
  const ticketSalesChart = new Chart(ctx, {
    type: "line",
    data: {
      labels: {{ ticket_sales_labels|safe }},
      datasets: [{
        label: "Tickets Sold",
        data: {{ ticket_sales_data|safe }},
        borderWidth: 2,
        fill: true,
        tension: 0.3,
        borderColor: "#053322",
        backgroundColor: "rgba(5, 51, 34, 0.2)"
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1, // Force whole numbers
            callback: function (value) {
              return Number.isInteger(value) ? value : null;
            }
          }
        }
      }
    }
  });

  // ------------------------------
  // Flight Schedule Bar Chart
  // ------------------------------
  const ctxFlights = document.getElementById('flightScheduleChart').getContext('2d');
  const flightScheduleChart = new Chart(ctxFlights, {
    type: 'bar',
    data: {
      labels: {{ flight_schedule_labels|safe }},
      datasets: [{
        label: 'Flights Scheduled',
        data: {{ flight_schedule_data|safe }},
        backgroundColor: '#053322'
      }]
    },
    options: {
      responsive: true,
      plugins: { legend: { display: false } },
      scales: {
        y: {
          beginAtZero: true,
          ticks: {
            stepSize: 1, // Force whole numbers
            callback: function (value) {
              return Number.isInteger(value) ? value : null;
            }
          }
        }
      }
    }
  });

  // ------------------------------
  // Dropdown Filter for Ticket Sales
  // ------------------------------
  const dropdownBtn = document.getElementById("filterDropdownBtn");
  const dropdownMenu = document.getElementById("filterDropdown");
  const filterLabel = document.getElementById("filterLabel");

  dropdownBtn.addEventListener("click", () => {
    dropdownMenu.classList.toggle("hidden");
  });

  dropdownMenu.querySelectorAll("button").forEach(item => {
    item.addEventListener("click", () => {
      const range = item.getAttribute("data-range");
      filterLabel.textContent = item.textContent;
      dropdownMenu.classList.add("hidden");

      fetch(`{% url 'admin_dashboard' %}?range=${range}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(response => response.json())
      .then(data => {
        ticketSalesChart.data.labels = data.labels;
        ticketSalesChart.data.datasets[0].data = data.data;
        ticketSalesChart.update();
      });
    });
  });

  // ------------------------------
  // Dropdown Filter for Flight Schedule
  // ------------------------------
  const flightDropdownBtn = document.getElementById("flightFilterDropdownBtn");
  const flightDropdownMenu = document.getElementById("flightFilterDropdown");
  const flightFilterLabel = document.getElementById("flightFilterLabel");

  flightDropdownBtn.addEventListener("click", () => {
    flightDropdownMenu.classList.toggle("hidden");
  });

  flightDropdownMenu.querySelectorAll("button").forEach(item => {
    item.addEventListener("click", () => {
      const range = item.getAttribute("data-range");
      flightFilterLabel.textContent = item.textContent;
      flightDropdownMenu.classList.add("hidden");

      fetch(`{% url 'admin_dashboard' %}?chart=flight&flight_range=${range}`, {
        headers: { "X-Requested-With": "XMLHttpRequest" }
      })
      .then(response => response.json())
      .then(data => {
        flightScheduleChart.data.labels = data.labels;
        flightScheduleChart.data.datasets[0].data = data.data;
        flightScheduleChart.update();
      });
    });
  });
</script>



{% endblock %}
