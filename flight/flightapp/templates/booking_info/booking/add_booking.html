{% extends "master.html" %}
{% block content %}
<div class="max-w-2xl mx-auto bg-white shadow-lg rounded-lg p-6">
    <h2 class="text-2xl font-bold mb-6">Add Booking</h2>
    <form method="post" class="space-y-4">
        {% csrf_token %}
        <input type="hidden" id="passenger_count" name="passenger_count" value="1">

        <!-- ðŸ”¹ Student -->
        <div>
            <label class="block font-semibold mb-1">Student:</label>
            <select name="student" class="w-full border border-gray-300 rounded px-3 py-2" required>
                {% for student in students %}
                <option value="{{ student.id }}">{{ student.first_name }} {{ student.last_name }}</option>
                {% endfor %}
            </select>
        </div>

        <!-- ðŸ”¹ Passengers -->
        <div id="passengers_container">
            <div class="passenger border p-3 rounded bg-gray-50 mb-2" id="passenger_1">
                <h3 class="font-semibold mb-2">Passenger 1</h3>

                <label>First Name:</label>
                <input type="text" name="passenger_first_name_1" class="w-full border rounded px-3 py-2" required>

                <label>Middle Name:</label>
                <input type="text" name="passenger_middle_name_1" class="w-full border rounded px-3 py-2">

                <label>Last Name:</label>
                <input type="text" name="passenger_last_name_1" class="w-full border rounded px-3 py-2" required>

                <label>Gender:</label>
                <select name="passenger_gender_1" class="w-full border rounded px-3 py-2">
                    <option value="N/A" selected>-- Select Gender --</option>
                    <option value="Male">Male</option>
                    <option value="Female">Female</option>
                </select>

                <label>Date of Birth:</label>
                <input type="date" name="passenger_dob_1" class="w-full border rounded px-3 py-2" required>

                <label>Passenger Type:</label>
                <select name="passenger_type_1" class="passenger_type w-full border rounded px-3 py-2" data-index="1">
                    <option value="adult" selected>Adult</option>
                    <option value="child">Child</option>
                    <option value="infant">Infant (on lap)</option>
                </select>

                <!-- Infant Assign to Adult -->
                <div class="infant_assign hidden mt-2" id="infant_assign_1">
                    <label>Assign to Adult:</label>
                    <select name="linked_adult_1" class="w-full border rounded px-3 py-2">
                        <option value="">-- Select Adult --</option>
                    </select>
                </div>
            </div>
        </div>

        <button type="button" id="add_passenger_btn" class="bg-blue-600 hover:bg-blue-700 text-white px-3 py-1 rounded mb-4">
            + Add Passenger
        </button>

        <!-- ðŸ”¹ Trip Type -->
        <div>
            <label class="block font-semibold mb-1">Trip Type:</label>
            <select id="trip_type" name="trip_type" class="w-full border border-gray-300 rounded px-3 py-2">
                <option value="one_way" selected>One-Way</option>
                <option value="round_trip">Round-Trip</option>
                <option value="multi_city">Multi-City</option>
            </select>
        </div>

        <!-- ðŸ”¹ Outbound Schedule -->
        <div id="outbound_section">
            <label class="block font-semibold mb-1">Outbound Schedule:</label>
            <select id="outbound_schedule" name="outbound_schedule" class="w-full border border-gray-300 rounded px-3 py-2">
                <option value="">-- Select Outbound Schedule --</option>
                {% for schedule in schedules %}
                <option value="{{ schedule.id }}">
                    {{ schedule.flight.flight_number }} ({{ schedule.flight.route.origin_airport.code }} â†’ {{ schedule.flight.route.destination_airport.code }}) - {{ schedule.departure_time|date:"Y-m-d H:i" }}
                </option>
                {% endfor %}
            </select>
        </div>

        <!-- ðŸ”¹ Outbound Seats per passenger -->
        <div id="passenger_seats_container" class="space-y-2"></div>

        <!-- ðŸ”¹ Return Section -->
        <div id="return_section" class="hidden">
            <label class="block font-semibold mb-1">Return Schedule:</label>
            <select id="return_schedule" name="return_schedule" class="w-full border border-gray-300 rounded px-3 py-2">
                <option value="">-- Select Return Schedule --</option>
            </select>
        </div>

        <!-- ðŸ”¹ Return Seats per passenger -->
        <div id="return_seats_container" class="space-y-2 hidden"></div>

        <!-- ðŸ”¹ Multi-City Section -->
        <div id="multi_city_section" class="hidden">
            <h3 class="font-semibold mb-2">Multi-City Legs</h3>
            <div id="multi_city_legs"></div>
            <button type="button" id="add_leg_btn" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded mb-2">
                + Add Leg
            </button>
        </div>

        <!-- ðŸ”¹ Buttons -->
        <div class="flex items-center justify-between mt-6">
            <button type="submit" class="bg-green-600 hover:bg-green-700 text-white py-2 px-4 rounded">Add Booking</button>
            <a href="{% url 'booking' %}" class="bg-red-600 hover:bg-red-700 text-white py-2 px-4 rounded">Cancel</a>
        </div>
    </form>
</div>

<script>
let passengerCount = 1;
let legCount = 0;

const passengersContainer = document.getElementById("passengers_container");
const addPassengerBtn = document.getElementById("add_passenger_btn");
const tripType = document.getElementById("trip_type");
const outboundSchedule = document.getElementById("outbound_schedule");
const returnSchedule = document.getElementById("return_schedule");
const passengerSeatsContainer = document.getElementById("passenger_seats_container");
const returnSeatsContainer = document.getElementById("return_seats_container");
const passengerCountInput = document.getElementById("passenger_count");
const multiCitySection = document.getElementById("multi_city_section");
const multiCityLegs = document.getElementById("multi_city_legs");
const addLegBtn = document.getElementById("add_leg_btn");

// ðŸ”¹ Add Passenger
addPassengerBtn.addEventListener("click", function() {
    passengerCount++;
    passengerCountInput.value = passengerCount;

    const newPassenger = document.createElement("div");
    newPassenger.classList.add("passenger", "border", "p-3", "rounded", "bg-gray-50", "mb-2");
    newPassenger.id = `passenger_${passengerCount}`;
    newPassenger.innerHTML = `
        <h3 class="font-semibold mb-2">Passenger ${passengerCount}</h3>
        <label>First Name:</label>
        <input type="text" name="passenger_first_name_${passengerCount}" class="w-full border rounded px-3 py-2" required>
        <label>Middle Name:</label>
        <input type="text" name="passenger_middle_name_${passengerCount}" class="w-full border rounded px-3 py-2">
        <label>Last Name:</label>
        <input type="text" name="passenger_last_name_${passengerCount}" class="w-full border rounded px-3 py-2" required>
        <label>Gender:</label>
        <select name="passenger_gender_${passengerCount}" class="w-full border rounded px-3 py-2">
            <option value="N/A" selected>-- Select Gender --</option>
            <option value="Male">Male</option>
            <option value="Female">Female</option>
        </select>
        <label>Date of Birth:</label>
        <input type="date" name="passenger_dob_${passengerCount}" class="w-full border rounded px-3 py-2" required>
        <label>Passenger Type:</label>
        <select name="passenger_type_${passengerCount}" class="passenger_type w-full border rounded px-3 py-2" data-index="${passengerCount}">
            <option value="adult" selected>Adult</option>
            <option value="child">Child</option>
            <option value="infant">Infant (on lap)</option>
        </select>
        <div class="infant_assign hidden mt-2" id="infant_assign_${passengerCount}">
            <label>Assign to Adult:</label>
            <select name="linked_adult_${passengerCount}" class="w-full border rounded px-3 py-2">
                <option value="">-- Select Adult --</option>
            </select>
        </div>
    `;
    passengersContainer.appendChild(newPassenger);
    createSeatDropdowns(passengerCount);
});

// ðŸ”¹ Create seat dropdowns per passenger
function createSeatDropdowns(pIndex) {
    // Outbound
    const outboundDiv = document.createElement("div");
    outboundDiv.classList.add("border", "p-2", "mb-1", "rounded", "bg-gray-100");
    outboundDiv.id = `outbound_seat_div_${pIndex}`;
    outboundDiv.innerHTML = `
        <label>Passenger ${pIndex} Outbound Seat:</label>
        <select name="outbound_seat_${pIndex}" class="w-full border rounded px-3 py-2"><option value="">-- Select Seat --</option></select>
    `;
    passengerSeatsContainer.appendChild(outboundDiv);

    // Return
    const returnDiv = document.createElement("div");
    returnDiv.classList.add("border", "p-2", "mb-1", "rounded", "bg-gray-100");
    returnDiv.id = `return_seat_div_${pIndex}`;
    returnDiv.innerHTML = `
        <label>Passenger ${pIndex} Return Seat:</label>
        <select name="return_seat_${pIndex}" class="w-full border rounded px-3 py-2"><option value="">-- Select Seat --</option></select>
    `;
    returnSeatsContainer.appendChild(returnDiv);
}

// ðŸ”¹ Initially create seats for first passenger
createSeatDropdowns(1);

// ðŸ”¹ Handle Passenger Type Change (Adult / Child / Infant)
document.addEventListener("change", function(e) {
    if(e.target.classList.contains("passenger_type")) {
        const pIndex = e.target.dataset.index;
        const type = e.target.value;

        const seatDivOutbound = document.getElementById(`outbound_seat_div_${pIndex}`);
        const seatDivReturn = document.getElementById(`return_seat_div_${pIndex}`);
        const infantAssign = document.getElementById(`infant_assign_${pIndex}`);

        if(type === "infant") {
            seatDivOutbound.classList.add("hidden");
            seatDivReturn.classList.add("hidden");
            infantAssign.classList.remove("hidden");

            // Populate assign-to-adult dropdown
            const dropdown = infantAssign.querySelector("select");
            dropdown.innerHTML = '<option value="">-- Select Adult --</option>';
            for(let i=1;i<=passengerCount;i++){
                const pt = document.querySelector(`select[name="passenger_type_${i}"]`);
                if(pt && pt.value === "adult") {
                    dropdown.innerHTML += `<option value="${i}">Passenger ${i}</option>`;
                }
            }
        } else {
            seatDivOutbound.classList.remove("hidden");
            seatDivReturn.classList.remove("hidden");
            infantAssign.classList.add("hidden");
        }
    }
});

// ðŸ”¹ Show/hide sections based on trip type
tripType.addEventListener("change", function() {
    if(this.value === "one_way") {
        document.getElementById("outbound_section").classList.remove("hidden");
        passengerSeatsContainer.classList.remove("hidden");
        document.getElementById("return_section").classList.add("hidden");
        returnSeatsContainer.classList.add("hidden");
        multiCitySection.classList.add("hidden");
    } else if(this.value === "round_trip") {
        document.getElementById("outbound_section").classList.remove("hidden");
        passengerSeatsContainer.classList.remove("hidden");
        document.getElementById("return_section").classList.remove("hidden");
        returnSeatsContainer.classList.remove("hidden");
        multiCitySection.classList.add("hidden");
    } else {
        document.getElementById("outbound_section").classList.add("hidden");
        passengerSeatsContainer.classList.add("hidden");
        document.getElementById("return_section").classList.add("hidden");
        returnSeatsContainer.classList.add("hidden");
        multiCitySection.classList.remove("hidden");
    }
});

// ðŸ”¹ Multi-City: Add Leg
addLegBtn.addEventListener("click", function(){
    legCount++;
    const legDiv = document.createElement("div");
    legDiv.classList.add("border", "p-3", "mb-2", "rounded", "bg-gray-50");
    legDiv.id = `multi_leg_${legCount}`;
    legDiv.innerHTML = `
        <h4 class="font-semibold mb-2">Leg ${legCount}</h4>
        <label>Schedule:</label>
        <select name="multi_schedule_${legCount}" id="multi_schedule_${legCount}" class="w-full border rounded px-3 py-2">
            <option value="">-- Select Schedule --</option>
            {% for schedule in schedules %}
            <option value="{{ schedule.id }}">
                {{ schedule.flight.flight_number }} ({{ schedule.flight.route.origin_airport.code }} â†’ {{ schedule.flight.route.destination_airport.code }}) - {{ schedule.departure_time|date:"Y-m-d H:i" }}
            </option>
            {% endfor %}
        </select>
        <div id="multi_seats_container_${legCount}" class="space-y-2 mt-2"></div>
    `;
    multiCityLegs.appendChild(legDiv);

    // Create seat dropdowns per passenger for this leg
    for(let i=1;i<=passengerCount;i++){
        const seatDiv = document.createElement("div");
        seatDiv.classList.add("border", "p-2", "mb-1", "rounded", "bg-gray-100");
        seatDiv.innerHTML = `
            <label>Passenger ${i} Seat:</label>
            <select name="multi_seat_${legCount}_${i}" class="w-full border rounded px-3 py-2"><option value="">-- Select Seat --</option></select>
        `;
        document.getElementById(`multi_seats_container_${legCount}`).appendChild(seatDiv);
    }

    // ðŸ”¹ Fetch seats dynamically when schedule is selected
    const scheduleDropdown = document.getElementById(`multi_schedule_${legCount}`);
    scheduleDropdown.addEventListener("change", function(){
        for(let i=1;i<=passengerCount;i++){
            const seatDropdown = document.querySelector(`select[name="multi_seat_${legCount}_${i}"]`);
            fetchSeats(this.value, seatDropdown);
        }
    });
});

// ðŸ”¹ Fetch seats dynamically
function fetchSeats(scheduleId, seatDropdown) {
    seatDropdown.innerHTML = '<option value="">-- Select Seat --</option>';
    if(!scheduleId) return;

    fetch(`/booking/seats/${scheduleId}/`)
        .then(res => res.json())
        .then(data => {
            data.forEach(seat => {
                const option = document.createElement("option");
                option.value = seat.id;
                option.textContent = seat.label;
                if(!seat.is_available){
                    option.disabled = true;
                    option.classList.add("text-gray-400");
                }
                seatDropdown.appendChild(option);
            });
        });
}

// ðŸ”¹ Update outbound seats
outboundSchedule.addEventListener("change", function() {
    for(let i=1;i<=passengerCount;i++){
        const sel = document.querySelector(`select[name="outbound_seat_${i}"]`);
        fetchSeats(this.value, sel);
    }

    // Fetch return schedules dynamically
    if(tripType.value === "round_trip"){
        fetch(`/booking/return_schedules/${this.value}/`)
            .then(res => res.json())
            .then(data => {
                returnSchedule.innerHTML = '<option value="">-- Select Return Schedule --</option>';
                data.forEach(s => {
                    const opt = document.createElement("option");
                    opt.value = s.id;
                    opt.textContent = `${s.flight_number} (${s.origin} â†’ ${s.destination}) - ${s.departure_time}`;
                    returnSchedule.appendChild(opt);
                });
            });
    }
});

// ðŸ”¹ Update return seats
returnSchedule.addEventListener("change", function(){
    for(let i=1;i<=passengerCount;i++){
        const sel = document.querySelector(`select[name="return_seat_${i}"]`);
        fetchSeats(this.value, sel);
    }
});
</script>
{% endblock %}
